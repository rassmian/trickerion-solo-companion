<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trickerion Solo Companion</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0d0b0e;
      --bg-card: #1a1520;
      --bg-card-hover: #241e2b;
      --border: #3d3347;
      --amber: #d4a847;
      --amber-glow: #e8c05a;
      --amber-dark: #a67c28;
      --text-primary: #e8e4ec;
      --text-secondary: #9a8fa3;
      --text-muted: #6b5f75;
      --success: #4a9e6b;
      --warning: #c97f3a;
      --mechanical: #c96a30;
      --optical: #2a9d8f;
      --escape: #5a5a5a;
      --spiritual: #2d6a4f;
      --prophecy: #b87ac9;
      --physical-action: #5b9a9a;
      --physical-action-bg: rgba(91, 154, 154, 0.15);
      --exception: #a89a6b;
      --exception-bg: rgba(168, 154, 107, 0.12);
      --info: #7a8a9e;
      --info-bg: rgba(122, 138, 158, 0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Crimson Text', Georgia, serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      background-image: 
        radial-gradient(ellipse at 20% 20%, rgba(212, 168, 71, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(184, 122, 201, 0.02) 0%, transparent 50%);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      overflow-x: hidden;
    }

    /* Header */
    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 30px;
      position: relative;
    }

    h1 {
      font-family: 'Cinzel', serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--amber);
      text-shadow: 0 0 30px rgba(212, 168, 71, 0.3);
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Screens */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Setup Screen */
    .setup-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 25px;
    }

    .setup-section h2 {
      font-family: 'Cinzel', serif;
      font-size: 1.3rem;
      color: var(--amber);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .setup-section h2 .step-number {
      background: var(--amber-dark);
      color: var(--bg-dark);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 700;
    }

    /* Setup Wizard */
    .setup-wizard {
      max-width: 700px;
      margin: 0 auto;
    }
    
    .setup-page {
      animation: fadeIn 0.3s ease;
    }
    
    .setup-page.hidden {
      display: none;
    }
    
    .hidden {
      display: none !important;
    }
    
    .setup-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    .setup-nav .btn {
      min-width: 120px;
    }
    
    .setup-progress {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .setup-progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      transition: background 0.3s ease;
    }
    
    .setup-progress-dot.active {
      background: var(--amber);
    }
    
    .setup-progress-dot.completed {
      background: var(--success);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0;
    }

    .section-header h2 {
      margin-bottom: 0;
    }

    .btn-randomize {
      font-family: 'Crimson Text', Georgia, serif;
      font-size: 0.9rem;
      background: transparent;
      border: 1px solid var(--amber-dark);
      color: var(--amber);
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-randomize:hover:not(:disabled) {
      background: rgba(212, 168, 71, 0.15);
      border-color: var(--amber);
    }

    .btn-randomize:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .option-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }

    .option-card {
      background: var(--bg-dark);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .option-card:hover {
      border-color: var(--amber-dark);
      background: var(--bg-card-hover);
    }

    .option-card.selected {
      border-color: var(--amber);
      background: rgba(212, 168, 71, 0.1);
      box-shadow: 0 0 20px rgba(212, 168, 71, 0.15);
    }

    .option-card .title {
      font-family: 'Cinzel', serif;
      font-size: 1.1rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .option-card .description {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .option-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      position: relative;
    }

    .option-card.disabled:hover {
      border-color: var(--border);
      background: var(--bg-dark);
    }

    .option-card .coming-soon {
      display: inline-block;
      background: var(--amber-dark);
      color: var(--bg-dark);
      font-size: 0.7rem;
      font-family: 'Cinzel', serif;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    /* Magician cards with school colors */
    .option-card[data-school="mechanical"] .title { color: var(--mechanical); }
    .option-card[data-school="optical"] .title { color: var(--optical); }
    .option-card[data-school="escape"] .title { color: var(--escape); }
    .option-card[data-school="spiritual"] .title { color: var(--spiritual); }

    .option-card.selected[data-school="mechanical"] { border-color: var(--mechanical); background: rgba(201, 106, 48, 0.1); }
    .option-card.selected[data-school="optical"] { border-color: var(--optical); background: rgba(42, 157, 143, 0.1); }
    .option-card.selected[data-school="escape"] { border-color: var(--escape); background: rgba(90, 90, 90, 0.1); }
    .option-card.selected[data-school="spiritual"] { border-color: var(--spiritual); background: rgba(45, 106, 79, 0.1); }

    /* School icons */
    .school-icon {
      width: auto;
      height: 48px;
      margin: 0 auto 12px auto;
      opacity: 0.85;
    }

    .option-card:hover .school-icon,
    .option-card.selected .school-icon {
      opacity: 1;
    }

    .option-card[data-school="mechanical"] .school-icon { color: var(--mechanical); }
    .option-card[data-school="optical"] .school-icon { color: var(--optical); }
    .option-card[data-school="escape"] .school-icon { color: var(--escape); }
    .option-card[data-school="spiritual"] .school-icon { color: var(--spiritual); }

    /* Setup info box */
    .setup-info {
      background: rgba(212, 168, 71, 0.1);
      border: 1px solid var(--amber-dark);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .setup-info h3 {
      font-family: 'Cinzel', serif;
      color: var(--amber);
      margin-bottom: 12px;
      font-size: 1rem;
    }

    .setup-info ul {
      list-style: none;
      font-size: 0.95rem;
      line-height: 1.8;
      color: var(--text-secondary);
    }

    .setup-info ul li::before {
      content: "‚óÜ ";
      color: var(--amber-dark);
    }

    /* Buttons */
    .btn {
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      padding: 14px 35px;
      border: 2px solid var(--amber);
      background: transparent;
      color: var(--amber);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      letter-spacing: 0.05em;
    }

    .btn:hover {
      background: var(--amber);
      color: var(--bg-dark);
      box-shadow: 0 0 25px rgba(212, 168, 71, 0.3);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn:disabled:hover {
      background: transparent;
      color: var(--amber);
      box-shadow: none;
    }

    .btn-selected {
      background: var(--amber) !important;
      color: #1a1a1a !important;
      border-color: var(--amber) !important;
    }

    .slot-selected {
      background: rgba(212, 168, 71, 0.15) !important;
      border-color: var(--amber) !important;
      color: var(--amber) !important;
      box-shadow: 0 0 10px rgba(212, 168, 71, 0.3);
    }

    .btn-container {
      text-align: center;
      margin-top: 30px;
    }

    /* Game Screen Layout */
    .game-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 25px;
    }

    .game-layout > * {
      min-width: 0;
    }

    @media (max-width: 900px) {
      .game-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      .action-panel {
        padding: 15px;
      }
      /* Force inline grids to stack on mobile */
      .action-content [style*="grid-template-columns: 1fr 1fr"],
      .action-content [style*="grid-template-columns: 1fr 1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
      /* Reduce spacing in turn summary box */
      .turn-summary-box {
        padding: 12px !important;
        margin-bottom: 12px !important;
      }
      .turn-summary-box > div {
        gap: 8px !important;
      }
    }

    /* Sidebar - Heir State */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .state-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 18px;
    }

    .state-card h3 {
      font-family: 'Cinzel', serif;
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
    }

    .state-value {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--amber);
    }

    .state-value.fame { color: var(--amber); }
    .state-value.coins { color: #c9c9c9; }
    .state-value.shards { color: var(--prophecy); }

    .state-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .state-row:last-child {
      border-bottom: none;
    }

    .state-label {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .state-count {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Stance indicator */
    .stance-indicator {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-family: 'Cinzel', serif;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .stance-indicator.ready {
      background: rgba(74, 158, 107, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .stance-indicator.busy {
      background: rgba(201, 127, 58, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .stance-indicator.pending {
      background: rgba(136, 136, 136, 0.2);
      color: var(--text-muted);
      border: 1px solid var(--border);
      font-style: italic;
    }

    /* Main content */
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 100%;
      min-width: 0;
      overflow-x: hidden;
    }

    /* Phase tracker */
    .phase-tracker {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }

    .round-indicator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .round-badge {
      font-family: 'Cinzel', serif;
      font-size: 1.3rem;
      color: var(--amber);
    }

    .turn-progress {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .phase-steps {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .phase-step {
      padding: 8px 14px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .phase-step.active {
      border-color: var(--amber);
      color: var(--amber);
      background: rgba(212, 168, 71, 0.1);
    }

    .phase-step.completed {
      border-color: var(--success);
      color: var(--success);
      background: rgba(74, 158, 107, 0.1);
    }

    /* Action panel */
    .action-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 25px;
      min-height: 300px;
      min-width: 0;
      overflow-x: hidden;
      max-width: 100%;
    }

    .action-panel h2 {
      font-family: 'Cinzel', serif;
      font-size: 1.2rem;
      color: var(--amber);
      margin-bottom: 20px;
    }

    .action-content {
      color: var(--text-secondary);
      line-height: 1.7;
      font-size: 1.05rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .action-content * {
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .action-content p {
      margin-bottom: 15px;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    /* Heir's tricks display */
    .tricks-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .trick-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-dark);
      border-radius: 6px;
      border-left: 3px solid var(--border);
    }

    .trick-item[data-school="mechanical"] { border-left-color: var(--mechanical); }
    .trick-item[data-school="optical"] { border-left-color: var(--optical); }
    .trick-item[data-school="escape"] { border-left-color: var(--escape); }
    .trick-item[data-school="spiritual"] { border-left-color: var(--spiritual); }

    .trick-name {
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .trick-markers {
      display: flex;
      gap: 4px;
    }

    .trick-marker {
      width: 12px;
      height: 12px;
      background: var(--amber);
      border-radius: 2px;
    }

    /* Characters display */
    .characters-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .character-slot {
      text-align: center;
      padding: 10px 8px;
      background: var(--bg-dark);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .character-slot.filled {
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .character-slot.pending {
      color: var(--text-secondary);
      opacity: 0.5;
      border: 1px dashed var(--border);
    }

    .character-slot.pending .char-label {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .character-slot .char-icon {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }

    /* Shopping list */
    .shopping-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .component-tag {
      padding: 4px 10px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* Plan card display */
    .plan-card-display {
      background: var(--bg-dark);
      border: 2px solid var(--amber-dark);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .plan-card-display .card-type {
      font-family: 'Cinzel', serif;
      font-size: 0.85rem;
      color: var(--amber);
      margin-bottom: 8px;
    }

    .plan-card-display .card-locations {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* Heir's turn progress */
    .heir-turn-progress {
      margin-top: 15px;
    }

    .character-placement-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .placement-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: var(--bg-dark);
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .placement-item .status-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    .placement-item.completed .status-icon {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .placement-item.current .status-icon {
      border-color: var(--amber);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(212, 168, 71, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(212, 168, 71, 0); }
    }

    .placement-item .character-name {
      color: var(--text-primary);
    }

    .placement-item .location-name {
      color: var(--text-muted);
      margin-left: auto;
    }

    /* Magician ability reminder */
    .ability-reminder {
      background: rgba(184, 122, 201, 0.1);
      border: 1px solid var(--prophecy);
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
    }

    .ability-reminder .ability-title {
      font-family: 'Cinzel', serif;
      font-size: 0.85rem;
      color: var(--prophecy);
      margin-bottom: 6px;
    }

    .ability-reminder .ability-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Special assignment cards */
    .assignment-cards {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .assignment-badge {
      padding: 4px 8px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .assignment-badge .count {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Empty state */
    .empty-state {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
    }

    /* Header with restart button */
    header {
      position: relative;
    }

    .restart-btn {
      position: absolute;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      font-family: 'Crimson Text', Georgia, serif;
      font-size: 0.9rem;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .restart-btn:hover {
      border-color: var(--amber-dark);
      color: var(--amber);
    }

    .restart-btn.hidden {
      display: none;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    @media (max-width: 600px) {
      .modal-content {
        max-width: 95vw;
        max-height: 85vh;
        border-radius: 8px;
      }
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--amber);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 8px;
      min-width: 44px;
      min-height: 44px;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Prophecy selection grid */
    .prophecy-section {
      margin-bottom: 10px;
    }

    .prophecy-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    .prophecy-section-note {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .prophecy-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge-affect-both {
      background: rgba(212, 168, 71, 0.25);
      color: var(--amber);
      border: 1px solid var(--amber);
    }

    .badge-player-only {
      background: rgba(120, 120, 120, 0.2);
      color: var(--text-muted);
      border: 1px solid var(--text-muted);
    }

    .prophecy-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      padding: 10px;
    }

    @media (max-width: 600px) {
      .prophecy-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 5px;
      }
    }

    .prophecy-item {
      position: relative;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 4px;
      transition: all 0.2s ease;
      background: var(--bg-card);
    }

    .prophecy-item:hover {
      border-color: var(--amber);
      transform: scale(1.05);
    }

    .prophecy-item img {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }

    .prophecy-item.heir-ignores {
      opacity: 0.85;
    }

    .prophecy-tooltip {
      position: fixed;
      background: var(--bg-dark);
      border: 1px solid var(--amber);
      padding: 10px 14px;
      border-radius: 6px;
      max-width: 250px;
      z-index: 1100;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .prophecy-tooltip h4 {
      margin: 0 0 6px 0;
      color: var(--amber);
      font-size: 0.9rem;
    }

    .prophecy-tooltip p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Trickerion</h1>
      <p class="subtitle">Solo Companion ‚Äî Dahlgaard's Heir</p>
      <p style="color: var(--text-muted); font-size: 0.7rem; margin-top: 5px;">v0.11.0-beta</p>
      <button class="restart-btn hidden" id="restart-btn">‚Ü∫ New Game</button>
    </header>


    <!-- Setup Screen -->
    <div id="setup-screen" class="screen active">
      <div class="setup-wizard">
        
        <!-- PAGE 0: Setup Mode Selection -->
        <div class="setup-page" id="setup-page-0">
          <div class="setup-section" style="text-align: center;">
            <h2 style="color: var(--amber); margin-bottom: 10px;">Welcome to Trickerion Solo</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Choose your setup experience:</p>
            
            <div class="option-grid" style="max-width: 500px; margin: 0 auto;">
              <div class="option-card" onclick="startFullSetup()" style="cursor: pointer;">
                <div class="title">üìã Full Setup</div>
                <div class="description">Step-by-step guided setup with complete instructions for board, player, and Heir setup</div>
                <div class="description" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">Recommended for new players</div>
              </div>
              <div class="option-card" onclick="startQuickSetup()" style="cursor: pointer;">
                <div class="title">‚ö° Quick Setup</div>
                <div class="description">Just the essential choices on one page ‚Äî magicians, difficulty, and starting trick</div>
                <div class="description" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">For experienced players</div>
              </div>
            </div>
          </div>
        </div>

        <!-- QUICK SETUP PAGE -->
        <div class="setup-page hidden" id="setup-page-quick">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">‚ö° Quick Setup</h2>
            
            <!-- Your Magician -->
            <div style="margin-bottom: 25px;">
              <h3 style="color: var(--text-primary); margin-bottom: 10px;">Your Magician</h3>
              <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">Select your school:</p>
              <div class="option-grid" id="quick-player-school-options">
                <div class="option-card" data-school="mechanical">
                  <img class="school-icon" src="assets/images/schools/mechanical.png" alt="Mechanical">
                  <div class="title">Mechanical</div>
                </div>
                <div class="option-card" data-school="spiritual">
                  <img class="school-icon" src="assets/images/schools/spiritual.png" alt="Spiritual">
                  <div class="title">Spiritual</div>
                </div>
                <div class="option-card" data-school="escape">
                  <img class="school-icon" src="assets/images/schools/escape.png" alt="Escape">
                  <div class="title">Escape</div>
                </div>
                <div class="option-card" data-school="optical">
                  <img class="school-icon" src="assets/images/schools/optical.png" alt="Optical">
                  <div class="title">Optical</div>
                </div>
              </div>
              <div id="quick-player-magician-section" style="display: none; margin-top: 15px;">
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">Select your magician:</p>
                <div class="option-grid" id="quick-player-magician-options"></div>
              </div>
            </div>
            
            <!-- Heir's Magician -->
            <div style="margin-bottom: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--text-primary); margin: 0;">Heir's Magician</h3>
                <button class="btn-randomize" id="quick-randomize-heir-btn">üé≤ Random</button>
              </div>
              <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">Select Heir's school:</p>
              <div class="option-grid" id="quick-heir-school-options">
                <div class="option-card" data-school="mechanical">
                  <img class="school-icon" src="assets/images/schools/mechanical.png" alt="Mechanical">
                  <div class="title">Mechanical</div>
                </div>
                <div class="option-card" data-school="spiritual">
                  <img class="school-icon" src="assets/images/schools/spiritual.png" alt="Spiritual">
                  <div class="title">Spiritual</div>
                </div>
                <div class="option-card" data-school="escape">
                  <img class="school-icon" src="assets/images/schools/escape.png" alt="Escape">
                  <div class="title">Escape</div>
                </div>
                <div class="option-card" data-school="optical">
                  <img class="school-icon" src="assets/images/schools/optical.png" alt="Optical">
                  <div class="title">Optical</div>
                </div>
              </div>
              <div id="quick-heir-magician-section" style="display: none; margin-top: 15px;">
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">Select Heir's magician:</p>
                <div class="option-grid" id="quick-heir-magician-options"></div>
              </div>
            </div>
            
            <!-- Difficulty -->
            <div style="margin-bottom: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
              <h3 style="color: var(--text-primary); margin-bottom: 10px;">Difficulty</h3>
              <div class="option-grid" id="quick-difficulty-options">
                <div class="option-card" data-difficulty="easy">
                  <div class="title">Easy</div>
                  <div class="description">3 characters</div>
                </div>
                <div class="option-card" data-difficulty="normal">
                  <div class="title">Normal</div>
                  <div class="description">4 characters</div>
                </div>
                <div class="option-card" data-difficulty="hard">
                  <div class="title">Hard</div>
                  <div class="description">4 characters</div>
                </div>
              </div>
            </div>
            
            <!-- Heir's Starting Trick -->
            <div id="quick-trick-section" style="display: none; margin-bottom: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--text-primary); margin: 0;">Heir's Starting Trick</h3>
                <button class="btn-randomize" id="quick-randomize-trick-btn" disabled>üé≤ Random</button>
              </div>
              
              <p id="quick-heir-trick-instruction" style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">Select one of the 3 eligible Level 1 tricks:</p>
              <div class="option-grid" id="quick-starting-trick-options"></div>
            </div>
            
            <!-- Setup Summary (appears when all selections made) -->
            <div id="quick-setup-summary" style="display: none; padding-top: 20px; border-top: 1px solid var(--border);">
              <h3 style="color: var(--amber); margin-bottom: 15px;">üìã Setup Summary</h3>
              
              <div id="quick-summary-content">
                <!-- Populated by JavaScript -->
              </div>
              
              <!-- Plan Deck Instructions -->
              <div style="margin-top: 20px;">
                <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Build the Heir's Plan deck (7 cards total):</span></div>
                
                <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 8px 0 20px 0; border: 1px solid var(--border);">
                  <ol style="color: var(--text-secondary); line-height: 2; margin-left: 20px;">
                    <li>Randomly select 1 <strong>Perform</strong> card ‚Üí place face-down on <strong>bottom</strong></li>
                    <li>Shuffle 1 Set Up + 2 Perform ‚Üí place 2 face-down on top, <strong>remove 1 unseen</strong></li>
                    <li>Shuffle 2 Set Up + 1 Perform ‚Üí place all 3 face-down on top</li>
                    <li>Place 1 remaining Set Up card face-down on <strong>top</strong>, remove the other unseen</li>
                  </ol>
                </div>
                
                <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 12px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è PROPHECY SETUP:</span> Remove these 3 tokens, shuffle remaining 24, draw 3 to Pending slots. No Active Prophecy on Turn 1.</div>
                
                <div style="display: flex; justify-content: center; gap: 15px; margin: 10px 0 20px 0; flex-wrap: wrap;">
                  <div style="text-align: center;">
                    <img src="assets/images/prophecies/p15.png" alt="Shared Yield Modifier" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--danger);">
                    <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 3px;">Shared Yield</div>
                  </div>
                  <div style="text-align: center;">
                    <img src="assets/images/prophecies/p23.png" alt="Lowest AP Slot" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--danger);">
                    <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 3px;">Lowest AP</div>
                  </div>
                  <div style="text-align: center;">
                    <img src="assets/images/prophecies/p24.png" alt="Hidden Assignment" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--danger);">
                    <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 3px;">Hidden Assign</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(0)">‚Üê Back</button>
              <button class="btn" id="quick-start-game-btn" disabled>Begin Game</button>
            </div>
          </div>
        </div>

        <!-- PAGE 1: Expansion Selection -->
        <div class="setup-page hidden" id="setup-page-1">
          <div class="setup-section">
            <h2><span class="step-number">1</span> Select Expansion</h2>
            <div class="option-grid" id="expansion-options">
              <div class="option-card selected" data-expansion="base">
                <div class="title">Base Game + Dark Alley</div>
                <div class="description">Core solo experience with 7 turns and 5 character slots</div>
              </div>
              <div class="option-card disabled" data-expansion="academy">
                <div class="title">With Academy</div>
                <div class="description coming-soon">Coming Soon</div>
                <div class="description">Adds Prot√©g√©, 6th character slot, Classrooms, Practice Rooms</div>
              </div>
              <div class="option-card" data-expansion="dawn">
                <div class="title">With Dawn of Technology</div>
                <div class="description">Adds Contraptions and Signature Tricks</div>
              </div>
              <div class="option-card disabled" data-expansion="arcane">
                <div class="title">With Arcane Arts</div>
                <div class="description coming-soon">Coming Soon</div>
                <div class="description">Adds Familiars, Arcane cards, and new tricks</div>
              </div>
            </div>
            
            <!-- Dawn of Technology Optional Rules (shown when DoT is selected) -->
            <div id="dawn-options" class="hidden" style="margin-top: 20px; padding: 15px; background: var(--bg-card); border-radius: 6px; border: 1px solid var(--border);">
              <h3 style="color: var(--amber); margin-bottom: 10px; font-size: 1rem;">Dawn of Technology Options</h3>
              <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin-bottom: 15px; border-radius: 0 4px 4px 0;">
                <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> 
                <span style="color: var(--text-secondary);">The Heir does not build Contraptions or acquire Signature Tricks. The Heir starts with 1 Shard instead of 0.</span>
              </div>
              <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="dawn-challenge-rule" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                <div>
                  <div style="color: var(--text-primary); font-weight: 500;">Optional Challenge Rule</div>
                  <div style="color: var(--text-muted); font-size: 0.85rem;">At end of turn, Heir gains 1 Fame per Contraption you did NOT reactivate, and 1 Coin per empty Contraption slot. If neither applies, Heir gains 1 Shard.</div>
                </div>
              </label>
            </div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(0)">‚Üê Back</button>
              <button class="btn" onclick="showSetupPage(2)">Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 2: Board Setup -->
        <div class="setup-page hidden" id="setup-page-2">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">üìã Board Setup</h2>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place the Main Game Board in the center of the table (Dark Alley side facing up)</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Separate Trick cards into four decks by category (Mechanical, Spiritual, Escape, Optical) and place them face-up at Dahlgaard's Residence in Downtown</span></div>
            
            <div id="dot-tricks-note" style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> <span id="dot-tricks-note-text">Leave the Dawn of Technology tricks in the box (3 per category)</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Fill the Market Row Buy area with one of each starting component: Wood, Metal, Glass, and Fabric</span></div>
            

            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Create the Performance deck using <strong>solo Performance cards</strong> ‚Äî stack face-down from top to bottom: 2√ó Riverside Theater, 2√ó Grand Magorian, 2√ó Magnus Pantheon. Place next to the Theater</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place 1 random Riverside Theater card face-up in the leftmost Theater slot</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place Components, Trickerion Shards, and Coins in supply piles near the board</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Shuffle each Special Assignment deck by location and place face-down on the Dark Alley slots</span></div>
            
            <div id="dot-sa-note" style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> <span id="dot-sa-note-text">Remove Academy and Dawn of Technology Special Assignment cards</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place the Trickerion Stone token on space I of the Turn Counter track</span></div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(1)">‚Üê Back</button>
              <button class="btn" onclick="showSetupPage(3)">Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 3: Player Setup -->
        <div class="setup-page hidden" id="setup-page-3">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">üìã Player Setup</h2>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Choose your Magician ‚Äî take your Player Board and Magician Poster</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Choose one Specialist (Engineer, Manager, or Assistant) ‚Äî take the Specialist disk and Board Extension</span></div>
            
            <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;">
              <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> <span style="color: var(--text-secondary);">Specialist Bonuses:</span>
              <ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">
                <li><strong>Manager:</strong> Additional Component(s) worth up to 2 Coins, placed on the Manager's Board Extension</li>
                <li><strong>Engineer:</strong> A Level 1 Trick of your choice (after all starting Tricks are selected), placed on the Engineer's Board Extension</li>
                <li><strong>Assistant:</strong> An additional Apprentice, placed on the Assistant's Board Extension</li>
              </ul>
            </div>
            
            <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> Keep the remaining Specialist Board Extensions nearby ‚Äî you may hire them during the game</div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place your Magician disk and 1 Apprentice disk on their respective slots on your Player Board</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Take starting Components of your choice worth up to 2 Coins total ‚Äî place them in your Workshop</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Choose a Level 1 Trick from your Magician's Favorite category ‚Äî place it in your Workshop with a Symbol marker</span></div>
            
            <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> Your Trick starts <strong>Prepared</strong> if you have the required Components</div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Take your permanent Assignment cards: 2√ó Theater, 1√ó Workshop, 1√ó Market Row, 1√ó Downtown, 1√ó Dark Alley</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Take all Trick and Symbol markers in your color</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place your Fame marker on <strong>5 Fame</strong></span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Take <strong>10 Coins</strong> and <strong>1 Shard</strong></span></div>
            
            <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> Take the placement blockers from the box and keep them nearby for use during the game</div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(2)">‚Üê Back</button>
              <button class="btn" onclick="showSetupPage(4)">Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 4: Your Magician Selection -->
        <div class="setup-page hidden" id="setup-page-4">
          <div class="setup-section">
            <h2><span class="step-number">2</span> Your Magician's School</h2>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Select your school to track your Magician's ability reminder during the game:</p>
            <div class="option-grid" id="player-school-options">
              <div class="option-card" data-school="mechanical">
                <img class="school-icon" src="assets/images/schools/mechanical.png" alt="Mechanical">
                <div class="title">Mechanical</div>
                <div class="description">The Mechaniker, Elektra</div>
              </div>
              <div class="option-card" data-school="spiritual">
                <img class="school-icon" src="assets/images/schools/spiritual.png" alt="Spiritual">
                <div class="title">Spiritual</div>
                <div class="description">Priestess of Mysticism, Yoruba Spiritmaster</div>
              </div>
              <div class="option-card" data-school="escape">
                <img class="school-icon" src="assets/images/schools/escape.png" alt="Escape">
                <div class="title">Escape</div>
                <div class="description">Master of Chains, Red Lotus</div>
              </div>
              <div class="option-card" data-school="optical">
                <img class="school-icon" src="assets/images/schools/optical.png" alt="Optical">
                <div class="title">Optical</div>
                <div class="description">The Great Optico, The Gentleman</div>
              </div>
            </div>
          </div>
          
          <div class="setup-section" id="player-magician-section" style="display: none;">
            <h2><span class="step-number">3</span> Your Magician</h2>
            <div class="option-grid" id="player-magician-options">
              <!-- Populated by JavaScript -->
            </div>
          </div>
          
          <div class="setup-nav">
            <button class="btn" onclick="showSetupPage(3)">‚Üê Back</button>
            <button class="btn" id="page4-continue" onclick="showSetupPage(5)" disabled>Continue ‚Üí</button>
          </div>
        </div>

        <!-- PAGE 5: Heir Board Setup -->
        <div class="setup-page hidden" id="setup-page-5">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">üìã Heir Setup</h2>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place the Heir's board (5-character side) near your play area</span></div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(4)">‚Üê Back</button>
              <button class="btn" onclick="showSetupPage(6)">Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 6: Heir's School Selection -->
        <div class="setup-page hidden" id="setup-page-6">
          <div class="setup-section">
            <div class="section-header">
              <h2><span class="step-number">4</span> Heir's Magician</h2>
              <button class="btn-randomize" id="randomize-heir-btn">üé≤ Random School</button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Select the Heir's school (determines Favorite Trick category):</p>
            <div class="option-grid" id="heir-school-options">
              <div class="option-card" data-school="mechanical">
                <img class="school-icon" src="assets/images/schools/mechanical.png" alt="Mechanical">
                <div class="title">Mechanical</div>
                <div class="description">Favorite: Mechanical Tricks</div>
              </div>
              <div class="option-card" data-school="spiritual">
                <img class="school-icon" src="assets/images/schools/spiritual.png" alt="Spiritual">
                <div class="title">Spiritual</div>
                <div class="description">Favorite: Spiritual Tricks</div>
              </div>
              <div class="option-card" data-school="escape">
                <img class="school-icon" src="assets/images/schools/escape.png" alt="Escape">
                <div class="title">Escape</div>
                <div class="description">Favorite: Escape Tricks</div>
              </div>
              <div class="option-card" data-school="optical">
                <img class="school-icon" src="assets/images/schools/optical.png" alt="Optical">
                <div class="title">Optical</div>
                <div class="description">Favorite: Optical Tricks</div>
              </div>
            </div>
          </div>
          
          <div class="setup-section" id="heir-magician-section" style="display: none;">
            <h2>Heir's Magician</h2>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">The Heir's magician for this game:</p>
            <div class="option-grid" id="heir-magician-options">
              <!-- Populated by JavaScript -->
            </div>
          </div>
          
          <div class="setup-nav">
            <button class="btn" onclick="showSetupPage(5)">‚Üê Back</button>
            <button class="btn" id="page6-continue" onclick="showSetupPage(7)" disabled>Continue ‚Üí</button>
          </div>
        </div>

        <!-- PAGE 7: Heir's Poster -->
        <div class="setup-page hidden" id="setup-page-7">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">üìã Heir Setup (continued)</h2>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Take the Heir's Magician card (<strong id="heir-magician-card-name">‚Äî</strong>) and place it next to the Heir's board</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Take the Heir's Magician Poster (<strong id="heir-poster-name">‚Äî</strong>) and place it near the Heir's board</span></div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(6)">‚Üê Back</button>
              <button class="btn" onclick="showSetupPage(8)">Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 8: Difficulty Selection -->
        <div class="setup-page hidden" id="setup-page-8">
          <div class="setup-section">
            <h2><span class="step-number">5</span> Select Difficulty</h2>
            <div class="option-grid" id="difficulty-options">
              <div class="option-card" data-difficulty="easy">
                <div class="title">Easy</div>
                <div class="description">Magician + 1 Specialist + 1 Apprentice</div>
                <div class="description">(3 characters total)</div>
              </div>
              <div class="option-card" data-difficulty="normal">
                <div class="title">Normal</div>
                <div class="description">Magician + 1 Specialist + 2 Apprentices</div>
                <div class="description">(4 characters total)</div>
              </div>
              <div class="option-card" data-difficulty="hard">
                <div class="title">Hard</div>
                <div class="description">Magician + 2 Specialists + 1 Apprentice</div>
                <div class="description">(4 characters total)</div>
              </div>
            </div>
            
            <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> The Heir does not differentiate between Specialist types for gameplay purposes</div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(7)">‚Üê Back</button>
              <button class="btn" id="page8-continue" onclick="showSetupPage(9)" disabled>Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 9: Heir Character Placement -->
        <div class="setup-page hidden" id="setup-page-9">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">üìã Heir Setup (continued)</h2>
            
            <div id="heir-specialist-note">
              <!-- Populated by JavaScript -->
            </div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place the Heir's Character disks on the board from left to right:</span></div>
            
            <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
              <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è Heir board order:</span>
              <div style="margin-top: 8px;" id="heir-character-order">
                <!-- Populated by JavaScript -->
              </div>
            </div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(8)">‚Üê Back</button>
              <button class="btn" onclick="showSetupPage(10)">Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 10: Heir's Starting Trick -->
        <div class="setup-page hidden" id="setup-page-10">
          <div class="setup-section">
            <div class="section-header">
              <h2><span class="step-number">6</span> Heir's Starting Trick</h2>
              <button class="btn-randomize" id="randomize-trick-btn" disabled>üé≤ Randomize</button>
            </div>
            
            <p id="heir-trick-instruction" style="color: var(--text-secondary); margin-bottom: 15px;">Shuffle the following 3 Level 1 Tricks from the Heir's Favorite category (excluding the one requiring only 2 Basic Components of the same type). Draw one randomly:</p>
            <div class="option-grid" id="starting-trick-options">
              <!-- Populated by JavaScript based on Heir's magician selection -->
            </div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(9)">‚Üê Back</button>
              <button class="btn" id="page10-continue" onclick="showSetupPage(11)" disabled>Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 11: Final Heir Setup -->
        <div class="setup-page hidden" id="setup-page-11">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">üìã Heir Setup (continued)</h2>
            
            <div id="heir-trick-placement">
              <!-- Populated by JavaScript -->
            </div>
            
            <div id="setup-heir-shopping-list">
              <!-- Populated by JavaScript -->
            </div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place the Heir's Fame marker on <strong>5 Fame</strong></span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place your Magician on <strong>Initiative 1</strong>, the Heir's Magician on <strong>Initiative 3</strong></span></div>
            
            <div id="heir-starting-resources-reminder" style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è REMINDER:</span> The Heir starts with <strong>0 Coins</strong> and <strong id="heir-starting-shards">0 Shards</strong></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Take the Heir's permanent Assignment cards: 2√ó Theater, 1√ó Workshop, 1√ó Market Row, 1√ó Downtown, 1√ó Dark Alley</span></div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(10)">‚Üê Back</button>
              <button class="btn" onclick="showSetupPage(12)">Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 12: Plan Deck Construction -->
        <div class="setup-page hidden" id="setup-page-12">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">üìã Heir Setup (continued)</h2>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Build the Heir's Plan deck (7 cards total):</span></div>
            
            <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid var(--border);">
              <ol style="color: var(--text-secondary); line-height: 2; margin-left: 20px;">
                <li>Randomly select 1 <strong>Perform</strong> card ‚Üí place face-down on <strong>bottom</strong></li>
                <li>Shuffle 1 Set Up + 2 Perform ‚Üí place 2 face-down on top, <strong>remove 1 unseen</strong></li>
                <li>Shuffle 2 Set Up + 1 Perform ‚Üí place all 3 face-down on top</li>
                <li>Place 1 remaining Set Up card face-down on <strong>top</strong>, remove the other unseen</li>
              </ol>
            </div>
            
            <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> <strong>Perform</strong> cards have icons at top AND bottom. <strong>Set Up</strong> cards have icons only at top.</div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(11)">‚Üê Back</button>
              <button class="btn" onclick="showSetupPage(13)">Continue ‚Üí</button>
            </div>
          </div>
        </div>

        <!-- PAGE 13: Prophecy Setup -->
        <div class="setup-page hidden" id="setup-page-13">
          <div class="setup-section">
            <h2 style="color: var(--amber); margin-bottom: 20px;">üìã Prophecy Setup</h2>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Remove these 3 Prophecy tokens from the game:</span></div>
            
            <div style="display: flex; justify-content: center; gap: 20px; margin: 15px 0; flex-wrap: wrap;">
              <div style="text-align: center;">
                <img src="assets/images/prophecies/p15.png" alt="Shared Yield Modifier" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--danger);">
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">Shared Yield<br>Modifier</div>
              </div>
              <div style="text-align: center;">
                <img src="assets/images/prophecies/p23.png" alt="Lowest AP Slot" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--danger);">
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">Lowest AP<br>Slot</div>
              </div>
              <div style="text-align: center;">
                <img src="assets/images/prophecies/p24.png" alt="Hidden Assignment" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--danger);">
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">Hidden<br>Assignment</div>
              </div>
            </div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Shuffle the remaining 24 Prophecy tokens face-down</span></div>
            
            <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Draw 3 random Prophecy tokens and place them in the <strong>Pending</strong> slots of the crystal ball</span></div>
            
            <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è REMINDER:</span> There is no Active Prophecy on Turn 1</div>
            
            <div class="setup-nav">
              <button class="btn" onclick="showSetupPage(12)">‚Üê Back</button>
              <button class="btn" id="start-game-btn">Begin Game</button>
            </div>
          </div>
        </div>

        <!-- Debug Panel (for testing) - Press Ctrl+Shift+D to show -->
        <div id="debug-panel" style="display: none; margin-top: 30px; padding: 15px; background: rgba(100, 100, 100, 0.1); border: 1px dashed var(--border); border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span style="color: var(--text-muted); font-size: 0.85rem;">üß™ Debug Tools</span>
            <span style="color: var(--text-muted); font-size: 0.75rem;">(for testing)</span>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
            <span style="color: var(--text-muted); font-size: 0.75rem; width: 100%;">End Game:</span>
            <button class="btn" onclick="debug.testP19()" style="font-size: 0.8rem; padding: 6px 12px;">Test p19</button>
            <button class="btn" onclick="debug.testP20()" style="font-size: 0.8rem; padding: 6px 12px;">Test p20</button>
            <button class="btn" onclick="debug.endGame()" style="font-size: 0.8rem; padding: 6px 12px;">No prophecy</button>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
            <span style="color: var(--text-muted); font-size: 0.75rem; width: 100%;">End Turn (Removed Card):</span>
            <button class="btn" onclick="debug.testP16EndTurn()" style="font-size: 0.8rem; padding: 6px 12px;">Test p16 NOT shown</button>
            <button class="btn" onclick="debug.testP19EndTurn()" style="font-size: 0.8rem; padding: 6px 12px;">Test p19 IS shown</button>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <span style="color: var(--text-muted); font-size: 0.75rem; width: 100%;">Performance:</span>
            <button class="btn" onclick="debug.heirPerformance()" style="font-size: 0.8rem; padding: 6px 12px;">Heir Performs (player yields)</button>
            <button class="btn" onclick="debug.testP16PlayerPerf()" style="font-size: 0.8rem; padding: 6px 12px;">Player Performs + p16</button>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <span style="color: var(--text-muted); font-size: 0.75rem; width: 100%;">Theater:</span>
            <button class="btn" onclick="debug.testP19Theater()" style="font-size: 0.8rem; padding: 6px 12px;">Theater + p19</button>
            <button class="btn" onclick="debug.testP07Theater()" style="font-size: 0.8rem; padding: 6px 12px;">Theater + p07</button>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <span style="color: var(--text-muted); font-size: 0.75rem; width: 100%;">Downtown:</span>
            <button class="btn" onclick="debug.downtownCoins()" style="font-size: 0.8rem; padding: 6px 12px;">Downtown Coins</button>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <span style="color: var(--text-muted); font-size: 0.75rem; width: 100%;">Turn 7:</span>
            <button class="btn" onclick="debug.turn7EndTurn()" style="font-size: 0.8rem; padding: 6px 12px;">Turn 7 End Turn</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
      <div class="game-layout">
        
        <!-- Sidebar: Heir State -->
        <div class="sidebar">
          
          <!-- Heir Section Header -->
          <div style="background: rgba(212, 168, 71, 0.15); color: var(--amber); font-size: 0.8rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 8px 10px; margin-bottom: 10px; border-radius: 4px; text-align: center;">The Heir</div>
          
          <!-- Fame -->
          <div class="state-card">
            <h3>Fame</h3>
            <div class="state-value fame" id="heir-fame">5</div>
          </div>

          <!-- Resources -->
          <div class="state-card">
            <h3>Resources</h3>
            <div class="state-row">
              <span class="state-label">Coins</span>
              <span class="state-count" id="heir-coins">0</span>
            </div>
            <div class="state-row">
              <span class="state-label">Shards</span>
              <span class="state-count" id="heir-shards">0</span>
            </div>
          </div>

          <!-- Stance -->
          <div class="state-card">
            <h3>Stance</h3>
            <span class="stance-indicator pending" id="heir-stance">Not yet determined</span>
          </div>

          <!-- Active Prophecy -->
          <div class="state-card" id="prophecy-card" style="display: none; transition: border-color 0.2s ease;">
            <h3>üîÆ Prophecy</h3>
            <div id="prophecy-type" style="margin-bottom: 8px;"></div>
            <div id="prophecy-display" style="display: flex; align-items: center; gap: 10px;">
              <img id="prophecy-icon" src="" alt="" style="width: 50px; height: 50px; border-radius: 4px;">
              <div id="prophecy-name" style="color: var(--prophecy); font-weight: 600; font-size: 0.9rem;"></div>
            </div>
            <div id="prophecy-desc" style="margin-top: 8px; font-size: 0.8rem; color: var(--text-secondary);"></div>
          </div>

          <!-- Magician & Ability -->
          <div class="state-card">
            <h3>Magician</h3>
            <div id="heir-magician-display" style="color: var(--text-primary); margin-bottom: 8px;">‚Äî</div>
            <div class="ability-reminder" id="ability-reminder" style="display: none;">
              <div class="ability-title" id="ability-title">Ability</div>
              <div class="ability-text" id="ability-text">‚Äî</div>
            </div>
          </div>

          <!-- Characters -->
          <div class="state-card">
            <h3>Characters</h3>
            <div class="characters-grid" id="heir-characters">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- Tricks -->
          <div class="state-card">
            <h3>Tricks</h3>
            <div class="tricks-list" id="heir-tricks">
              <div class="empty-state">No tricks yet</div>
            </div>
          </div>

          <!-- Shopping List -->
          <div class="state-card">
            <h3>Shopping List</h3>
            <div class="shopping-list" id="heir-shopping-list">
              <div class="empty-state">Empty</div>
            </div>
          </div>

          <!-- Special Assignment Cards -->
          <div class="state-card">
            <h3>Special Assignments</h3>
            <div class="assignment-cards" id="heir-assignments">
              <div class="empty-state">None</div>
            </div>
          </div>

          <!-- Player Tricks (for tracking) -->
          <div style="background: rgba(100, 200, 100, 0.15); color: #6c6; font-size: 0.8rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 8px 10px; margin-top: 15px; margin-bottom: 10px; border-radius: 4px; text-align: center;">Player</div>
          <div class="state-card">
            <h3 style="color: var(--text-secondary);">Tracked Tricks</h3>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin: -8px 0 8px 0;">(Tricks the app has asked about)</p>
            <div class="tricks-list" id="player-tricks">
              <div class="empty-state">None tracked</div>
            </div>
            <button id="manage-player-tricks-btn" class="btn" style="width: 100%; margin-top: 10px; font-size: 0.85rem; padding: 6px;">Manage Tracked Tricks</button>
          </div>

        </div>

        <!-- Main Content -->
        <div class="main-content">
          
          <!-- Phase Tracker -->
          <div class="phase-tracker">
            <div class="round-indicator">
              <span class="round-badge">Turn <span id="current-turn">1</span> of 7</span>
            </div>
            <div class="phase-steps" id="phase-steps">
              <div class="phase-step" data-phase="roll-dice">Roll Dice</div>
              <div class="phase-step" data-phase="initiative">Initiative</div>
              <div class="phase-step" data-phase="advertise">Advertise</div>
              <div class="phase-step" data-phase="assignment">Assignment</div>
              <div class="phase-step" data-phase="place-characters">Place Characters</div>
              <div class="phase-step" data-phase="performance">Performance</div>
              <div class="phase-step" data-phase="end-turn">End Turn</div>
            </div>
          </div>

          <!-- Action Panel -->
          <div class="action-panel">
            <h2 id="action-title">Welcome</h2>
            <div class="action-content" id="action-content">
              <p>The game is ready to begin. Click "Next Phase" to start Turn 1.</p>
            </div>
            <div class="action-buttons" id="action-buttons">
              <button class="btn" id="next-phase-btn">Next Phase</button>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <script>
    // ============================================
    // CONFIGURATION FLAGS
    // ============================================
    // These flags allow easy toggling of features for testing.
    // Set to false to disable a feature if issues are discovered.
    
    const CONFIG = {
      // Skip the contested location check when placing the Heir's last character.
      // Rationale: On the last character, there's no strategic choice - it just goes
      // to its assigned location. No magician powers or prophecies depend on the
      // contested check itself (they depend on character type or location actions).
      // Set to false if testing reveals issues with this optimization.
      SKIP_CONTESTED_ON_LAST_HEIR_CHARACTER: true
    };

    // ============================================
    // GAME DATA
    // ============================================

    // Location colors extracted from official icons (see VERIFIED-DATA.md)
    const LOCATION_COLORS = {
      theater:   { border: '#983030', bg: 'rgba(152, 48, 48, 0.2)' },
      downtown:  { border: '#C9B84A', bg: 'rgba(201, 184, 74, 0.2)' },
      market:    { border: '#C48040', bg: 'rgba(196, 128, 64, 0.2)' },
      workshop:  { border: '#C87060', bg: 'rgba(200, 112, 96, 0.2)' },
      darkAlley: { border: '#5A5A5A', bg: 'rgba(90, 90, 90, 0.2)' }
    };

    const MAGICIANS = {
      mechanical: [
        { id: 'mechaniker', name: 'The Mechaniker', title: 'Mechanical Enhancement', ability: 'Once per turn, one of your Apprentices receives an additional Action Point when placed at any Location except for the Theater.', soloAbility: 'The first Apprentice the Heir places every turn has +1 AP.' },
        { id: 'elektra', name: 'Elektra', title: 'Supercharge', ability: 'You may choose to pile two markers of the same Trick on a Trick slot when you set up a Trick. It counts as one Trick and Link bonuses are paid only once. When performed, this Trick Yields 1/2/3 additional Fame point(s) and Coin(s) depending on its Level (1/2/3).', soloAbility: 'All of the Heir\'s Tricks that have 2 or 3 Trick markers are Prepared with one less Trick marker, but all of its Tricks score +1/+2/+3 on all Yields based on their Level.' },
        { id: 'geert', name: 'Geert van Augustin', title: 'Innovation', ability: 'When Renovating, gain 1 Shard.', soloAbility: 'When Renovating, the Heir will always choose the most expensive renovation regardless of Coins. It also gains 1 Shard each time it renovates.' }
      ],
      optical: [
        { id: 'optico', name: 'The Great Optico', title: 'Mimesis', ability: 'Once per turn, you may use one of your Permanent Assignment cards with an effect of an opponent\'s revealed Special Assignment card of the same Location. You may use either the copied card\'s printed ability or gain its +1 Action Point bonus instead.', soloAbility: 'The first X non-Apprentice Characters that the Heir places every turn gain +1 AP, where X is the number of Special Assignment cards you used that turn.' },
        { id: 'gentleman', name: 'The Gentleman', title: 'Magic for the Masses', ability: 'Whenever the Magician is placed on a Downtown, Market Row or Dark Alley slot, you receive Fame equal to the number of Trick cards you have.', soloAbility: 'Whenever the Heir places its Magician on a Downtown, Market Row, or Dark Alley slot, it receives Fame equal to the number of Trick cards it has.' },
        { id: 'lumenia', name: 'Lumenia the Radiant', title: 'Chains of Light', ability: 'Receive 1 additional Fame for each Link created.', soloAbility: 'The Heir receives 1 additional Fame (but not Shard) for each Link it creates when setting up Tricks in the Theater.' }
      ],
      escape: [
        { id: 'chains', name: 'Master of Chains', title: 'Breaking Free', ability: 'Before the Performance phase, you may take a special Reschedule Action without placing any Characters. Unlike the normal Reschedule Action, you receive the Link bonuses if you create Link(s) with this placement.', soloAbility: 'The first Trick placed by the Heir each turn can be oriented freely: the corner corresponding to the Trick\'s category does not have to be in a Link circle.' },
        { id: 'redlotus', name: 'Red Lotus', title: 'Trick Steal', ability: 'You may choose to receive the Yield of an opponent\'s Trick in the same Performance instead of your own Trick\'s Yield, as long as you are the Performer and the opponent\'s Trick has the same or lower Fame Threshold as yours. The opponent receives one less Fame for the Trick stolen this way.', soloAbility: 'When the Heir performs, it gets +1 Fame for each Trick you have on its selected Performance card.' },
        { id: 'bernard', name: 'Professor Bernard', title: 'Mentorship', ability: 'During the Classroom phase, gain 3 Coins for each marker in the Classrooms.', soloAbility: 'During the Classroom phase, the Heir gains 3 Coins for each marker in the Classrooms (regardless of the owner).' }
      ],
      spiritual: [
        { id: 'priestess', name: 'Priestess of Mysticism', title: 'Fate Weaving', ability: 'For 1 Dark Alley Action Point, you may discard the Active Prophecy, then replace it with any of the Pending Prophecies and draw a new one in its place.', soloAbility: 'If the Heir rotates the Dark Alley Prophecies, it will swap the next turn\'s Prophecy with a randomly drawn one.' },
        { id: 'yoruba', name: 'Yoruba Spiritmaster', title: 'Soul Possession', ability: 'Once per turn, before an opponent chooses a card to Perform, you may pay one Shard. If you do, you may choose the card to Perform for that player. The chosen card must have at least one of the opponent\'s Trick markers on it.', soloAbility: 'The Heir always performs first, regardless of Theater workday assignment.' },
        { id: 'anjali', name: 'Anjali', title: 'Spirit Guide', ability: 'At the beginning of the End Turn phase, gain 2 Coins for each Secret your Prot√©g√© has.', soloAbility: 'At the beginning of the End Turn phase, the Heir gains 2 Coins for each Secret its Prot√©g√© has.' }
      ]
    };

    // Component tiers
    const COMPONENTS = {
      basic: ['wood', 'glass', 'metal', 'fabric'],
      advanced: ['rope', 'petroleum', 'saw', 'animal'],
      superior: ['padlock', 'mirror', 'disguise', 'cog']
    };
    
    const ALL_COMPONENTS = [...COMPONENTS.basic, ...COMPONENTS.advanced, ...COMPONENTS.superior];

    // Prophecy definitions - icons loaded from external assets/images/prophecies/ folder
    // VERIFIED PROPHECIES - descriptions verified from Magician Workbook (Dec 2025)
    const PROPHECIES = {
      // REMOVED for solo play (3) - these prophecies are not used
      removed: [
        { id: 'p15', name: 'Shared Yield Modifier', icon: 'p15.png', description: 'During the "Performance" phase, the performing player\'s Yield modifier applies to all other players in the Performance (instead of their own).', reason: 'Solo rules explicitly remove this - multiplayer only' },
        { id: 'p23', name: 'Lowest AP Slot', icon: 'p23.png', description: 'You must place your Characters on the Slot with the lowest available Action Point modifier.', reason: 'Solo rules explicitly remove this' },
        { id: 'p24', name: 'Hidden Assignment', icon: 'p24.png', description: 'Assignment cards are not revealed after the "Assignment" phase. Players reveal them one by one right before placing the Character above them.', reason: 'Solo rules explicitly remove this - no assignment phase' }
      ],
      
      // HEIR IGNORES (12) - these only affect the player, Heir ignores them
      heirIgnores: [
        { id: 'p03', name: 'Take Coins 1 AP', icon: 'p03.png', description: 'The "Take Coins" Action costs 1 Action Point.' },
        { id: 'p04', name: 'Hire Character 1 AP', icon: 'p04.png', description: 'The "Hire Character" Action costs 1 Action Point.' },
        { id: 'p05', name: 'Learn Trick 1 AP', icon: 'p05.png', description: 'The "Learn Trick" Action costs 1 Action Point.' },
        { id: 'p06', name: 'Draw Cards 1 AP', icon: 'p06.png', description: 'The "Draw Further Cards" Action costs 1 Action Point.' },
        { id: 'p11', name: 'Saturday Yield', icon: 'p11.png', description: 'Saturday has a Yield modifier: +1 Fame and +1 Coin (similar to Sunday).' },
        { id: 'p12', name: 'Friday Yield', icon: 'p12.png', description: 'Friday has a Yield modifier: -1 Fame and -1 Coin (similar to Thursday).' },
        { id: 'p13', name: 'No Thursday Sunday', icon: 'p13.png', description: 'Thursday and Sunday have no Yield modifiers.' },
        { id: 'p17', name: 'Enhance Theater', icon: 'p17.png', description: 'You may use "Enhance Character" in the Theater.' },
        { id: 'p18', name: 'Enhance 2 AP', icon: 'p18.png', description: 'You receive 2 Action Points instead of 1 when you use "Enhance Character".' },
        { id: 'p21', name: 'Pay 3 for +2 Slots', icon: 'p21.png', description: 'You have to pay 3 Coins to use the +2 Action Point Slots at the Downtown, Market Row and Dark Alley.' },
        { id: 'p26', name: 'Buy From Orders', icon: 'p26.png', description: 'Component types in the Market Row\'s Order area can be bought with "Buy" Actions.' },
        { id: 'p27', name: 'All Components 2 Coins', icon: 'p27.png', description: 'All Components cost 2 Coins when you buy them.' }
      ],
      
      // AFFECT BOTH (12) - these affect both player and Heir
      affectBoth: [
        { id: 'p01', name: 'Advertise Apprentice AP', icon: 'p01.png', description: 'If you Advertised this turn, your Apprentices gain +1 base Action Point.' },
        { id: 'p02', name: 'Double Coins', icon: 'p02.png', description: 'Double the amount of Coins on the chosen die when you take the "Take Coins" Action.' },
        { id: 'p07', name: 'Fame Mechanical', icon: 'p07.png', description: 'You immediately receive 2 Fame when you set up a Mechanical Trick.' },
        { id: 'p08', name: 'Fame Escape', icon: 'p08.png', description: 'You immediately receive 2 Fame when you set up an Escape Trick.' },
        { id: 'p09', name: 'Fame Spiritual', icon: 'p09.png', description: 'You immediately receive 2 Fame when you set up a Spiritual Trick.' },
        { id: 'p10', name: 'Fame Optical', icon: 'p10.png', description: 'You immediately receive 2 Fame when you set up an Optical Trick.' },
        { id: 'p14', name: 'Double Performer Bonus', icon: 'p14.png', description: 'All Performer Bonuses are doubled this turn.' },
        { id: 'p16', name: 'Coins As Fame', icon: 'p16.png', description: 'During the "Performance" phase, all Coin Yields are received as Fame.' },
        { id: 'p19', name: 'Extra Shard', icon: 'p19.png', description: 'Any time you receive one or more Shards, you receive an additional one.' },
        { id: 'p20', name: 'Shards Give Fame', icon: 'p20.png', description: 'Any time you receive one or more Shards, you also receive 2 Fame.' },
        { id: 'p22', name: 'Place Two Characters', icon: 'p22.png', description: 'You may place two Characters on each of your turns during the "Place Characters" phase.' },
        { id: 'p25', name: '1 Base AP', icon: 'p25.png', description: 'Each Character has only 1 base Action Point.' }
      ]
    };
    
    // Helper to get all valid prophecies for solo play (excludes removed ones)
    const VALID_PROPHECIES = [...PROPHECIES.heirIgnores, ...PROPHECIES.affectBoth];

    const ALL_TRICKS = {
      mechanical: {
        level_1: [
          { id: 'linking-rings', name: 'Linking Rings', components: { metal: 2 }, markers: 2, actionCost: 1, fame: 0, coins: 2, shards: 0, endGameBonus: null },
          { id: 'living-piano', name: 'Living Piano', components: { wood: 1, glass: 1, animal: 1 }, markers: 3, actionCost: 1, fame: 1, coins: 1, shards: 0, endGameBonus: null },
          { id: 'chinese-sticks', name: 'Chinese Sticks', components: { wood: 2, rope: 2 }, markers: 2, actionCost: 1, fame: 1, coins: 2, shards: 0, endGameBonus: null },
          { id: 'levitation', name: 'Levitation', components: { glass: 3, rope: 1, petroleum: 2 }, markers: 2, actionCost: 1, fame: 2, coins: 3, shards: 0, endGameBonus: null }
        ],
        level_16: [
          { id: 'mechanical-hornet', name: 'Mechanical Hornet', components: { metal: 3, petroleum: 1, cog: 1 }, markers: 2, actionCost: 2, fame: 4, coins: 3, shards: 0, endGameBonus: null },
          { id: 'sawing-assistant', name: 'Sawing the Assistant in Half', components: { wood: 3, saw: 3 }, markers: 3, actionCost: 1, fame: 1, coins: 5, shards: 0, endGameBonus: null },
          { id: 'vanishing-bird-cage', name: 'Vanishing Bird Cage', components: { metal: 2, cog: 1, animal: 2 }, markers: 2, actionCost: 1, fame: 2, coins: 3, shards: 1, endGameBonus: null },
          { id: 'bullet-catch', name: 'Bullet Catch', components: { metal: 2, rope: 2, petroleum: 2 }, markers: 3, actionCost: 2, fame: 3, coins: 4, shards: 0, endGameBonus: null }
        ],
        level_36: [
          { id: 'aztec-lady', name: 'Aztec Lady', components: { glass: 2, saw: 1, padlock: 1, cog: 2 }, markers: 3, actionCost: 2, fame: 5, coins: 5, shards: 0, endGameBonus: '2 points per trick marker' },
          { id: 'horror-saws', name: 'Horror Saws', components: { wood: 3, saw: 2, cog: 2 }, markers: 2, actionCost: 2, fame: 4, coins: 8, shards: 0, endGameBonus: '1 point per shard' },
          { id: 'automaton', name: 'Automaton', components: { metal: 3, petroleum: 3, cog: 3 }, markers: 1, actionCost: 1, fame: 7, coins: 7, shards: 0, endGameBonus: '4 points per Level 2 trick' },
          { id: 'hellhound', name: 'Hellhound', components: { fabric: 3, petroleum: 1, padlock: 2, animal: 2 }, markers: 2, actionCost: 2, fame: 6, coins: 5, shards: 1, endGameBonus: '2 points per trick' }
        ]
      },
      spiritual: {
        level_1: [
          { id: 'mind-reading', name: 'Mind Reading', components: { glass: 2 }, markers: 3, actionCost: 1, fame: 0, coins: 0, shards: 1, endGameBonus: null },
          { id: 'breath-of-life', name: 'Breath of Life', components: { metal: 1, fabric: 2, saw: 1 }, markers: 1, actionCost: 1, fame: 2, coins: 3, shards: 0, endGameBonus: null },
          { id: 'spirit-hand', name: 'Spirit Hand', components: { fabric: 3, rope: 1, animal: 1 }, markers: 2, actionCost: 1, fame: 2, coins: 1, shards: 1, endGameBonus: null },
          { id: 'window-otherworld', name: 'Window to the Otherworld', components: { metal: 2, petroleum: 1, mirror: 1 }, markers: 2, actionCost: 1, fame: 3, coins: 2, shards: 0, endGameBonus: null }
        ],
        level_16: [
          { id: 'floating-table', name: 'Floating Table', components: { wood: 3, fabric: 3, rope: 3, petroleum: 1 }, markers: 2, actionCost: 2, fame: 5, coins: 2, shards: 1, endGameBonus: null },
          { id: 'future-sight', name: 'Future Sight', components: { metal: 2, fabric: 2, mirror: 1 }, markers: 1, actionCost: 1, fame: 4, coins: 1, shards: 0, endGameBonus: null },
          { id: 'peppers-ghost', name: "Pepper's Ghost", components: { saw: 2, mirror: 2, disguise: 2 }, markers: 2, actionCost: 2, fame: 4, coins: 5, shards: 0, endGameBonus: null },
          { id: 'ghost-trap', name: 'Ghost Trap', components: { wood: 3, glass: 3, fabric: 3, animal: 3 }, markers: 3, actionCost: 2, fame: 3, coins: 3, shards: 1, endGameBonus: null }
        ],
        level_36: [
          { id: 'balsamos-skull', name: "Balsamo's Skull", components: { metal: 3, rope: 2, padlock: 1 }, markers: 3, actionCost: 2, fame: 4, coins: 3, shards: 2, endGameBonus: '3 points per Superior component' },
          { id: 'seance', name: 'S√©ance', components: { wood: 3, petroleum: 2, mirror: 2 }, markers: 2, actionCost: 2, fame: 7, coins: 5, shards: 1, endGameBonus: '3 points per Apprentice' },
          { id: 'skeleton-dance', name: 'Skeleton Dance', components: { glass: 3, rope: 2, cog: 2 }, markers: 3, actionCost: 3, fame: 6, coins: 4, shards: 0, endGameBonus: '1 point per Basic component' },
          { id: 'metamorphosis', name: 'Metamorphosis', components: { glass: 3, fabric: 3, rope: 3, disguise: 3 }, markers: 3, actionCost: 3, fame: 10, coins: 4, shards: 0, endGameBonus: '1 point per 3 coins' }
        ]
      },
      escape: {
        level_1: [
          { id: 'barricaded-barrels', name: 'Barricaded Barrels', components: { wood: 2 }, markers: 2, actionCost: 1, fame: 1, coins: 1, shards: 0, endGameBonus: null },
          { id: 'stocks-escape', name: 'Stocks Escape', components: { wood: 2, metal: 2 }, markers: 2, actionCost: 1, fame: 0, coins: 1, shards: 1, endGameBonus: null },
          { id: 'burning-mummy', name: 'Burning Mummy', components: { fabric: 3, petroleum: 1 }, markers: 1, actionCost: 1, fame: 2, coins: 2, shards: 0, endGameBonus: null },
          { id: 'water-tank-escape', name: 'Water Tank Escape', components: { glass: 2, metal: 2, rope: 1 }, markers: 2, actionCost: 1, fame: 1, coins: 2, shards: 1, endGameBonus: null }
        ],
        level_16: [
          { id: 'prison-break', name: 'Prison Break', components: { metal: 3, disguise: 2 }, markers: 2, actionCost: 1, fame: 3, coins: 3, shards: 0, endGameBonus: null },
          { id: 'zig-zag-lady', name: 'Zig Zag Lady', components: { wood: 3, fabric: 1, petroleum: 1 }, markers: 3, actionCost: 1, fame: 2, coins: 3, shards: 0, endGameBonus: null },
          { id: 'walled', name: 'Walled', components: { wood: 3, metal: 3, padlock: 1 }, markers: 2, actionCost: 1, fame: 3, coins: 2, shards: 1, endGameBonus: null },
          { id: 'wolf-cage', name: 'Wolf Cage', components: { metal: 2, petroleum: 1, animal: 2 }, markers: 1, actionCost: 1, fame: 3, coins: 3, shards: 1, endGameBonus: null }
        ],
        level_36: [
          { id: 'buried-alive', name: 'Buried Alive', components: { wood: 3, padlock: 3 }, markers: 2, actionCost: 1, fame: 4, coins: 4, shards: 0, endGameBonus: '7 points if you have Engineer' },
          { id: 'assistants-revenge', name: "Assistant's Revenge", components: { glass: 3, saw: 2, mirror: 2 }, markers: 1, actionCost: 1, fame: 6, coins: 6, shards: 0, endGameBonus: '7 points if you have Assistant' },
          { id: 'iron-maiden', name: 'Iron Maiden', components: { metal: 3, saw: 3, padlock: 2 }, markers: 2, actionCost: 2, fame: 5, coins: 5, shards: 1, endGameBonus: '4 points per Level 1 trick' },
          { id: 'transported-man', name: 'Transported Man', components: { fabric: 3, petroleum: 2, disguise: 2 }, markers: 2, actionCost: 2, fame: 5, coins: 3, shards: 2, endGameBonus: '4 points per Level 3 trick' }
        ]
      },
      optical: {
        level_1: [
          { id: 'enchanted-butterflies', name: 'Enchanted Butterflies', components: { fabric: 2 }, markers: 2, actionCost: 1, fame: 2, coins: 0, shards: 0, endGameBonus: null },
          { id: 'rabbit-top-hat', name: 'Rabbit from the Top Hat', components: { metal: 1, fabric: 1, animal: 1 }, markers: 1, actionCost: 1, fame: 3, coins: 1, shards: 0, endGameBonus: null },
          { id: 'pub-in-bottle', name: 'Pub-In-A-Bottle', components: { glass: 3, saw: 1, rope: 1 }, markers: 2, actionCost: 1, fame: 2, coins: 2, shards: 0, endGameBonus: null },
          { id: 'card-manipulation', name: 'Card Manipulation', components: { wood: 3, fabric: 3 }, markers: 2, actionCost: 1, fame: 1, coins: 1, shards: 1, endGameBonus: null }
        ],
        level_16: [
          { id: 'self-decapitation', name: 'Self Decapitation', components: { metal: 3, saw: 1, disguise: 1 }, markers: 3, actionCost: 1, fame: 3, coins: 2, shards: 0, endGameBonus: null },
          { id: 'paper-shred', name: 'Paper Shred', components: { fabric: 3, saw: 2, mirror: 1 }, markers: 2, actionCost: 2, fame: 4, coins: 2, shards: 1, endGameBonus: null },
          { id: 'shattered-mirror', name: 'Shattered Mirror', components: { wood: 3, glass: 3, mirror: 2 }, markers: 2, actionCost: 2, fame: 5, coins: 3, shards: 0, endGameBonus: null },
          { id: 'fishing-in-air', name: 'Fishing in the Air', components: { wood: 3, rope: 2, animal: 3 }, markers: 3, actionCost: 2, fame: 3, coins: 4, shards: 1, endGameBonus: null }
        ],
        level_36: [
          { id: 'mutilation', name: 'Mutilation', components: { glass: 2, fabric: 3, saw: 2, disguise: 1 }, markers: 2, actionCost: 2, fame: 6, coins: 5, shards: 0, endGameBonus: '12 points if you have all 3 Specialists' },
          { id: 'stairs-of-water', name: 'Stairs of Water', components: { glass: 3, petroleum: 2, cog: 1, disguise: 1 }, markers: 3, actionCost: 3, fame: 5, coins: 4, shards: 2, endGameBonus: '2 points per Advanced component' },
          { id: 'beast-within', name: 'Beast Within', components: { metal: 3, animal: 3, mirror: 1, disguise: 1 }, markers: 2, actionCost: 2, fame: 7, coins: 3, shards: 1, endGameBonus: '10 points if you have 4 tricks' },
          { id: 'vanishing-elephant', name: 'Vanishing Elephant', components: { glass: 3, padlock: 2, animal: 2, mirror: 1 }, markers: 2, actionCost: 2, fame: 9, coins: 4, shards: 0, endGameBonus: '7 points if you have Manager' }
        ]
      }
    };

    // Helper function to get Level 1 tricks for starting trick selection
    function getLevel1Tricks(school) {
      return ALL_TRICKS[school].level_1;
    }

    // Helper function to get eligible starting tricks (excluding single Basic Component type tricks)
    function getEligibleStartingTricks(school) {
      const tricks = getLevel1Tricks(school);
      // Exclude tricks that only use one type of Basic Component (wood, glass, metal, fabric)
      // Basic components are: wood, glass, metal, fabric
      const basicComponents = ['wood', 'glass', 'metal', 'fabric'];
      
      return tricks.filter(trick => {
        const componentTypes = Object.keys(trick.components);
        // If only one component type and it's a basic component, exclude it
        if (componentTypes.length === 1 && basicComponents.includes(componentTypes[0])) {
          return false;
        }
        return true;
      });
    }

    // Helper to format components for display
    function formatComponents(components) {
      return Object.entries(components)
        .map(([type, count]) => `${type.charAt(0).toUpperCase() + type.slice(1)} √ó${count}`)
        .join(', ');
    }

    // Helper to get unique component types for shopping list
    function getUniqueComponentTypes(components) {
      return Object.keys(components).map(c => c.charAt(0).toUpperCase() + c.slice(1));
    }

    const LEVEL_1_TRICKS = {
      mechanical: ALL_TRICKS.mechanical.level_1,
      spiritual: ALL_TRICKS.spiritual.level_1,
      escape: ALL_TRICKS.escape.level_1,
      optical: ALL_TRICKS.optical.level_1
    };

    const DIFFICULTY_SETTINGS = {
      easy: {
        characters: { magician: 1, specialists: 1, apprentices: 1 },
        description: 'Magician + 1 Specialist + 1 Apprentice (3 characters total)'
      },
      normal: {
        characters: { magician: 1, specialists: 1, apprentices: 2 },
        description: 'Magician + 1 Specialist + 2 Apprentices (4 characters total)'
      },
      hard: {
        characters: { magician: 1, specialists: 2, apprentices: 1 },
        description: 'Magician + 2 Specialists + 1 Apprentice (4 characters total)'
      }
    };

    const PHASES = [
      { id: 'roll-dice', name: 'Roll Dice' },
      { id: 'initiative', name: 'Initiative' },
      { id: 'advertise', name: 'Advertise' },
      { id: 'assignment', name: 'Assignment' },
      { id: 'place-characters', name: 'Place Characters' },
      { id: 'performance', name: 'Performance' },
      { id: 'end-turn', name: 'End Turn' }
    ];

    // Downtown dice count based on Action Points and difficulty
    const DOWNTOWN_DICE_TABLE = {
      easy:   { 1: 1, 2: 1, 3: 1, 4: 2, 5: 2 },
      normal: { 1: 1, 2: 1, 3: 1, 4: 2, 5: 3 },
      hard:   { 1: 1, 2: 1, 3: 2, 4: 3, 5: 3 }
    };

    // ============================================
    // DOWNTOWN LOGIC
    // ============================================

    function getDowntownDiceCount(actionPoints) {
      const table = DOWNTOWN_DICE_TABLE[gameState.difficulty];
      return table[Math.min(actionPoints, 5)] || 1;
    }

    function getHeirHighestTrickLevel() {
      if (gameState.heir.tricks.length === 0) return 1;
      return Math.max(...gameState.heir.tricks.map(t => t.level));
    }

    function getHeirTricksAtLevel(level) {
      return gameState.heir.tricks.filter(t => t.level === level);
    }

    function getHeirApprenticeCount() {
      return gameState.heir.characters.filter(c => c === 'apprentice').length;
    }

    const SPECIALIST_TYPES = ['engineer', 'manager', 'assistant'];
    
    function getHeirSpecialistCount() {
      return gameState.heir.characters.filter(c => SPECIALIST_TYPES.includes(c)).length;
    }

    function getHeirTotalCharacterCount() {
      return gameState.heir.characters.length + gameState.heir.pendingCharacters.length;
    }

    function heirHasSpecialist() {
      return getHeirSpecialistCount() > 0;
    }
    
    function heirHasSpecificSpecialist(type) {
      return gameState.heir.characters.includes(type);
    }

    // Determine what level trick the Heir should learn
    function getTargetTrickLevel() {
      const fame = gameState.heir.fame;
      if (fame >= 36) return 3;
      if (fame >= 16) return 2;
      return 1;
    }

    // Get available tricks at a given level for the Heir's school
    function getAvailableTricksAtLevel(level) {
      const school = gameState.heirMagician.school;
      const levelKey = level === 1 ? 'level_1' : level === 2 ? 'level_16' : 'level_36';
      let allTricksAtLevel = ALL_TRICKS[school][levelKey];
      
      // For Level 1, exclude tricks with only 1 type of Basic Component (per rulebook exception)
      if (level === 1) {
        const basicComponents = ['wood', 'glass', 'metal', 'fabric'];
        allTricksAtLevel = allTricksAtLevel.filter(trick => {
          const componentTypes = Object.keys(trick.components);
          // Exclude if only one component type and it's a basic component
          if (componentTypes.length === 1 && basicComponents.includes(componentTypes[0])) {
            return false;
          }
          return true;
        });
      }
      
      // Filter out tricks already owned by Heir or Player
      const heirTrickIds = gameState.heir.tricks.map(t => t.id);
      const playerTrickIds = gameState.player.tricks.map(t => t.id);
      return allTricksAtLevel.filter(t => !heirTrickIds.includes(t.id) && !playerTrickIds.includes(t.id));
    }

    // Get available tricks at a given level for a specific school (may differ from Heir's school)
    function getAvailableTricksAtLevelForSchool(level, school) {
      const levelKey = level === 1 ? 'level_1' : level === 2 ? 'level_16' : 'level_36';
      let allTricksAtLevel = ALL_TRICKS[school][levelKey];
      
      // For Level 1, exclude tricks with only 1 type of Basic Component (per rulebook exception)
      if (level === 1) {
        const basicComponents = ['wood', 'glass', 'metal', 'fabric'];
        allTricksAtLevel = allTricksAtLevel.filter(trick => {
          const componentTypes = Object.keys(trick.components);
          // Exclude if only one component type and it's a basic component
          if (componentTypes.length === 1 && basicComponents.includes(componentTypes[0])) {
            return false;
          }
          return true;
        });
      }
      
      // Filter out tricks already owned by Heir or Player
      const heirTrickIds = gameState.heir.tricks.map(t => t.id);
      const playerTrickIds = gameState.player.tricks.map(t => t.id);
      return allTricksAtLevel.filter(t => !heirTrickIds.includes(t.id) && !playerTrickIds.includes(t.id));
    }

    // Check if Heir should learn a trick (Step 1 condition)
    function shouldLearnTrick() {
      const highestAvailableLevel = getTargetTrickLevel(); // Based on Fame thresholds
      const tricksAtHighestAvailable = gameState.heir.tricks.filter(t => t.level === highestAvailableLevel);
      const hasFame36Plus = gameState.heir.fame >= 36;
      
      // Learn if: fewer than 2 tricks at highest AVAILABLE level OR has 36+ Fame
      return tricksAtHighestAvailable.length < 2 || hasFame36Plus;
    }

    // Calculate trick yield for sorting (Fame > Shards > Coins)
    function getTrickYieldValue(trick) {
      return (trick.fame * 10000) + (trick.shards * 100) + trick.coins;
    }

    // Add a trick to the Heir's board in descending yield order
    function addTrickToHeir(trick, level, school) {
      const trickWithState = {
        ...trick,
        school: school,
        level: level,
        currentMarkers: trick.markers,
        prepared: true
      };
      
      // Add to tricks array
      gameState.heir.tricks.push(trickWithState);
      
      // Sort by yield (descending)
      gameState.heir.tricks.sort((a, b) => getTrickYieldValue(b) - getTrickYieldValue(a));
      
      // Add components to shopping list
      const newComponents = getUniqueComponentTypes(trick.components);
      newComponents.forEach(comp => {
        if (!gameState.heir.shoppingList.includes(comp)) {
          gameState.heir.shoppingList.push(comp);
        }
      });
      
      updateGameDisplay();
    }

    // Process Downtown actions based on dice
    // trickStatus: 'none' = evaluate normally, 'skipped' = conditions not met (no die used), 'taken' = trick selected (die consumed)
    function generateDowntownInstructions(actionPoints, diceState, trickStatus = 'none') {
      const instructions = [];
      const diceCount = getDowntownDiceCount(actionPoints);
      const heirSchool = gameState.heirMagician.school;
      
      // Check for p02 (Double Coins)
      const isDoubleCoins = gameState.activeProphecy?.id === 'p02';
      
      instructions.push({
        type: 'info',
        text: `The Heir collects <strong>${diceCount} dice</strong> (${actionPoints} AP on ${gameState.difficulty} difficulty).`
      });
      
      // Track which dice are still available (not set to X)
      let availableDice = {
        trick1: diceState.trick1,
        trick2: diceState.trick2,
        apprentice: diceState.apprentice,
        specialist: diceState.specialist,
        bank1: diceState.bank1,
        bank2: diceState.bank2
      };
      
      let totalDiceUsed = 0;
      
      // Helper to check if we can still use dice
      const canUseDie = () => totalDiceUsed < diceCount;
      
      // Step 1: Trick die (if should learn trick)
      // Note: Can use either trick die. If both show X, cannot learn a trick.
      // Skip if we already handled trick selection interactively
      if (trickStatus === 'none' && canUseDie() && shouldLearnTrick()) {
        const targetLevel = getTargetTrickLevel();
        
        // Check if a trick die is available (showing any school or wild, not X)
        let trickDieUsed = null;
        let trickCategory = null;
        let trickSchool = null; // The actual school to draw tricks from
        
        // Check trick die 1 first (prefer left die per rulebook)
        if (availableDice.trick1 !== 'x' && availableDice.trick1 !== 'used') {
          trickDieUsed = 'Trick Die 1';
          if (availableDice.trick1 === 'wild') {
            trickCategory = heirSchool.charAt(0).toUpperCase() + heirSchool.slice(1) + ' (? die uses Heir\'s Favorite trick category)';
            trickSchool = heirSchool;
          } else {
            trickCategory = availableDice.trick1.charAt(0).toUpperCase() + availableDice.trick1.slice(1);
            trickSchool = availableDice.trick1;
          }
          availableDice.trick1 = 'used';
        }
        // Check trick die 2
        else if (availableDice.trick2 !== 'x' && availableDice.trick2 !== 'used') {
          trickDieUsed = 'Trick Die 2';
          if (availableDice.trick2 === 'wild') {
            trickCategory = heirSchool.charAt(0).toUpperCase() + heirSchool.slice(1) + ' (? die uses Heir\'s Favorite trick category)';
            trickSchool = heirSchool;
          } else {
            trickCategory = availableDice.trick2.charAt(0).toUpperCase() + availableDice.trick2.slice(1);
            trickSchool = availableDice.trick2;
          }
          availableDice.trick2 = 'used';
        }
        // If both trick dice show X, cannot learn a trick
        
        if (trickDieUsed && trickSchool) {
          // Get available tricks from the determined school (not necessarily Heir's school)
          const availableTricks = getAvailableTricksAtLevelForSchool(targetLevel, trickSchool);
          
          if (availableTricks.length > 0) {
            totalDiceUsed++;
            
            // Build substeps array
            const substeps = [
              '<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place the new Trick on the Heir\'s board (maintain descending Yield order: Fame > Shards > Coins)</span></div>',
              'The Trick is immediately Prepared ‚Äî place the indicated number of Trick markers on it',
              '<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Add one of each Component type shown on the Trick to the Heir\'s Shopping List box (if not already there)</span></div>',
              availableTricks.length === 1 ? `<em>Only one trick available: ${availableTricks[0].name}</em>` : `<em>${availableTricks.length} tricks available at this level</em>`
            ];
            
            // Add Level 1 exception reminder with specific trick name
            if (targetLevel === 1) {
              const excludedTricks = {
                mechanical: 'Linking Rings (Metal √ó2)',
                spiritual: 'Mind Reading (Glass √ó2)',
                escape: 'Barricaded Barrels (Wood √ó2)',
                optical: 'Enchanted Butterflies (Fabric √ó2)'
              };
              const excludedTrick = excludedTricks[trickSchool] || 'the trick with only 1 Basic Component type';
              substeps.unshift(`<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è EXCEPTION:</span> Exclude <strong>${excludedTrick}</strong> from the shuffle</div>`);
            }
            
            instructions.push({
              type: 'action',
              step: 1,
              dieUsed: trickDieUsed,
              text: `<strong>Set ${trickDieUsed} to X.</strong> Learn a Level ${targetLevel} Trick: Take all available Level ${targetLevel} ${trickCategory} tricks, shuffle, and draw one.`,
              substeps: substeps
            });
            
            // Check if we need to return a trick (no empty slots)
            if (gameState.heir.tricks.length >= 4) {
              instructions.push({
                type: 'warning',
                text: `If no empty Trick slots: Return the lowest-yield Trick to Dahlgaard's Residence (discard its markers).`
              });
            }
          } else {
            // No tricks available at this level for this school
            instructions.push({
              type: 'info',
              text: `<em>No Level ${targetLevel} ${trickCategory} tricks available - Step 1 skipped.</em>`
            });
          }
        }
      } else if (trickStatus === 'taken') {
        // Trick was selected interactively - mark die as used (no message needed)
        // Mark the trick die as used so the count is correct
        if (availableDice.trick1 !== 'x') {
          availableDice.trick1 = 'used';
          totalDiceUsed++;
        } else if (availableDice.trick2 !== 'x') {
          availableDice.trick2 = 'used';
          totalDiceUsed++;
        }
      } else if (trickStatus === 'skipped') {
        // Trick conditions not met or no tricks available - die NOT consumed
        instructions.push({
          type: 'info',
          text: `<em>Step 1 (Learn Trick) skipped ‚Äî conditions not met.</em>`
        });
      }
      
      // Step 2: Specialist die (if Heir doesn't have THAT specific Specialist type)
      // Note: Can only use if Specialist die shows a specialist the Heir doesn't have
      if (canUseDie()) {
        // Check if specialist die shows a specialist (not X or used)
        if (availableDice.specialist !== 'x' && availableDice.specialist !== 'used') {
          const specialistType = availableDice.specialist; // 'engineer', 'manager', or 'assistant'
          // Only hire if Heir doesn't have this specific type
          if (!heirHasSpecificSpecialist(specialistType)) {
            const specialistTypeDisplay = specialistType.charAt(0).toUpperCase() + specialistType.slice(1);
            availableDice.specialist = 'used';
            totalDiceUsed++;
            gameState.heir.pendingCharacters.push(specialistType);
            instructions.push({
              type: 'action',
              step: 2,
              dieUsed: 'Specialist Die',
              text: `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Add the ${specialistTypeDisplay} disk <img src="assets/images/characters/${specialistType}.png" alt="${specialistTypeDisplay}" style="width: 24px; height: 24px; vertical-align: middle;"> next to the Heir's board</span></div>`,
              substeps: [
                'The new Character joins at the End Turn phase'
              ]
            });
          }
        }
      }
      
      // Step 3: Apprentice die (if <4 apprentices AND ‚â§5 total chars for base game)
      // Note: Can only use if Apprentice die shows Apprentice, not X
      // Without Academy, limit is 5 characters; with Academy it's 6
      const apprenticeCount = getHeirApprenticeCount();
      const totalChars = getHeirTotalCharacterCount();
      const charLimit = gameState.expansions.academy ? 6 : 5;
      if (canUseDie() && apprenticeCount < 4 && totalChars <= charLimit) {
        // Check if apprentice die shows apprentice (not X or used)
        if (availableDice.apprentice === 'apprentice') {
          availableDice.apprentice = 'used';
          totalDiceUsed++;
          gameState.heir.pendingCharacters.push('apprentice');
          instructions.push({
            type: 'action',
            step: 3,
            dieUsed: 'Apprentice Die',
            text: `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Add an Apprentice disk <img src="assets/images/characters/apprentice.png" alt="Apprentice" style="width: 24px; height: 24px; vertical-align: middle;"> next to the Heir's board</span></div>`,
            substeps: [
              'The new Character joins at the End Turn phase',
              `<em>Heir currently has ${apprenticeCount} Apprentice(s), ${totalChars} total Characters (limit: ${charLimit})</em>`
            ]
          });
        }
      }
      
      // Step 4: Higher valued Bank die
      if (canUseDie()) {
        // Find the higher value bank die
        let bankValue1 = availableDice.bank1 === 'x' || availableDice.bank1 === 'used' ? 0 : parseInt(availableDice.bank1);
        let bankValue2 = availableDice.bank2 === 'x' || availableDice.bank2 === 'used' ? 0 : parseInt(availableDice.bank2);
        
        let bankDieUsed = null;
        let coinValue = 0;
        let baseCoinValue = 0;
        
        if (bankValue1 >= bankValue2 && bankValue1 > 0) {
          bankDieUsed = 'Bank Die 1';
          baseCoinValue = bankValue1;
          availableDice.bank1 = 'used';
        } else if (bankValue2 > 0) {
          bankDieUsed = 'Bank Die 2';
          baseCoinValue = bankValue2;
          availableDice.bank2 = 'used';
        }
        
        if (bankDieUsed) {
          totalDiceUsed++;
          // Apply p02 (Double Coins)
          coinValue = isDoubleCoins ? baseCoinValue * 2 : baseCoinValue;
          gameState.heir.coins += coinValue;
          const p02Text = isDoubleCoins ? ` <strong style="color: var(--amber);">(doubled from ${baseCoinValue} ‚Äî p02)</strong>` : '';
          instructions.push({
            type: 'action',
            step: 4,
            dieUsed: bankDieUsed,
            text: `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Add ${coinValue} Coins to the Heir's Coin Purse${p02Text}</span></div>`
          });
        }
      }
      
      // Step 5: Other Bank die
      if (canUseDie()) {
        let bankValue1 = availableDice.bank1 === 'x' || availableDice.bank1 === 'used' ? 0 : parseInt(availableDice.bank1);
        let bankValue2 = availableDice.bank2 === 'x' || availableDice.bank2 === 'used' ? 0 : parseInt(availableDice.bank2);
        
        let bankDieUsed = null;
        let coinValue = 0;
        let baseCoinValue = 0;
        
        if (bankValue1 > 0) {
          bankDieUsed = 'Bank Die 1';
          baseCoinValue = bankValue1;
          availableDice.bank1 = 'used';
        } else if (bankValue2 > 0) {
          bankDieUsed = 'Bank Die 2';
          baseCoinValue = bankValue2;
          availableDice.bank2 = 'used';
        }
        
        if (bankDieUsed) {
          totalDiceUsed++;
          // Apply p02 (Double Coins)
          coinValue = isDoubleCoins ? baseCoinValue * 2 : baseCoinValue;
          gameState.heir.coins += coinValue;
          const p02Text = isDoubleCoins ? ` <strong style="color: var(--amber);">(doubled from ${baseCoinValue} ‚Äî p02)</strong>` : '';
          instructions.push({
            type: 'action',
            step: 5,
            dieUsed: bankDieUsed,
            text: `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Add ${coinValue} Coins to the Heir's Coin Purse${p02Text}</span></div>`
          });
        }
      }
      
      // Step 6: Second Apprentice check (if <4 apprentices, regardless of total chars)
      // Note: Can only use if Apprentice die shows Apprentice, not X
      if (canUseDie() && apprenticeCount < 4) {
        // Check if apprentice die shows apprentice (not X or used)
        if (availableDice.apprentice === 'apprentice') {
          availableDice.apprentice = 'used';
          totalDiceUsed++;
          gameState.heir.pendingCharacters.push('apprentice');
          instructions.push({
            type: 'action',
            step: 6,
            dieUsed: 'Apprentice Die',
            text: `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Add an Apprentice disk <img src="assets/images/characters/apprentice.png" alt="Apprentice" style="width: 24px; height: 24px; vertical-align: middle;"> next to the Heir's board</span></div>`,
            substeps: [
              'The new Character joins at the End Turn phase'
            ]
          });
        }
      }
      
      // Summary if no actions were taken
      if (totalDiceUsed === 0) {
        instructions.push({
          type: 'info',
          text: `No applicable actions for the Heir with the available dice.`
        });
      } else if (totalDiceUsed < diceCount) {
        instructions.push({
          type: 'info',
          text: `<em>Heir used ${totalDiceUsed} of ${diceCount} available dice (no more applicable actions).</em>`
        });
      }
      
      // Update persistent dice state - convert 'used' to 'x'
      gameState.downtownDice = {
        trick1: availableDice.trick1 === 'used' ? 'x' : availableDice.trick1,
        trick2: availableDice.trick2 === 'used' ? 'x' : availableDice.trick2,
        apprentice: availableDice.apprentice === 'used' ? 'x' : availableDice.apprentice,
        specialist: availableDice.specialist === 'used' ? 'x' : availableDice.specialist,
        bank1: availableDice.bank1 === 'used' ? 'x' : availableDice.bank1,
        bank2: availableDice.bank2 === 'used' ? 'x' : availableDice.bank2
      };
      
      return instructions;
    }

    function formatDowntownInstructions(instructions) {
      let html = '';
      
      for (const inst of instructions) {
        if (inst.type === 'info') {
          html += `<p style="margin-bottom: 15px;">${inst.text}</p>`;
        } else if (inst.type === 'action') {
          html += `<div class="downtown-action" style="background: var(--bg-card); border: 1px solid var(--border); padding: 12px 15px; margin-bottom: 12px; border-radius: 6px;">`;
          html += `<div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Step ${inst.step}</div>`;
          
          // Physical board action highlight
          html += `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin-bottom: 10px; border-radius: 0 4px 4px 0;">`;
          html += `<span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> `;
          html += `<span style="color: var(--text-primary);">Set <strong>${inst.dieUsed}</strong> to X</span>`;
          html += `</div>`;
          
          // The result/effect (strip out the "Set X to X." from the text since we show it above now)
          const cleanedText = inst.text.replace(/<strong>Set [^<]+ to X\.<\/strong>\s*/i, '');
          html += `<div style="color: var(--text-secondary);">${cleanedText}</div>`;
          
          if (inst.substeps && inst.substeps.length > 0) {
            html += `<ul style="margin-top: 8px; margin-bottom: 0; padding-left: 20px; color: var(--text-muted); font-size: 0.95rem;">`;
            for (const sub of inst.substeps) {
              html += `<li style="margin-bottom: 4px;">${sub}</li>`;
            }
            html += `</ul>`;
          }
          html += `</div>`;
        } else if (inst.type === 'warning') {
          html += `<p style="color: var(--warning); font-style: italic; margin-bottom: 12px;">‚ö† ${inst.text}</p>`;
        }
      }
      
      return html;
    }

    // ============================================
    // GAME STATE
    // ============================================

    let gameState = {
      // Setup
      expansions: {
        academy: false,
        dawn: false,
        arcane: false,
        dawnChallengeRule: false
      },
      difficulty: null,
      playerSchool: null,
      playerMagician: null,
      heirMagician: null,
      startingSpecialists: [], // ['engineer', 'manager'] etc - assigned when difficulty selected
      
      // Game progress
      currentTurn: 1,
      currentPhaseIndex: 0,
      
      // Prophecy system
      activeProphecy: null, // Set at start of Turn 2+ after dice roll or Dark Alley rotation
      
      // Performance phase tracking
      performanceOrder: null, // 'heir-first' or 'player-first', set during Performance phase
      
      // Heir state
      heir: {
        fame: 5,
        coins: 0,
        shards: 0,
        stance: null, // null until Assignment phase, then 'defensive', 'neutral', or 'aggressive'
        characters: [], // ['magician', 'engineer', 'apprentice', ...]
        tricks: [], // [{ ...trickData, markers: X }, ...]
        shoppingList: [], // ['Metal', 'Wood', ...]
        specialAssignments: { theater: 0, downtown: 0, market: 0, workshop: 0 },
        pendingCharacters: [] // Characters hired this turn, join at end of turn
      },
      
      // Player state (for tracking tricks)
      player: {
        tricks: [] // [{ ...trickData }, ...]
      },
      
      // Downtown dice state (persists within a turn)
      downtownDice: {
        trick1: 'x',
        trick2: 'x',
        apprentice: 'x',
        specialist: 'x',
        bank1: 'x',
        bank2: 'x'
      },
      
      // Plan deck (simplified for now)
      planDeck: [],
      currentPlanCard: null
    };

    // ============================================
    // UI HELPERS
    // ============================================

    function $(selector) {
      return document.querySelector(selector);
    }

    function $$(selector) {
      return document.querySelectorAll(selector);
    }

    function showScreen(screenId) {
      $$('.screen').forEach(s => s.classList.remove('active'));
      $(`#${screenId}`).classList.add('active');
    }

    function updateSetupButton() {
      const btn = $('#start-game-btn');
      if (!btn) return;
      const canStart = gameState.difficulty && gameState.playerSchool && gameState.playerMagician && gameState.heirMagician && gameState.heir.tricks.length > 0;
      btn.disabled = !canStart;
    }

    // SVG icons for each school
    function getSchoolIcon(school) {
      const icons = {
        mechanical: `<svg class="school-icon" viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="24" cy="24" r="14" />
          <circle cx="24" cy="24" r="6" />
          <path d="M24 4 L24 10 M24 38 L24 44" />
          <path d="M4 24 L10 24 M38 24 L44 24" />
          <path d="M9.86 9.86 L14.1 14.1 M33.9 33.9 L38.14 38.14" />
          <path d="M38.14 9.86 L33.9 14.1 M14.1 33.9 L9.86 38.14" />
          <circle cx="24" cy="10" r="2" fill="currentColor" />
          <circle cx="24" cy="38" r="2" fill="currentColor" />
          <circle cx="10" cy="24" r="2" fill="currentColor" />
          <circle cx="38" cy="24" r="2" fill="currentColor" />
        </svg>`,
        optical: `<svg class="school-icon" viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5">
          <ellipse cx="24" cy="24" rx="20" ry="12" />
          <circle cx="24" cy="24" r="7" />
          <circle cx="24" cy="24" r="3" fill="currentColor" />
          <path d="M4 24 Q12 20, 17 24" />
          <path d="M44 24 Q36 20, 31 24" />
          <path d="M20 14 Q24 12, 28 14" />
          <path d="M20 34 Q24 36, 28 34" />
        </svg>`,
        escape: `<svg class="school-icon" viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5">
          <ellipse cx="14" cy="16" rx="8" ry="10" />
          <ellipse cx="24" cy="24" rx="8" ry="10" />
          <ellipse cx="34" cy="32" rx="8" ry="10" />
          <path d="M14 6 L14 10 M14 22 L14 26" stroke-width="2" />
          <path d="M24 14 L24 18 M24 30 L24 34" stroke-width="2" />
          <path d="M34 22 L34 26 M34 38 L34 42" stroke-width="2" />
        </svg>`,
        spiritual: `<svg class="school-icon" viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M24 4 Q32 12, 32 20 Q32 28, 24 32 Q16 28, 16 20 Q16 12, 24 4" />
          <circle cx="24" cy="18" r="4" />
          <path d="M20 26 Q24 30, 28 26" />
          <path d="M24 32 L24 44" stroke-width="2" />
          <path d="M18 38 L30 38" />
          <path d="M12 8 Q8 12, 10 18" />
          <path d="M36 8 Q40 12, 38 18" />
          <circle cx="10" cy="10" r="2" fill="currentColor" />
          <circle cx="38" cy="10" r="2" fill="currentColor" />
        </svg>`
      };
      return icons[school] || '';
    }

    // Magicians whose solo abilities require Academy expansion
    const ACADEMY_REQUIRED_MAGICIANS = ['geert', 'lumenia', 'bernard', 'anjali'];
    
    function populateHeirMagicianOptions() {
      const container = $('#heir-magician-options');
      container.innerHTML = '';
      
      if (!gameState.playerSchool) {
        container.innerHTML = '<p class="empty-state">Select your school first</p>';
        return;
      }

      // Get all magicians except those from player's school
      Object.entries(MAGICIANS).forEach(([school, magicians]) => {
        if (school === gameState.playerSchool) return;
        
        magicians.forEach(mag => {
          const requiresAcademy = ACADEMY_REQUIRED_MAGICIANS.includes(mag.id);
          const card = document.createElement('div');
          card.className = 'option-card' + (requiresAcademy ? ' disabled' : '');
          card.dataset.school = school;
          card.dataset.magician = mag.id;
          
          if (requiresAcademy) {
            card.innerHTML = `
              ${getSchoolIcon(school)}
              <div class="title" style="color: var(--text-muted);">${mag.name}</div>
              <div class="description" style="color: var(--text-muted);"><em>Requires Academy expansion</em></div>
            `;
            card.style.opacity = '0.5';
            card.style.cursor = 'not-allowed';
          } else {
            card.innerHTML = `
              ${getSchoolIcon(school)}
              <div class="title">${mag.name}</div>
              <div class="description">${school.charAt(0).toUpperCase() + school.slice(1)} School</div>
            `;
            card.addEventListener('click', () => selectHeirMagician(mag, school));
          }
          container.appendChild(card);
        });
      });
    }

    function populateStartingTrickOptions() {
      const container = $('#starting-trick-options');
      const instructionEl = $('#heir-trick-instruction');
      
      if (!container) return;
      container.innerHTML = '';
      
      if (!gameState.heirMagician) {
        container.innerHTML = '<p class="empty-state">Select Heir\'s Magician first</p>';
        return;
      }

      const school = gameState.heirMagician.school;
      const eligibleTricks = getEligibleStartingTricks(school);
      
      // Update instruction text
      if (instructionEl) {
        instructionEl.textContent = `Shuffle the following ${eligibleTricks.length} Level 1 Tricks from the Heir's Favorite category (excluding the one requiring only 2 Basic Components of the same type). Draw one randomly:`;
      }
      
      // Populate trick options
      eligibleTricks.forEach(trick => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.dataset.school = school;
        card.dataset.trick = trick.id;
        card.innerHTML = `
          <div class="title">${trick.name}</div>
          <div class="description">${formatComponents(trick.components)}<br>${trick.markers} markers when prepared</div>
        `;
        card.addEventListener('click', () => selectStartingTrick(trick, school));
        container.appendChild(card);
      });
    }

    function updateSetupSummary() {
      const container = $('#setup-summary');
      const list = $('#setup-instructions');
      
      // In new wizard, setup-summary doesn't exist
      if (!container || !list) return;
      
      if (!gameState.difficulty || !gameState.playerMagician || !gameState.heirMagician || gameState.heir.tricks.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      const diff = DIFFICULTY_SETTINGS[gameState.difficulty];
      const trick = gameState.heir.tricks[0];
      const shoppingListDisplay = getUniqueComponentTypes(trick.components).join(', ');
      
      // Build starting characters list in correct order
      const startingChars = ['magician'];
      gameState.startingSpecialists.forEach(s => startingChars.push(s));
      for (let i = 0; i < diff.characters.apprentices; i++) {
        startingChars.push('apprentice');
      }
      
      // Sort in correct board order
      const sortOrder = { 'magician': 0, 'engineer': 1, 'manager': 2, 'assistant': 3, 'apprentice': 4 };
      startingChars.sort((a, b) => sortOrder[a] - sortOrder[b]);
      
      // Build character icons display
      const characterOrderIcons = startingChars.map(char => {
        return `<img src="assets/images/characters/${char}.png" alt="${char}" style="width: 28px; height: 28px; vertical-align: middle;">`;
      }).join(' ‚Üí ');
      
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      
      // Check for Elektra's marker reduction
      const isElektra = gameState.heirMagician?.id === 'elektra';
      let trickMarkers = trick.markers;
      let elektraNote = '';
      
      if (isElektra && trick.markers >= 2) {
        trickMarkers = trick.markers - 1;
        elektraNote = magicianAbilityBox(`<strong>Elektra:</strong> Tricks with 2-3 markers start with <strong>1 less marker</strong>. This trick starts with ${trickMarkers} instead of ${trick.markers}. However, all Yields are <strong>+1/+2/+3</strong> based on Trick Level.`);
      }
      
      list.innerHTML = `
        <li>Set up for a 2-player game with the Dark Alley</li>
        <li>Set up the Heir's board
          ${boardAction('Place the Heir\'s board (5-character side) near your play area')}
        </li>
        <li>The Heir gets: ${diff.description}
          ${boardAction(`Place the Heir's Character disks on the board in this order:`)}
          <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
            <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è Heir board order:</span>
            <div style="margin-top: 6px;">${characterOrderIcons}</div>
          </div>
        </li>
        <li>The Heir's Magician is <strong>${gameState.heirMagician.name}</strong> (${gameState.heirMagician.school} school)
          ${boardAction(`Take the ${gameState.heirMagician.name} Magician Poster and place it near the Heir's board`)}
        </li>
        <li>Starting Trick: <strong>${trick.name}</strong>
          ${boardAction(`Place ${trick.name} card on Heir's leftmost trick slot with ${trickMarkers} Trick marker(s). It starts Prepared.`)}
          ${elektraNote}
        </li>
        <li>Shopping List components: <strong>${shoppingListDisplay}</strong>
          ${boardAction(`Place one of each component type in the Heir's Shopping List box: ${shoppingListDisplay}`)}
        </li>
        <li>Set the Heir's starting Fame
          ${boardAction('Place the Heir\'s Fame marker on <strong>5</strong> on the Fame track')}
        </li>
        <li>You are first in Initiative Order (start with 10 Coins)</li>
        <li>The Heir starts with <strong>5 Fame</strong>, 0 Coins and 0 Shards</li>
        <li>Remove certain Prophecies before setting up (see solo rulebook p.4, step 13)</li>
        <li>Create the Heir's Plan deck as described in the rulebook</li>
      `;
    }

    // ============================================
    // SETUP WIZARD NAVIGATION
    // ============================================
    
    let currentSetupPage = 0;
    let setupMode = 'full'; // 'full' or 'quick'
    
    function showSetupPage(pageNum) {
      // Hide all pages
      $$('.setup-page').forEach(page => page.classList.add('hidden'));
      
      // Handle 'quick' as a special page
      if (pageNum === 'quick') {
        const quickPage = $('#setup-page-quick');
        if (quickPage) {
          quickPage.classList.remove('hidden');
          currentSetupPage = 'quick';
        }
      } else {
        // Show target page
        const targetPage = $(`#setup-page-${pageNum}`);
        if (targetPage) {
          targetPage.classList.remove('hidden');
          currentSetupPage = pageNum;
          
          // Update dynamic content based on page
          updateSetupPageContent(pageNum);
        }
      }
      
      // Scroll to top
      window.scrollTo(0, 0);
    }
    
    function updateSetupPageContent(pageNum) {
      // Update dynamic content on certain pages
      if (pageNum === 2) {
        // Update DoT notes based on expansion selection
        const dotTricksNote = $('#dot-tricks-note-text');
        const dotSANote = $('#dot-sa-note-text');
        
        if (gameState.expansions.dawn) {
          // DoT is selected - include the content
          if (dotTricksNote) dotTricksNote.textContent = 'Include the Dawn of Technology Signature Tricks (3 per category)';
          if (dotSANote) dotSANote.textContent = 'Remove Academy Special Assignment cards (keep Dawn of Technology SA cards)';
        } else {
          // Base game - exclude DoT content
          if (dotTricksNote) dotTricksNote.textContent = 'Leave the Dawn of Technology tricks in the box (3 per category)';
          if (dotSANote) dotSANote.textContent = 'Remove Academy and Dawn of Technology Special Assignment cards';
        }
      }
      
      if (pageNum === 6) {
        // Filter heir school options - disable player's school (solo rule p.3, point 4)
        updateHeirSchoolOptions();
      }
      
      if (pageNum === 7) {
        // Update heir magician card name and poster name
        const magicianCardName = $('#heir-magician-card-name');
        if (magicianCardName && gameState.heirMagician) {
          magicianCardName.textContent = gameState.heirMagician.name;
        }
        const posterName = $('#heir-poster-name');
        if (posterName && gameState.heirMagician) {
          posterName.textContent = gameState.heirMagician.name;
        }
      }
      
      if (pageNum === 9) {
        // Update heir character order display
        updateHeirCharacterOrder();
      }
      
      if (pageNum === 11) {
        // Update trick placement and shopping list
        updateFinalHeirSetup();
      }
    }
    
    // ============================================
    // SETUP MODE FUNCTIONS
    // ============================================
    
    function startFullSetup() {
      setupMode = 'full';
      showSetupPage(1);
    }
    
    function startQuickSetup() {
      setupMode = 'quick';
      showSetupPage('quick');
    }
    
    // Quick Setup selection handlers
    function quickSelectPlayerSchool(school) {
      gameState.playerSchool = school;
      gameState.playerMagician = null;
      
      $$('#quick-player-school-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#quick-player-school-options .option-card[data-school="${school}"]`).classList.add('selected');
      
      // Show magician section
      const section = $('#quick-player-magician-section');
      if (section) section.style.display = 'block';
      
      // Populate magician options
      populateQuickPlayerMagicianOptions();
      
      // Update heir school options - disable player's school (solo rule p.3, point 4)
      updateQuickHeirSchoolOptions();
      
      updateQuickSetupSummary();
    }
    
    // Update heir school options in Quick Setup - disable player's school
    function updateQuickHeirSchoolOptions() {
      const playerSchool = gameState.playerSchool;
      $$('#quick-heir-school-options .option-card').forEach(card => {
        const school = card.dataset.school;
        if (school === playerSchool) {
          card.classList.add('disabled');
          card.style.opacity = '0.4';
          card.style.pointerEvents = 'none';
          card.title = 'Cannot select - same as your school';
        } else {
          card.classList.remove('disabled');
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
          card.title = '';
        }
      });
      
      // If current heir school selection is now invalid, clear it
      if (gameState.heirSchool === playerSchool) {
        gameState.heirSchool = null;
        gameState.heirMagician = null;
        $$('#quick-heir-school-options .option-card').forEach(c => c.classList.remove('selected'));
        const magicianSection = $('#quick-heir-magician-section');
        if (magicianSection) magicianSection.style.display = 'none';
      }
    }
    
    function quickSelectPlayerMagician(magician) {
      gameState.playerMagician = { ...magician, school: gameState.playerSchool };
      
      $$('#quick-player-magician-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#quick-player-magician-options .option-card[data-magician="${magician.id}"]`).classList.add('selected');
      
      updateQuickSetupSummary();
    }
    
    function quickSelectHeirSchool(school) {
      gameState.heirSchool = school;
      gameState.heirMagician = null;
      gameState.heir.tricks = [];
      
      $$('#quick-heir-school-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#quick-heir-school-options .option-card[data-school="${school}"]`).classList.add('selected');
      
      // Show magician section
      const section = $('#quick-heir-magician-section');
      if (section) section.style.display = 'block';
      
      // Populate magician options
      populateQuickHeirMagicianOptions(school);
      
      // Hide trick section until magician selected
      const trickSection = $('#quick-trick-section');
      if (trickSection) trickSection.style.display = 'none';
      
      updateQuickSetupSummary();
    }
    
    function quickSelectHeirMagician(magician, school) {
      gameState.heirMagician = { ...magician, school };
      gameState.heir.tricks = [];
      
      $$('#quick-heir-magician-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#quick-heir-magician-options .option-card[data-magician="${magician.id}"]`).classList.add('selected');
      
      // Show trick section
      const section = $('#quick-trick-section');
      if (section) section.style.display = 'block';
      
      // Enable randomize trick button
      const btn = $('#quick-randomize-trick-btn');
      if (btn) btn.disabled = false;
      
      // Populate trick options
      populateQuickStartingTrickOptions();
      updateQuickSetupSummary();
    }
    
    function quickSelectDifficulty(difficulty) {
      gameState.difficulty = difficulty;
      
      // Randomly assign starting specialist type(s)
      const diff = DIFFICULTY_SETTINGS[difficulty];
      const specialistTypes = ['engineer', 'manager', 'assistant'];
      const shuffledTypes = [...specialistTypes].sort(() => Math.random() - 0.5);
      gameState.startingSpecialists = shuffledTypes.slice(0, diff.characters.specialists);
      
      $$('#quick-difficulty-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#quick-difficulty-options .option-card[data-difficulty="${difficulty}"]`).classList.add('selected');
      
      updateQuickSetupSummary();
    }
    
    function quickSelectStartingTrick(trick, school) {
      const trickWithState = {
        ...trick,
        school,
        currentMarkers: trick.markers,
        level: 1
      };
      
      gameState.heir.tricks = [trickWithState];
      gameState.heir.shoppingList = getUniqueComponentTypes(trick.components);
      
      $$('#quick-starting-trick-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#quick-starting-trick-options .option-card[data-trick="${trick.id}"]`).classList.add('selected');
      
      updateQuickSetupSummary();
    }
    
    function quickRandomizeHeir() {
      // Exclude player's school from random selection (solo rule p.3, point 4)
      const schools = ['mechanical', 'spiritual', 'escape', 'optical'].filter(s => s !== gameState.playerSchool);
      const randomSchool = schools[Math.floor(Math.random() * schools.length)];
      quickSelectHeirSchool(randomSchool);
      
      // Also randomly select a magician
      setTimeout(() => {
        const magicians = MAGICIANS[randomSchool].filter(
          mag => !ACADEMY_REQUIRED_MAGICIANS.includes(mag.id)
        );
        const randomMagician = magicians[Math.floor(Math.random() * magicians.length)];
        quickSelectHeirMagician(randomMagician, randomSchool);
      }, 50);
    }
    
    function quickRandomizeTrick() {
      if (!gameState.heirMagician) return;
      
      const school = gameState.heirMagician.school;
      const allEligibleTricks = getEligibleStartingTricks(school);
      
      // Check which trick (if any) the player took with Engineer
      const selectedRadio = $('input[name="quick-engineer-took-trick"]:checked');
      const takenTrickId = selectedRadio ? selectedRadio.value : 'none';
      
      // Filter out the taken trick
      const availableTricks = takenTrickId === 'none' 
        ? allEligibleTricks 
        : allEligibleTricks.filter(t => t.id !== takenTrickId);
      
      if (availableTricks.length === 0) return;
      
      const randomTrick = availableTricks[Math.floor(Math.random() * availableTricks.length)];
      quickSelectStartingTrick(randomTrick, school);
    }
    
    // Quick Setup populate functions
    function populateQuickPlayerMagicianOptions() {
      const container = $('#quick-player-magician-options');
      if (!container || !gameState.playerSchool) return;
      container.innerHTML = '';
      
      const magicians = MAGICIANS[gameState.playerSchool].filter(
        mag => !ACADEMY_REQUIRED_MAGICIANS.includes(mag.id)
      );
      
      const schoolColors = {
        mechanical: 'var(--mechanical)',
        optical: 'var(--optical)',
        escape: 'var(--escape)',
        spiritual: 'var(--spiritual)'
      };
      const color = schoolColors[gameState.playerSchool];
      
      magicians.forEach(magician => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.dataset.magician = magician.id;
        card.innerHTML = `
          <div class="title" style="color: ${color};">${magician.name}</div>
          <div class="description" style="font-size: 0.8rem;">${magician.ability}</div>
        `;
        card.addEventListener('click', () => quickSelectPlayerMagician(magician));
        container.appendChild(card);
      });
    }
    
    function populateQuickHeirMagicianOptions(school) {
      const container = $('#quick-heir-magician-options');
      if (!container) return;
      container.innerHTML = '';
      
      const magicians = MAGICIANS[school].filter(
        mag => !ACADEMY_REQUIRED_MAGICIANS.includes(mag.id)
      );
      
      const schoolColors = {
        mechanical: 'var(--mechanical)',
        optical: 'var(--optical)',
        escape: 'var(--escape)',
        spiritual: 'var(--spiritual)'
      };
      const color = schoolColors[school];
      
      magicians.forEach(mag => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.dataset.magician = mag.id;
        card.innerHTML = `
          <div class="title" style="color: ${color};">${mag.name}</div>
          <div class="description" style="font-size: 0.8rem;">${mag.soloAbility || ''}</div>
        `;
        card.addEventListener('click', () => quickSelectHeirMagician(mag, school));
        container.appendChild(card);
      });
    }
    
    function populateQuickStartingTrickOptions() {
      const container = $('#quick-starting-trick-options');
      const instructionEl = $('#quick-heir-trick-instruction');
      
      if (!container || !gameState.heirMagician) return;
      container.innerHTML = '';
      
      const school = gameState.heirMagician.school;
      const eligibleTricks = getEligibleStartingTricks(school);
      
      // Update instruction text
      if (instructionEl) {
        instructionEl.textContent = `Select one of the ${eligibleTricks.length} eligible Level 1 tricks:`;
      }
      
      // Populate trick options
      eligibleTricks.forEach(trick => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.dataset.trick = trick.id;
        card.innerHTML = `
          <div class="title">${trick.name}</div>
          <div class="description">${formatComponents(trick.components)}<br>${trick.markers} markers</div>
        `;
        card.addEventListener('click', () => quickSelectStartingTrick(trick, school));
        container.appendChild(card);
      });
    }
    
    function updateQuickSetupSummary() {
      const summary = $('#quick-setup-summary');
      const content = $('#quick-summary-content');
      const beginBtn = $('#quick-start-game-btn');
      
      // Check if all selections are made
      const canStart = gameState.difficulty && 
                       gameState.playerSchool && 
                       gameState.playerMagician && 
                       gameState.heirMagician && 
                       gameState.heir.tricks.length > 0;
      
      if (beginBtn) beginBtn.disabled = !canStart;
      
      if (!canStart || !summary || !content) {
        if (summary) summary.style.display = 'none';
        return;
      }
      
      summary.style.display = 'block';
      
      // Build character order display
      const diff = DIFFICULTY_SETTINGS[gameState.difficulty];
      const chars = ['magician'];
      gameState.startingSpecialists.forEach(s => chars.push(s));
      for (let i = 0; i < diff.characters.apprentices; i++) {
        chars.push('apprentice');
      }
      
      const characterIcons = chars.map(char => {
        return `<img src="assets/images/characters/${char}.png" alt="${char}" title="${char.charAt(0).toUpperCase() + char.slice(1)}" style="width: 28px; height: 28px; vertical-align: middle;">`;
      }).join(' ‚Üí ');
      
      const characterNames = chars.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(' ‚Üí ');
      
      // Get trick info
      const trick = gameState.heir.tricks[0];
      const isElektra = gameState.heirMagician?.id === 'elektra';
      let trickMarkers = trick.markers;
      let elektraNote = '';
      
      if (isElektra && trick.markers >= 2) {
        trickMarkers = trick.markers - 1;
        elektraNote = `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> <strong>Elektra:</strong> This trick starts with ${trickMarkers} marker(s) instead of ${trick.markers}.</div>`;
      }
      
      const shoppingList = gameState.heir.shoppingList.join(', ');
      
      content.innerHTML = `
        <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Heir's Poster: <strong>${gameState.heirMagician.name}</strong></span></div>
        
        <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Heir's Characters (left to right):</span></div>
        <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
          <div style="margin-bottom: 6px;">${characterIcons}</div>
          <div style="color: var(--text-secondary); font-size: 0.85rem;">${characterNames}</div>
        </div>
        
        <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Heir's Trick: <strong>${trick.name}</strong> with <strong>${trickMarkers} Trick marker(s)</strong> (Prepared)</span></div>
        ${elektraNote}
        
        <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> If you chose the Engineer as your specialist, choose a Level 1 Trick and place it on the Engineer's Board Extension. Mark it with a Symbol Marker.</div>
        
        <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Shopping List: <strong>${shoppingList}</strong></span></div>
      `;
    }
    
    function updateHeirCharacterOrder() {
      const container = $('#heir-character-order');
      const specialistNote = $('#heir-specialist-note');
      if (!container || !gameState.difficulty) return;
      
      const diff = DIFFICULTY_SETTINGS[gameState.difficulty];
      const chars = ['magician'];
      
      // Add specific specialist types from gameState
      gameState.startingSpecialists.forEach(specialistType => {
        chars.push(specialistType); // 'engineer', 'manager', or 'assistant'
      });
      
      // Add apprentices
      for (let i = 0; i < diff.characters.apprentices; i++) {
        chars.push('apprentice');
      }
      
      // Create icon display - now using actual types, no mapping needed
      const iconsHtml = chars.map(char => {
        const label = char.charAt(0).toUpperCase() + char.slice(1);
        return `<img src="assets/images/characters/${char}.png" alt="${label}" title="${label}" style="width: 32px; height: 32px; vertical-align: middle;">`;
      }).join(' ‚Üí ');
      
      container.innerHTML = iconsHtml;
      
      // Populate specialist note
      if (specialistNote && gameState.startingSpecialists.length > 0) {
        const specialistNames = gameState.startingSpecialists.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ');
        const plural = gameState.startingSpecialists.length > 1 ? 's' : '';
        specialistNote.innerHTML = `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> The app randomly selected the Heir's specialist${plural}: <strong>${specialistNames}</strong></div>`;
      }
    }
    
    function updateFinalHeirSetup() {
      // Update starting shards display based on DoT expansion
      const shardText = $('#heir-starting-shards');
      if (shardText) {
        shardText.textContent = gameState.expansions.dawn ? '1 Shard' : '0 Shards';
      }
      
      const trickContainer = $('#heir-trick-placement');
      const shoppingContainer = $('#setup-heir-shopping-list');
      
      if (!trickContainer || !shoppingContainer || gameState.heir.tricks.length === 0) return;
      
      const trick = gameState.heir.tricks[0];
      const isElektra = gameState.heirMagician?.id === 'elektra';
      let markers = trick.markers;
      
      let elektraNote = '';
      if (isElektra && trick.markers >= 2) {
        markers = trick.markers - 1;
        elektraNote = `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> <strong>Elektra:</strong> Tricks with 2-3 markers start with 1 fewer marker. This trick starts with ${markers} instead of ${trick.markers}.</div>`;
      }
      
      trickContainer.innerHTML = `
        <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place <strong>${trick.name}</strong> on the leftmost Trick slot of the Heir's board with <strong>${markers} Trick marker(s)</strong> ‚Äî it starts <strong>Prepared</strong></span></div>
        ${elektraNote}
        <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> If you chose the Engineer as your specialist, choose a Level 1 Trick and place it on the Engineer's Board Extension. Mark it with a Symbol Marker.</div>
      `;
      
      const components = Object.keys(trick.components).map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(', ');
      shoppingContainer.innerHTML = `
        <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place one of each Component type in the Heir's Shopping List: <strong>${components}</strong></span></div>
        <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Place the Turn Setup markers on the Heir's board</span></div>
      `;
    }

    // ============================================
    // SETUP HANDLERS
    // ============================================

    function selectDifficulty(difficulty) {
      gameState.difficulty = difficulty;
      
      // Randomly assign starting specialist type(s)
      const diff = DIFFICULTY_SETTINGS[difficulty];
      const specialistTypes = ['engineer', 'manager', 'assistant'];
      const shuffledTypes = [...specialistTypes].sort(() => Math.random() - 0.5);
      gameState.startingSpecialists = shuffledTypes.slice(0, diff.characters.specialists);
      
      $$('#difficulty-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#difficulty-options .option-card[data-difficulty="${difficulty}"]`).classList.add('selected');
      
      // Enable continue button for page 8
      const continueBtn = $('#page8-continue');
      if (continueBtn) continueBtn.disabled = false;
      
      updateSetupButton();
      updateSetupSummary();
    }

    function selectPlayerSchool(school) {
      gameState.playerSchool = school;
      gameState.playerMagician = null;
      
      $$('#player-school-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#player-school-options .option-card[data-school="${school}"]`).classList.add('selected');
      
      // Show player magician section
      const magicianSection = $('#player-magician-section');
      if (magicianSection) magicianSection.style.display = 'block';
      
      // Populate player magician options for the selected school
      populatePlayerMagicianOptions();
      
      // Disable continue until magician is selected
      const continueBtn = $('#page4-continue');
      if (continueBtn) continueBtn.disabled = true;
      
      updateRandomizeButtons();
      updateSetupButton();
    }

    function selectHeirMagician(magician, school) {
      gameState.heirMagician = { ...magician, school };
      gameState.heir.tricks = [];
      
      $$('#heir-magician-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#heir-magician-options .option-card[data-magician="${magician.id}"]`).classList.add('selected');
      
      // Enable continue button for page 6
      const continueBtn = $('#page6-continue');
      if (continueBtn) continueBtn.disabled = false;
      
      populateStartingTrickOptions();
      updateRandomizeButtons();
      updateSetupButton();
      updateSetupSummary();
    }

    // Update heir school options - disable player's school (solo rule p.3, point 4: Heir cannot choose same school as player)
    function updateHeirSchoolOptions() {
      const playerSchool = gameState.playerSchool;
      $$('#heir-school-options .option-card').forEach(card => {
        const school = card.dataset.school;
        if (school === playerSchool) {
          card.classList.add('disabled');
          card.style.opacity = '0.4';
          card.style.pointerEvents = 'none';
          card.title = 'Cannot select - same as your school';
        } else {
          card.classList.remove('disabled');
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
          card.title = '';
        }
      });
      
      // If current heir school selection is now invalid, clear it
      if (gameState.heirSchool === playerSchool) {
        gameState.heirSchool = null;
        gameState.heirMagician = null;
        $$('#heir-school-options .option-card').forEach(c => c.classList.remove('selected'));
        const magicianSection = $('#heir-magician-section');
        if (magicianSection) magicianSection.style.display = 'none';
      }
    }

    function selectHeirSchool(school) {
      gameState.heirSchool = school;
      gameState.heirMagician = null;
      gameState.heir.tricks = [];
      
      $$('#heir-school-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#heir-school-options .option-card[data-school="${school}"]`).classList.add('selected');
      
      // Show heir magician section and populate options
      const magicianSection = $('#heir-magician-section');
      if (magicianSection) magicianSection.style.display = 'block';
      
      populateHeirMagicianOptionsForSchool(school);
      
      // Disable continue until magician is selected
      const continueBtn = $('#page6-continue');
      if (continueBtn) continueBtn.disabled = true;
      
      populateStartingTrickOptions();
      updateRandomizeButtons();
      updateSetupButton();
    }

    function randomizeHeirSchool() {
      // Exclude player's school from random selection (solo rule p.3, point 4)
      const schools = ['mechanical', 'spiritual', 'escape', 'optical'].filter(s => s !== gameState.playerSchool);
      const randomSchool = schools[Math.floor(Math.random() * schools.length)];
      selectHeirSchool(randomSchool);
      
      // Also randomly select a magician from that school
      setTimeout(() => {
        const magicians = MAGICIANS[randomSchool].filter(
          mag => !ACADEMY_REQUIRED_MAGICIANS.includes(mag.id)
        );
        const randomMagician = magicians[Math.floor(Math.random() * magicians.length)];
        selectHeirMagician(randomMagician, randomSchool);
      }, 100);
    }

    function populateHeirMagicianOptionsForSchool(school) {
      const container = $('#heir-magician-options');
      if (!container) return;
      container.innerHTML = '';
      
      const magicians = MAGICIANS[school].filter(
        mag => !ACADEMY_REQUIRED_MAGICIANS.includes(mag.id)
      );
      
      const schoolColors = {
        mechanical: 'var(--mechanical)',
        optical: 'var(--optical)',
        escape: 'var(--escape)',
        spiritual: 'var(--spiritual)'
      };
      const color = schoolColors[school];
      
      magicians.forEach(mag => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.dataset.magician = mag.id;
        card.innerHTML = `
          <div class="title" style="color: ${color};">${mag.name}</div>
          <div class="description">${mag.ability || ''}</div>
        `;
        card.addEventListener('click', () => selectHeirMagician(mag, school));
        container.appendChild(card);
      });
    }

    function populatePlayerMagicianOptions() {
      const container = $('#player-magician-options');
      if (!container) return;
      container.innerHTML = '';
      
      if (!gameState.playerSchool) {
        container.innerHTML = '<p class="empty-state">Select your school first</p>';
        return;
      }
      
      // Filter to only base game magicians (exclude Academy expansion)
      const magicians = MAGICIANS[gameState.playerSchool].filter(
        mag => !ACADEMY_REQUIRED_MAGICIANS.includes(mag.id)
      );
      
      const schoolColors = {
        mechanical: 'var(--mechanical)',
        optical: 'var(--optical)',
        escape: 'var(--escape)',
        spiritual: 'var(--spiritual)'
      };
      const color = schoolColors[gameState.playerSchool];
      
      magicians.forEach(magician => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.dataset.magician = magician.id;
        card.dataset.school = gameState.playerSchool;
        card.innerHTML = `
          <div class="title" style="color: ${color};">${magician.name}</div>
          <div class="description" style="font-size: 0.85rem; line-height: 1.4;">${magician.ability}</div>
        `;
        card.addEventListener('click', () => selectPlayerMagician(magician));
        container.appendChild(card);
      });
    }

    function selectPlayerMagician(magician) {
      gameState.playerMagician = { ...magician, school: gameState.playerSchool };
      
      $$('#player-magician-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#player-magician-options .option-card[data-magician="${magician.id}"]`).classList.add('selected');
      
      // Enable continue button for page 4
      const continueBtn = $('#page4-continue');
      if (continueBtn) continueBtn.disabled = false;
      
      updateSetupButton();
      updateSetupSummary();
    }

    function updateRandomizeButtons() {
      // Enable/disable randomize buttons based on available options
      const heirBtn = $('#randomize-heir-btn');
      const trickBtn = $('#randomize-trick-btn');
      
      // Heir button is always enabled (can randomize school + magician anytime)
      if (heirBtn) heirBtn.disabled = false;
      
      // Trick button enabled if heir magician is selected
      if (trickBtn) trickBtn.disabled = !gameState.heirMagician;
    }

    function randomizeHeirMagician() {
      if (!gameState.playerSchool) return;
      
      // Get all available magicians (not from player's school, and not requiring Academy)
      const availableMagicians = [];
      Object.entries(MAGICIANS).forEach(([school, magicians]) => {
        if (school !== gameState.playerSchool) {
          magicians.forEach(mag => {
            // Exclude magicians that require Academy expansion
            if (!ACADEMY_REQUIRED_MAGICIANS.includes(mag.id)) {
              availableMagicians.push({ ...mag, school });
            }
          });
        }
      });
      
      if (availableMagicians.length === 0) return;
      
      // Pick random magician
      const randomMag = availableMagicians[Math.floor(Math.random() * availableMagicians.length)];
      selectHeirMagician(randomMag, randomMag.school);
    }

    function randomizeStartingTrick() {
      if (!gameState.heirMagician) return;
      
      const school = gameState.heirMagician.school;
      const allEligibleTricks = getEligibleStartingTricks(school);
      
      // Check which trick (if any) the player took with Engineer
      const selectedRadio = $('input[name="engineer-took-trick"]:checked');
      const takenTrickId = selectedRadio ? selectedRadio.value : 'none';
      
      // Filter out the taken trick
      const availableTricks = takenTrickId === 'none' 
        ? allEligibleTricks 
        : allEligibleTricks.filter(t => t.id !== takenTrickId);
      
      if (availableTricks.length === 0) return;
      
      // Pick random trick
      const randomTrick = availableTricks[Math.floor(Math.random() * availableTricks.length)];
      selectStartingTrick(randomTrick, school);
    }

    function selectStartingTrick(trick, school) {
      const trickWithState = {
        ...trick,
        school,
        currentMarkers: trick.markers,
        level: 1
      };
      
      gameState.heir.tricks = [trickWithState];
      gameState.heir.shoppingList = getUniqueComponentTypes(trick.components);
      
      $$('#starting-trick-options .option-card').forEach(c => c.classList.remove('selected'));
      $(`#starting-trick-options .option-card[data-trick="${trick.id}"]`).classList.add('selected');
      
      // Enable continue button for page 10
      const continueBtn = $('#page10-continue');
      if (continueBtn) continueBtn.disabled = false;
      
      updateSetupButton();
      updateSetupSummary();
    }

    // ============================================
    // GAME DISPLAY UPDATES
    // ============================================

    function updateGameDisplay() {
      // Fame
      $('#heir-fame').textContent = gameState.heir.fame;
      
      // Resources
      $('#heir-coins').textContent = gameState.heir.coins;
      $('#heir-shards').textContent = gameState.heir.shards;
      
      // Stance
      const stanceEl = $('#heir-stance');
      if (gameState.heir.stance) {
        stanceEl.textContent = gameState.heir.stance.charAt(0).toUpperCase() + gameState.heir.stance.slice(1);
        stanceEl.className = `stance-indicator ${gameState.heir.stance}`;
      } else {
        stanceEl.textContent = 'Not yet determined';
        stanceEl.className = 'stance-indicator pending';
      }
      
      // Prophecy
      const prophecyCard = $('#prophecy-card');
      if (gameState.activeProphecy) {
        prophecyCard.style.display = 'block';
        $('#prophecy-icon').src = `assets/images/prophecies/${gameState.activeProphecy.icon}`;
        $('#prophecy-icon').alt = gameState.activeProphecy.name;
        $('#prophecy-name').textContent = gameState.activeProphecy.name;
        const isHeirIgnores = PROPHECIES.heirIgnores.some(p => p.id === gameState.activeProphecy.id);
        
        // Update type badge
        const typeEl = $('#prophecy-type');
        if (isHeirIgnores) {
          typeEl.innerHTML = '<span class="prophecy-badge badge-player-only">üë§ PLAYER ONLY</span>';
          prophecyCard.style.borderColor = 'var(--prophecy)';
        } else {
          typeEl.innerHTML = '<span class="prophecy-badge badge-affect-both">‚ö° AFFECTS BOTH</span>';
          prophecyCard.style.borderColor = 'var(--prophecy)';
        }
        
        $('#prophecy-desc').textContent = gameState.activeProphecy.description;
      } else {
        prophecyCard.style.display = 'none';
        prophecyCard.style.borderColor = '';
      }
      
      // Magician
      if (gameState.heirMagician) {
        $('#heir-magician-display').textContent = gameState.heirMagician.name;
        $('#ability-reminder').style.display = 'block';
        $('#ability-title').textContent = gameState.heirMagician.name;
        $('#ability-text').textContent = gameState.heirMagician.soloAbility;
      }
      
      // Characters
      updateCharactersDisplay();
      
      // Tricks
      updateTricksDisplay();
      
      // Player Tricks
      updatePlayerTricksDisplay();
      
      // Shopping List
      updateShoppingListDisplay();
      
      // Special Assignments
      updateAssignmentsDisplay();
      
      // Turn & Phase
      $('#current-turn').textContent = gameState.currentTurn;
      updatePhaseDisplay();
    }

    function updateCharactersDisplay() {
      const container = $('#heir-characters');
      
      // Combine active and pending characters with status
      const allChars = [
        ...gameState.heir.characters.map(c => ({ type: c, pending: false })),
        ...gameState.heir.pendingCharacters.map(c => ({ type: c, pending: true }))
      ];
      
      // Sort order: Magician ‚Üí Specialists (engineer, manager, assistant) ‚Üí Apprentices
      const sortOrder = {
        'magician': 0,
        'engineer': 1,
        'manager': 2,
        'assistant': 3,
        'apprentice': 4
      };
      allChars.sort((a, b) => sortOrder[a.type] - sortOrder[b.type]);
      
      let html = '';
      allChars.forEach(char => {
        const displayName = char.type.charAt(0).toUpperCase() + char.type.slice(1);
        const statusClass = char.pending ? 'pending' : 'filled';
        const pendingLabel = char.pending ? '<div class="char-label">(pending)</div>' : '';
        html += `
          <div class="character-slot ${statusClass}">
            <div class="char-icon"><img src="assets/images/characters/${char.type}.png" alt="${displayName}" style="width: 40px; height: 40px;"></div>
            <div>${displayName}</div>
            ${pendingLabel}
          </div>
        `;
      });
      
      container.innerHTML = html || '<div class="empty-state">No characters</div>';
    }

    function updateTricksDisplay() {
      const container = $('#heir-tricks');
      const tricks = gameState.heir.tricks;
      
      if (tricks.length === 0) {
        container.innerHTML = '<div class="empty-state">No tricks yet</div>';
        return;
      }
      
      let html = '';
      tricks.forEach(trick => {
        const markers = '‚óÜ'.repeat(trick.currentMarkers);
        html += `
          <div class="trick-item" data-school="${trick.school}">
            <span class="trick-name">${trick.name} (L${trick.level})</span>
            <span class="trick-markers" style="color: var(--amber);">${markers}</span>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function updatePlayerTricksDisplay() {
      const container = $('#player-tricks');
      const tricks = gameState.player.tricks;
      
      if (tricks.length === 0) {
        container.innerHTML = '<div class="empty-state">None tracked</div>';
        return;
      }
      
      let html = '';
      tricks.forEach(trick => {
        html += `
          <div class="trick-item" data-school="${trick.school}">
            <span class="trick-name">${trick.name} (L${trick.level})</span>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function updateShoppingListDisplay() {
      const container = $('#heir-shopping-list');
      const items = gameState.heir.shoppingList;
      
      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state">Empty</div>';
        return;
      }
      
      container.innerHTML = items.map(item => `<span class="component-tag">${item}</span>`).join('');
    }

    function updateAssignmentsDisplay() {
      const container = $('#heir-assignments');
      const assignments = gameState.heir.specialAssignments;
      const total = Object.values(assignments).reduce((a, b) => a + b, 0);
      
      if (total === 0) {
        container.innerHTML = '<div class="empty-state">None</div>';
        return;
      }
      
      let html = '';
      if (assignments.theater > 0) html += `<span class="assignment-badge" style="background: rgba(152, 48, 48, 0.2); border-color: #983030;">Theater: <span class="count">${assignments.theater}</span></span>`;
      if (assignments.downtown > 0) html += `<span class="assignment-badge" style="background: rgba(201, 184, 74, 0.2); border-color: #C9B84A;">Downtown: <span class="count">${assignments.downtown}</span></span>`;
      if (assignments.market > 0) html += `<span class="assignment-badge" style="background: rgba(196, 128, 64, 0.2); border-color: #C48040;">Market: <span class="count">${assignments.market}</span></span>`;
      if (assignments.workshop > 0) html += `<span class="assignment-badge" style="background: rgba(200, 112, 96, 0.2); border-color: #C87060;">Workshop: <span class="count">${assignments.workshop}</span></span>`;
      
      container.innerHTML = html;
    }

    function updatePhaseDisplay() {
      const steps = $$('.phase-step');
      steps.forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index < gameState.currentPhaseIndex) {
          step.classList.add('completed');
        } else if (index === gameState.currentPhaseIndex) {
          step.classList.add('active');
        }
      });
    }

    function showManagePlayerTricks() {
      // Get all schools and their tricks
      const schools = ['mechanical', 'spiritual', 'escape', 'optical'];
      const levels = [
        { key: 'level_1', label: 'Level 1' },
        { key: 'level_16', label: 'Level 2' },
        { key: 'level_36', label: 'Level 3' }
      ];
      
      // Get player's current tricks
      const playerTrickIds = gameState.player.tricks.map(t => t.id);
      const heirTrickIds = gameState.heir.tricks.map(t => t.id);
      
      let tricksHtml = '';
      
      schools.forEach(school => {
        const schoolDisplay = school.charAt(0).toUpperCase() + school.slice(1);
        const schoolIcon = `<img src="assets/images/schools/${school}.png" alt="${schoolDisplay}" style="width: 24px; height: 18px; vertical-align: middle; margin-right: 4px;">`;
        
        tricksHtml += `<div style="margin-bottom: 15px;">
          <h4 style="color: var(--text-primary); margin-bottom: 8px;">${schoolIcon} ${schoolDisplay}</h4>`;
        
        levels.forEach(({ key, label }) => {
          const tricks = ALL_TRICKS[school][key] || [];
          if (tricks.length === 0) return;
          
          const trickItems = tricks.map(trick => {
            const isPlayerOwned = playerTrickIds.includes(trick.id);
            const isHeirOwned = heirTrickIds.includes(trick.id);
            const disabled = isHeirOwned;
            
            return `
              <label style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; ${disabled ? 'opacity: 0.5;' : 'cursor: pointer;'}">
                <input type="checkbox" 
                       class="player-trick-manage-checkbox" 
                       data-trick-id="${trick.id}" 
                       data-school="${school}"
                       data-level="${key === 'level_1' ? 1 : key === 'level_16' ? 2 : 3}"
                       ${isPlayerOwned ? 'checked' : ''} 
                       ${disabled ? 'disabled' : ''}>
                <span style="flex: 1; font-size: 0.9rem;">${trick.name}</span>
                ${isHeirOwned ? '<span style="color: var(--text-muted); font-size: 0.8rem;">(Heir)</span>' : ''}
              </label>`;
          }).join('');
          
          tricksHtml += `
            <div style="margin-left: 10px; margin-bottom: 8px;">
              <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 4px;">${label}</div>
              ${trickItems}
            </div>`;
        });
        
        tricksHtml += '</div>';
      });
      
      // Create modal overlay
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'player-tricks-modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>Manage Tracked Tricks</h3>
            <button class="modal-close" id="modal-close-btn">&times;</button>
          </div>
          <div class="modal-body">
            <p style="margin-bottom: 15px; color: var(--text-secondary); font-size: 0.9rem;">Check the tricks you want the app to track. This helps with shared links and performance calculations. Heir's tricks are disabled.</p>
            ${tricksHtml}
          </div>
          <div class="modal-footer">
            <button class="btn" id="modal-save-btn">Save & Close</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listeners
      $('#modal-close-btn').addEventListener('click', closePlayerTricksModal);
      $('#modal-save-btn').addEventListener('click', savePlayerTricksFromModal);
      
      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closePlayerTricksModal();
      });
    }
    
    function closePlayerTricksModal() {
      const modal = $('#player-tricks-modal');
      if (modal) modal.remove();
    }
    
    function savePlayerTricksFromModal() {
      // Clear current player tricks and rebuild from checkboxes
      gameState.player.tricks = [];
      
      $$('.player-trick-manage-checkbox').forEach(checkbox => {
        if (checkbox.checked && !checkbox.disabled) {
          const trickId = checkbox.dataset.trickId;
          const school = checkbox.dataset.school;
          const level = parseInt(checkbox.dataset.level);
          
          // Find the trick data
          const levelKey = level === 1 ? 'level_1' : level === 2 ? 'level_16' : 'level_36';
          const trick = ALL_TRICKS[school][levelKey].find(t => t.id === trickId);
          
          if (trick) {
            gameState.player.tricks.push({
              ...trick,
              school: school,
              level: level
            });
          }
        }
      });
      
      updateGameDisplay();
      closePlayerTricksModal();
    }

    // ============================================
    // PROPHECY SELECTION
    // ============================================

    function showProphecySelection(onComplete) {
      // Build the prophecy grid - split into two sections
      const buildSection = (prophecies, categoryClass) => {
        let html = '';
        prophecies.forEach(prophecy => {
          html += `
            <div class="prophecy-item ${categoryClass}" 
                 data-prophecy-id="${prophecy.id}"
                 data-prophecy-name="${prophecy.name}"
                 data-prophecy-desc="${prophecy.description.replace(/"/g, '&quot;')}">
              <img src="assets/images/prophecies/${prophecy.icon}" alt="${prophecy.name}">
            </div>
          `;
        });
        return html;
      };
      
      const affectBothHtml = buildSection(PROPHECIES.affectBoth, 'affect-both');
      const heirIgnoresHtml = buildSection(PROPHECIES.heirIgnores, 'heir-ignores');
      
      // Create modal
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'prophecy-modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 620px;">
          <div class="modal-header">
            <h3>üîÆ Select This Turn's Prophecy</h3>
            <button class="modal-close" id="prophecy-modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="prophecy-section">
              <div class="prophecy-section-header affect-both-header">
                <span class="prophecy-badge badge-affect-both">‚ö° AFFECTS BOTH</span>
                <span class="prophecy-section-note">These affect you AND the Heir</span>
              </div>
              <div class="prophecy-grid">${affectBothHtml}</div>
            </div>
            
            <div class="prophecy-section" style="margin-top: 20px;">
              <div class="prophecy-section-header heir-ignores-header">
                <span class="prophecy-badge badge-player-only">üë§ PLAYER ONLY</span>
                <span class="prophecy-section-note">Heir ignores these ‚Äî they only affect you</span>
              </div>
              <div class="prophecy-grid">${heirIgnoresHtml}</div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Store the callback
      modal._onComplete = onComplete;
      
      // Add close button listener
      $('#prophecy-modal-close').addEventListener('click', closeProphecyModal);
      
      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeProphecyModal();
      });
      
      // Add tooltip element
      const tooltip = document.createElement('div');
      tooltip.className = 'prophecy-tooltip';
      tooltip.id = 'prophecy-tooltip';
      tooltip.style.display = 'none';
      document.body.appendChild(tooltip);
      
      // Add event listeners for hover tooltips
      $$('.prophecy-item').forEach(item => {
        item.addEventListener('mouseenter', (e) => {
          const tooltip = $('#prophecy-tooltip');
          tooltip.innerHTML = `<h4>${item.dataset.prophecyName}</h4><p>${item.dataset.prophecyDesc}</p>`;
          tooltip.style.display = 'block';
          positionTooltip(e, tooltip);
        });
        
        item.addEventListener('mousemove', (e) => {
          positionTooltip(e, $('#prophecy-tooltip'));
        });
        
        item.addEventListener('mouseleave', () => {
          $('#prophecy-tooltip').style.display = 'none';
        });
        
        item.addEventListener('click', () => {
          selectProphecy(item.dataset.prophecyId);
        });
      });
    }

    function positionTooltip(e, tooltip) {
      const x = e.clientX + 15;
      const y = e.clientY + 15;
      
      // Keep tooltip on screen
      const rect = tooltip.getBoundingClientRect();
      const maxX = window.innerWidth - rect.width - 10;
      const maxY = window.innerHeight - rect.height - 10;
      
      tooltip.style.left = Math.min(x, maxX) + 'px';
      tooltip.style.top = Math.min(y, maxY) + 'px';
    }

    function selectProphecy(prophecyId) {
      // Find the prophecy
      const prophecy = VALID_PROPHECIES.find(p => p.id === prophecyId);
      if (!prophecy) return;
      
      // Set the active prophecy
      gameState.activeProphecy = prophecy;
      
      // Get the callback before closing
      const modal = $('#prophecy-modal');
      const onComplete = modal._onComplete;
      
      // Close modal and tooltip
      closeProphecyModal();
      
      // Update display and continue
      updateGameDisplay();
      
      if (onComplete) {
        onComplete();
      }
    }

    function closeProphecyModal() {
      const modal = $('#prophecy-modal');
      if (modal) modal.remove();
      const tooltip = $('#prophecy-tooltip');
      if (tooltip) tooltip.remove();
    }

    // ============================================
    // GAME INITIALIZATION
    // ============================================

    function initializeGame() {
      // Set up characters based on difficulty - use pre-assigned specialist types from setup
      const diff = DIFFICULTY_SETTINGS[gameState.difficulty];
      const chars = ['magician'];
      
      // Use the specialists assigned during difficulty selection
      gameState.startingSpecialists.forEach(specialistType => {
        chars.push(specialistType);
      });
      
      for (let i = 0; i < diff.characters.apprentices; i++) chars.push('apprentice');
      gameState.heir.characters = chars;
      
      // Initialize other state
      gameState.currentTurn = 1;
      gameState.currentPhaseIndex = 0;
      gameState.heir.fame = 5;
      gameState.heir.coins = 0;
      gameState.heir.shards = gameState.expansions.dawn ? 1 : 0; // DoT: Heir starts with 1 Shard
      gameState.heir.stance = null;
      
      // Show restart button
      $('#restart-btn').classList.remove('hidden');
      
      // Show game screen
      showScreen('game-screen');
      updateGameDisplay();
      updatePhaseDisplay();
      
      // Start with Roll Dice phase
      handleRollDicePhase();
    }

    function setActionContent(title, content, buttons = []) {
      $('#action-title').textContent = title;
      $('#action-content').innerHTML = content;
      
      const btnContainer = $('#action-buttons');
      btnContainer.innerHTML = '';
      buttons.forEach(btn => {
        const button = document.createElement('button');
        button.className = 'btn';
        button.textContent = btn.text;
        button.addEventListener('click', btn.action);
        if (btn.id) button.id = btn.id;
        if (btn.disabled) button.disabled = true;
        btnContainer.appendChild(button);
      });
      
      // Scroll action panel into view (instant, no animation)
      const actionPanel = $('.action-panel');
      if (actionPanel) {
        actionPanel.scrollIntoView({ behavior: 'instant', block: 'start' });
      }
    }

    function advancePhase() {
      gameState.currentPhaseIndex++;
      
      if (gameState.currentPhaseIndex >= PHASES.length) {
        // End of turn
        endTurn();
        return;
      }
      
      updatePhaseDisplay();
      handlePhase(PHASES[gameState.currentPhaseIndex].id);
    }

    // Prophecy phase relevance mapping - phases only, descriptions come from PROPHECIES
    const PROPHECY_PHASE_MAP = {
      'p01': ['advertise', 'place-characters'],  // Apprentices +1 AP if advertised
      'p02': ['downtown'],                        // Double coins on Take Coins action
      'p03': ['downtown'],                        // Taking coins costs 1 AP
      'p04': ['downtown'],                        // Hiring characters costs 1 AP
      'p05': ['downtown', 'workshop'],            // Learning tricks costs 1 AP
      'p06': ['downtown'],                        // Drawing cards costs 1 AP
      'p07': ['theater', 'place-characters'],     // +2 Fame setting up Mechanical trick
      'p08': ['theater', 'place-characters'],     // +2 Fame setting up Escape trick
      'p09': ['theater', 'place-characters'],     // +2 Fame setting up Spiritual trick
      'p10': ['theater', 'place-characters'],     // +2 Fame setting up Optical trick
      'p11': ['theater', 'place-characters', 'performance'],  // Saturday +1 yield
      'p12': ['theater', 'place-characters', 'performance'],  // Friday -1 yield
      'p13': ['theater', 'place-characters', 'performance'],  // Thu/Sun no yield modifiers
      'p14': ['performance'],                     // Double performer bonus
      'p16': ['performance'],                     // Coins count as Fame during performance
      'p17': ['theater'],                         // Enhance at Theater
      'p18': ['workshop'],                        // Enhance receives 2 AP
      'p19': ['performance', 'end-turn', 'theater', 'end-game'],  // +1 extra shard when receiving shards
      'p20': ['performance', 'end-turn', 'theater', 'end-game'],  // Receiving shards gives +2 Fame
      'p21': ['assignment'],                      // Pay 3 coins for +2 slots
      'p22': ['place-characters'],                // Place 2 characters at once
      'p25': ['place-characters'],                // All characters 1 base AP
      'p26': ['market'],                          // Buy from Orders section
      'p27': ['market']                           // All components 2 coins
    };

    function getProphecyReminderHtml(phaseId) {
      if (!gameState.activeProphecy) return '';
      
      const phases = PROPHECY_PHASE_MAP[gameState.activeProphecy.id];
      if (!phases || !phases.includes(phaseId)) return '';
      
      // Determine if this is player-only or affects both
      const isHeirIgnores = PROPHECIES.heirIgnores.some(p => p.id === gameState.activeProphecy.id);
      const badgeHtml = isHeirIgnores 
        ? '<span class="prophecy-badge badge-player-only">üë§ PLAYER ONLY</span>'
        : '<span class="prophecy-badge badge-affect-both">‚ö° AFFECTS BOTH</span>';
      
      // Get the description from the main PROPHECIES data (single source of truth)
      const description = gameState.activeProphecy.description;
      
      return `<div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.15)); border: 2px solid var(--prophecy); padding: 10px 14px; margin: 12px 0; border-radius: 6px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
          <img src="assets/images/prophecies/${gameState.activeProphecy.icon}" alt="" style="width: 36px; height: 36px; border-radius: 4px;">
          <div>
            <div style="color: var(--prophecy); font-weight: 600; font-size: 0.85rem;">üîÆ ${gameState.activeProphecy.name}</div>
            ${badgeHtml}
          </div>
        </div>
        <div style="color: var(--text-secondary); font-size: 0.9rem;">${description}</div>
      </div>`;
    }

    // Heir-specific prophecy reminder - shows only "affectBoth" prophecies at relevant Heir screens
    // Context: 'heir-downtown', 'heir-market', 'heir-darkalley', 'heir-theater-nonmagician', 'heir-performance'
    function getHeirProphecyReminderHtml(context) {
      if (!gameState.activeProphecy) return '';
      
      // Only show prophecies that affect the Heir (not heirIgnores)
      const isHeirIgnores = PROPHECIES.heirIgnores.some(p => p.id === gameState.activeProphecy.id);
      if (isHeirIgnores) return '';
      
      // Map contexts to relevant prophecy IDs
      const contextMap = {
        'heir-downtown': ['p01', 'p02', 'p25'],           // Apprentice AP, Double Coins, 1 Base AP
        'heir-market': ['p01', 'p25'],                    // Apprentice AP, 1 Base AP
        'heir-darkalley': ['p01', 'p25'],                 // Apprentice AP, 1 Base AP
        'heir-theater-nonmagician': ['p01', 'p07', 'p08', 'p09', 'p10', 'p19', 'p20', 'p25'],  // Apprentice AP, Fame for trick schools, Shard bonuses, 1 Base AP
        'heir-performance': ['p14', 'p16', 'p19', 'p20']  // Double performer bonus, Coins as Fame, Shard bonuses
      };
      
      const relevantProphecies = contextMap[context] || [];
      if (!relevantProphecies.includes(gameState.activeProphecy.id)) return '';
      
      const description = gameState.activeProphecy.description;
      
      return `<div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.15)); border: 2px solid var(--prophecy); padding: 10px 14px; margin: 12px 0; border-radius: 6px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
          <img src="assets/images/prophecies/${gameState.activeProphecy.icon}" alt="" style="width: 36px; height: 36px; border-radius: 4px;">
          <div>
            <div style="color: var(--prophecy); font-weight: 600; font-size: 0.85rem;">üîÆ ${gameState.activeProphecy.name}</div>
            <span class="prophecy-badge badge-affect-both">‚ö° AFFECTS HEIR</span>
          </div>
        </div>
        <div style="color: var(--text-secondary); font-size: 0.9rem;">${description}</div>
      </div>`;
    }

    function handlePhase(phaseId) {
      switch (phaseId) {
        case 'roll-dice':
          handleRollDicePhase();
          break;
        case 'initiative':
          handleInitiativePhase();
          break;
        case 'advertise':
          handleAdvertisePhase();
          break;
        case 'assignment':
          handleAssignmentPhase();
          break;
        case 'place-characters':
          handlePlaceCharactersPhase();
          break;
        case 'performance':
          handlePerformancePhase();
          break;
        case 'end-turn':
          handleEndTurnPhase();
          break;
      }
    }

    // ============================================
    // PHASE HANDLERS (Skeleton for now)
    // ============================================

    function handleRollDicePhase() {
      const isFirstTurn = gameState.currentTurn === 1;
      const turnNumber = gameState.currentTurn;
      
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      let content = boardAction('Roll all 6 Downtown dice and place them on the Downtown board area');
      
      if (turnNumber === 1) {
        content += `
          ${boardAction('Roll all 4 Turn Setup dice and place each on its matching location')}
          <div style="display: flex; gap: 15px; flex-wrap: wrap; margin: 10px 0 20px 0; color: var(--text-secondary); align-items: center;">
            <span><span style="color: #C9B84A; font-size: 1.5em; vertical-align: middle;">‚óè</span> Downtown</span>
            <span><span style="color: #C48040; font-size: 1.5em; vertical-align: middle;">‚óè</span> Market Row</span>
            <span><span style="color: #5A5A5A; font-size: 1.5em; vertical-align: middle;">‚óè</span> Dark Alley</span>
            <span><span style="color: #983030; font-size: 1.5em; vertical-align: middle;">‚óè</span> Theater</span>
          </div>
          ${boardAction('Place Blocking tiles based on the dice results')}`;
      } else if (turnNumber === 2) {
        content += `
          ${boardAction('Reroll 2 Turn Setup dice of your choice')}
          ${boardAction('Place Turn Setup markers underneath the 2 rerolled dice')}
          ${boardAction('Rearrange Blocking tiles on those locations based on new results')}`;
      } else {
        content += `
          ${boardAction('Reroll 2 Turn Setup dice (NOT the ones with markers underneath)')}
          ${boardAction('Move Turn Setup markers to underneath the 2 newly rerolled dice')}
          ${boardAction('Rearrange Blocking tiles on those locations based on new results')}`;
      }

      // On Turn 2+, show prophecy selection before advancing
      const continueAction = () => {
        if (gameState.currentTurn >= 2) {
          showProphecySelection(() => advancePhase());
        } else {
          advancePhase();
        }
      };

      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Roll Dice`,
        content,
        [{ text: gameState.currentTurn >= 2 ? 'Select Prophecy & Continue' : 'Continue to Initiative', action: continueAction }]
      );
    }

    function handleInitiativePhase() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      let content = '';
      
      if (gameState.currentTurn === 1) {
        content = `${infoBox("Initiative phase is skipped on Turn 1. You go first.")}`;
      } else {
        content = `${boardAction("Rearrange Initiative Order based on Fame (lower Fame goes first)")}
                   
                   <p style="margin-top: 10px; color: var(--text-secondary);">If tied, reverse the previous order of tied players.</p>
                   
                   <p style="margin-top: 10px;"><strong>Current Heir Fame:</strong> ${gameState.heir.fame}</p>`;
      }
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Initiative`,
        content,
        [{ text: 'Continue to Advertise', action: () => advancePhase() }]
      );
    }

    function handleAdvertisePhase() {
      // Heir always advertises for free and gains Fame
      const previousFame = gameState.heir.fame;
      gameState.heir.fame += 2;
      updateGameDisplay();
      
      // Check if stance changed due to Fame threshold
      updateHeirStance();
      
      const prophecyReminder = getProphecyReminderHtml('advertise');
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Advertise`,
        `${prophecyReminder}<p>The Heir advertises <strong>every turn at no Coin cost</strong> but receives Fame nonetheless.</p>
         <p style="margin-top: 10px;"><strong>Heir gains +2 Fame</strong> (${previousFame} ‚Üí ${gameState.heir.fame})</p>
         ${boardAction(`Move the Heir's Fame marker from ${previousFame} to ${gameState.heir.fame}`)}
         ${boardAction(`Place the Heir's Magician Poster above the Heir's Initiative marker`)}
         
         <div style="background: var(--bg-card); border: 1px solid var(--border); padding: 12px 15px; margin: 15px 0; border-radius: 6px;">
           <p style="color: var(--text-secondary); margin-bottom: 8px;"><strong>Your turn to Advertise:</strong></p>
           <p style="color: var(--text-secondary); font-size: 0.9rem;">Pay Coins equal to your Initiative position (1-4) to gain 2 Fame.</p>
         </div>`,
        [{ text: 'Continue to Assignment', action: () => advancePhase() }]
      );
    }

    function updateHeirStance() {
      // Stance is Ready if:
      // - Current Plan card is a "Perform" card (icons at top AND bottom)
      // - AND Heir has at least one trick of the highest Level available to it
      // Otherwise stance is Busy
      
      // For now, stance tracking will be manual since we don't have full Plan card implementation
      // The user will tell us when revealing the Plan card
    }
    
    // Check if stance changed after Fame or Trick modification, and notify player if so
    // Returns a Promise that resolves when player acknowledges (or immediately if no change)
    function checkAndNotifyStanceChange(continueFunc) {
      // Only relevant on Perform card turns - Setup cards are always Busy
      if (gameState.currentPlanCard !== 'perform') {
        continueFunc();
        return;
      }
      
      const previousStance = gameState.heir.stance;
      
      // Recalculate what stance should be
      const highestAvailableLevel = getTargetTrickLevel();
      const heirHighestTrickLevel = getHeirHighestTrickLevel();
      const hasTrickAtHighestLevel = heirHighestTrickLevel >= highestAvailableLevel;
      const newStance = hasTrickAtHighestLevel ? 'ready' : 'busy';
      
      if (newStance !== previousStance) {
        // Stance changed! Update and notify
        gameState.heir.stance = newStance;
        updateGameDisplay();
        
        const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
        
        const stanceColor = newStance === 'ready' ? 'var(--success)' : 'var(--warning)';
        const slotDirection = newStance === 'ready' ? 'UP to top slot' : 'DOWN to bottom slot';
        
        let reason = '';
        if (newStance === 'ready') {
          reason = `The Heir now has a Level ${highestAvailableLevel} Trick, meeting the requirement for Ready stance.`;
        } else {
          reason = `The Heir crossed a Fame threshold and now needs a Level ${highestAvailableLevel} Trick to be Ready, but doesn't have one.`;
        }
        
        setActionContent(
          `Turn ${gameState.currentTurn} ‚Äî Stance Changed!`,
          `<div style="text-align: center; padding: 20px 0;">
             <p style="font-size: 1.2rem; margin-bottom: 15px;">The Heir's stance has changed!</p>
             <div style="font-size: 1.5rem; color: ${stanceColor}; font-weight: bold; margin-bottom: 15px;">
               ${previousStance.toUpperCase()} ‚Üí ${newStance.toUpperCase()}
             </div>
           </div>
           
           <p style="color: var(--text-secondary); margin-bottom: 15px;">${reason}</p>
           
           ${boardAction(`Slide the Heir's Plan card ${slotDirection}`)}
           
           <p style="margin-top: 15px;"><strong>New Location Priority:</strong></p>
           ${getLocationPriorityHtml(newStance)}`,
          [{ text: 'Continue', action: continueFunc }]
        );
      } else {
        // No change, continue immediately
        continueFunc();
      }
    }

    function handleAssignmentPhase() {
      const isFirstTurn = gameState.currentTurn === 1;
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      const prophecyReminder = getProphecyReminderHtml('assignment');
      
      let content = prophecyReminder + boardAction("Place your Assignment cards face-up below your Characters");
      
      content += `<p style="margin-top: 20px; margin-bottom: 10px;"><strong>Then, the Heir's Assignment:</strong></p>`;
      
      if (!isFirstTurn) {
        content += boardAction("Discard the Heir's Plan card from the previous turn");
      }
      
      content += boardAction("Reveal the top card of the Heir's Plan deck");
      
      content += `
        <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
          <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span>
          <ul style="color: var(--text-secondary); margin: 8px 0 0 20px; line-height: 1.8;">
            <li><strong>"Perform" card</strong> (icons at top AND bottom) ‚Üí <strong>top slot</strong> = Ready stance</li>
            <li><strong>"Set Up" card</strong> (icons only at top) ‚Üí <strong>bottom slot</strong> = Busy stance</li>
          </ul>
        </div>`;
      
      content += boardAction("Place the card on the Heir's board");
      
      content += boardAction("Assign standard Assignment cards to the Heir's Characters, left-to-right, matching the Plan card's locations");
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Assignment`,
        content,
        [{ text: 'Continue ‚Üí', action: () => showPlanCardReveal() }]
      );
    }

    function showPlanCardReveal() {
      // Turn 1: Always Setup card / Busy stance (no choice needed)
      if (gameState.currentTurn === 1) {
        const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
        
        setActionContent(
          `Turn ${gameState.currentTurn} ‚Äî Assignment`,
          `${infoBox("On Turn 1, the Heir always uses a <strong>Set Up</strong> card and starts in <strong>Busy</strong> stance.")}`,
          [{ text: 'Continue ‚Üí', action: () => setPlanCardAndStance('setup') }]
        );
        return;
      }
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Assignment`,
        `<p><strong>What type of Plan card was revealed?</strong></p>
         <p style="color: var(--text-secondary); margin-bottom: 20px;">Check if the card has icons at BOTH top and bottom (Perform) or only at the top (Set Up).</p>
         <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
           <button class="btn plan-type-btn" data-type="perform" style="min-width: 140px;">
             Perform Card<br><span style="font-size: 0.8rem; opacity: 0.8;">(Ready stance)</span>
           </button>
           <button class="btn plan-type-btn" data-type="setup" style="min-width: 140px;">
             Set Up Card<br><span style="font-size: 0.8rem; opacity: 0.8;">(Busy stance)</span>
           </button>
         </div>`,
        []
      );
      
      setTimeout(() => {
        $$('.plan-type-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const cardType = btn.dataset.type;
            setPlanCardAndStance(cardType);
          });
        });
      }, 0);
    }

    function setPlanCardAndStance(cardType) {
      const isPerformCard = cardType === 'perform';
      
      // Store card type for later reference (used to skip stance recheck on Setup cards)
      gameState.currentPlanCard = cardType;
      
      // Determine stance based on card type AND whether Heir has trick at highest level
      const highestAvailableLevel = getTargetTrickLevel(); // Based on Fame thresholds
      const heirHighestTrickLevel = getHeirHighestTrickLevel();
      const hasTrickAtHighestLevel = heirHighestTrickLevel >= highestAvailableLevel;
      
      // Ready only if Perform card AND has trick at highest available level
      const newStance = (isPerformCard && hasTrickAtHighestLevel) ? 'ready' : 'busy';
      gameState.heir.stance = newStance;
      
      updateGameDisplay();
      
      let stanceExplanation = '';
      if (isPerformCard && !hasTrickAtHighestLevel) {
        stanceExplanation = `<p style="color: var(--warning); margin-top: 10px;">‚ö† Even though it's a Perform card, stance is <strong>Busy</strong> because the Heir doesn't have a Level ${highestAvailableLevel} Trick yet.</p>`;
      }
      
      // Show transition screen instead of going directly to Place Characters
      showTurnSetupComplete(isPerformCard, newStance, stanceExplanation);
    }

    function showTurnSetupComplete(isPerformCard, stance, stanceExplanation) {
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Turn Setup Complete`,
        `<div style="text-align: center; padding: 20px 0;">
           <div style="font-size: 1.4rem; color: var(--amber); margin-bottom: 20px;">‚ú¶ Turn ${gameState.currentTurn} Setup Complete ‚ú¶</div>
           
           <div class="turn-summary-box" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: left;">
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
               <div>
                 <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px;">Plan Card</div>
                 <div style="color: var(--text-primary); font-size: 1.1rem;">${isPerformCard ? 'Perform' : 'Set Up'}</div>
               </div>
               <div>
                 <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px;">Heir's Stance</div>
                 <div style="color: ${stance === 'ready' ? 'var(--success)' : 'var(--warning)'}; font-size: 1.1rem;">${stance.charAt(0).toUpperCase() + stance.slice(1)}</div>
               </div>
               <div>
                 <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px;">Heir's Fame</div>
                 <div style="color: var(--text-primary); font-size: 1.1rem;">${gameState.heir.fame}</div>
               </div>
               <div>
                 <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px;">Turn</div>
                 <div style="color: var(--text-primary); font-size: 1.1rem;">${gameState.currentTurn} of 7</div>
               </div>
             </div>
           </div>
           
           ${stanceExplanation}
           
           <p style="margin-top: 15px;"><strong>Location Priority (${stance === 'ready' ? 'Ready' : 'Busy'}):</strong></p>
           ${getLocationPriorityHtml(stance)}
         </div>`,
        [
          { text: 'Begin Place Characters ‚Üí', action: () => advancePhase() }
        ]
      );
    }

    function skipToNextTurn() {
      if (gameState.currentTurn >= 7) {
        setActionContent(
          'Game Complete',
          `<p>This is the final turn (Turn 7). Cannot skip further.</p>
           <p>Would you like to restart from Turn 1 for more testing?</p>`,
          [
            { text: 'Restart from Turn 1', action: () => restartForTesting() },
            { text: 'Continue to Place Characters', action: () => advancePhase() }
          ]
        );
        return;
      }
      
      // Advance to next turn
      gameState.currentTurn++;
      gameState.currentPhaseIndex = 0;
      
      // Reset stance to busy for new turn
      gameState.heir.stance = 'busy';
      
      // Reset downtown dice for new turn (they get re-rolled)
      gameState.downtownDice = {
        trick1: 'x',
        trick2: 'x',
        apprentice: 'x',
        specialist: 'x',
        bank1: 'x',
        bank2: 'x'
      };
      
      updateGameDisplay();
      updatePhaseDisplay();
      
      // Start the new turn's Roll Dice phase
      handleRollDicePhase();
    }

    function restartForTesting() {
      gameState.currentTurn = 1;
      gameState.currentPhaseIndex = 0;
      gameState.heir.fame = 5; // Reset to starting fame
      gameState.heir.stance = 'busy';
      
      updateGameDisplay();
      updatePhaseDisplay();
      
      handleRollDicePhase();
    }

    function getLocationPriorityHtml(stance) {
      if (stance === 'ready') {
        return `<ol style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px;">
          <li>Theater (earliest available day)</li>
          <li>Downtown</li>
          <li style="color: var(--text-muted);"><s>Academy</s> <em>(expansion)</em></li>
          <li>Market Row</li>
          <li>Dark Alley</li>
          <li>Workshop</li>
        </ol>`;
      } else {
        return `<ol style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px;">
          <li>Downtown</li>
          <li style="color: var(--text-muted);"><s>Academy</s> <em>(expansion)</em></li>
          <li>Theater (latest possible day)</li>
          <li>Market Row</li>
          <li>Dark Alley</li>
          <li>Workshop</li>
        </ol>`;
      }
    }

    function handlePlaceCharactersPhase() {
      // Reset placement counter for this turn
      gameState.heirPlacementsThisTurn = 0;
      gameState.heirPlacementsEndedEarly = false;
      gameState.heirActualPlacements = 0;
      
      // Reset Mechaniker first apprentice tracking
      gameState.firstApprenticePlacedThisTurn = false;
      
      // Reset Optico tracking
      gameState.opticoNonApprenticesPlaced = 0;
      gameState.opticoPlayerSACards = 0;
      
      // Reset magician at theater tracking
      gameState.heir.magicianAtTheaterThisTurn = false;
      
      // Reset non-magician at theater tracking (for backstage bonus calculation)
      gameState.heir.nonMagiciansAtTheaterThisTurn = 0;
      
      // Reset p22 (Place Two Characters) tracking
      gameState.heirP22FirstPlacementDone = false;
      
      // Check if Optico is the magician - need to ask about SA cards
      const isOptico = gameState.heirMagician?.id === 'optico';
      
      if (isOptico) {
        showOpticoSACardQuestion();
      } else {
        proceedToPlaceCharacters();
      }
    }
    
    function showOpticoSACardQuestion() {
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Place Characters`,
        `<p><strong>The Great Optico's Ability</strong></p>
         
         ${magicianAbilityBox(`The first <strong>X</strong> non-Apprentice Characters the Heir places this turn gain <strong>+1 AP</strong>, where X = the number of Special Assignment cards <strong>you (the player)</strong> used this turn.`)}
         
         <p style="margin-top: 15px;"><strong>How many Special Assignment cards did you use this turn?</strong></p>
         <p style="color: var(--text-secondary); font-size: 0.9rem;">Count the SA cards you assigned to your characters during Assignment phase.</p>
         
         <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap;">
           ${[0,1,2,3,4].map(n => `
             <button class="btn sa-count-btn" data-count="${n}" style="min-width: 50px;">${n}</button>
           `).join('')}
         </div>`,
        []
      );
      
      setTimeout(() => {
        $$('.sa-count-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            gameState.opticoPlayerSACards = parseInt(btn.dataset.count);
            proceedToPlaceCharacters();
          });
        });
      }, 0);
    }
    
    function proceedToPlaceCharacters() {
      // Determine who goes first
      if (gameState.currentTurn === 1) {
        // Turn 1: Player always goes first (1st in initiative)
        showPlayerTurnScreen();
      } else {
        // Turn 2+: Ask who has initiative
        showInitiativeCheck();
      }
    }
    
    function showInitiativeCheck() {
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      const prophecyReminder = getProphecyReminderHtml('place-characters');
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Place Characters`,
        `${prophecyReminder}<p><strong>Who goes first?</strong></p>
         
         ${infoBox("Check Initiative Order ‚Äî the player in position 1 places first. (Lower Fame = earlier position)")}
         
         <p style="margin-top: 15px;">Heir's Fame: <strong>${gameState.heir.fame}‚òÖ</strong></p>`,
        [
          { text: 'I go first', action: () => showPlayerTurnScreen() },
          { text: 'Heir goes first', action: () => showHeirTurnStart() }
        ]
      );
    }
    
    function showPlayerTurnScreen() {
      const playerTurnBox = (text) => `<div style="background: rgba(100, 200, 100, 0.15); border: 2px solid #6c6; padding: 20px; margin: 15px 0; border-radius: 8px; text-align: center;"><span style="color: #6c6; font-weight: 600; font-size: 1.2rem;">üë§ YOUR TURN</span><p style="margin-top: 10px; color: var(--text-primary);">${text}</p></div>`;
      
      // Player's magician power reminder
      let playerMagicianReminder = '';
      if (gameState.playerMagician) {
        const schoolColors = {
          mechanical: 'var(--mechanical)',
          optical: 'var(--optical)',
          escape: 'var(--escape)',
          spiritual: 'var(--spiritual)'
        };
        const color = schoolColors[gameState.playerMagician.school] || 'var(--amber)';
        
        playerMagicianReminder = `<div style="background: rgba(212, 168, 71, 0.1); border: 1px solid ${color}; padding: 10px 14px; margin: 12px 0; border-radius: 6px;">
          <div style="color: ${color}; font-weight: 600; font-size: 0.85rem;">‚ú® ${gameState.playerMagician.name} (${gameState.playerMagician.title})</div>
          <div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 4px;">${gameState.playerMagician.ability}</div>
        </div>`;
      }
      
      // Prophecy reminder for player (matches standard styling)
      let prophecyReminder = '';
      if (gameState.activeProphecy) {
        const isHeirIgnores = PROPHECIES.heirIgnores.some(p => p.id === gameState.activeProphecy.id);
        const badgeHtml = isHeirIgnores 
          ? '<span class="prophecy-badge badge-player-only">üë§ PLAYER ONLY</span>'
          : '<span class="prophecy-badge badge-affect-both">‚ö° AFFECTS BOTH</span>';
        
        prophecyReminder = `<div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.15)); border: 2px solid var(--prophecy); padding: 10px 14px; margin: 12px 0; border-radius: 6px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
            <img src="assets/images/prophecies/${gameState.activeProphecy.icon}" alt="" style="width: 36px; height: 36px; border-radius: 4px;">
            <div>
              <div style="color: var(--prophecy); font-weight: 600; font-size: 0.85rem;">üîÆ ${gameState.activeProphecy.name}</div>
              ${badgeHtml}
            </div>
          </div>
          <div style="color: var(--text-secondary); font-size: 0.9rem;">${gameState.activeProphecy.description}</div>
        </div>`;
      }
      
      const heirCharacterCount = gameState.heir.characters.length;
      const heirPlaced = gameState.heirPlacementsThisTurn;
      const heirRemaining = heirCharacterCount - heirPlaced;
      
      // p22 (Place Two Characters) is handled by the standard prophecyReminder above
      
      let buttons = [];
      
      if (heirRemaining > 0) {
        // Heir still has characters to place
        buttons = [
          { text: 'Done ‚Äî Heir\'s Turn ‚Üí', action: () => showHeirTurnStart() }
        ];
      } else {
        // Heir is done, player continues until all characters placed
        buttons = [
          { text: 'All Characters Placed ‚Üí Performance', action: () => advancePhase() }
        ];
      }
      
      // Add rotation button for when player visits Dark Alley
      const rotationButton = `<div style="margin-top: 10px; text-align: center;">
        <button class="btn" id="player-rotated-prophecy-btn" style="background: transparent; border: 1px solid var(--prophecy); color: var(--prophecy); font-size: 0.85rem; padding: 8px 16px;">
          üîÆ I Rotated Prophecies at Dark Alley
        </button>
      </div>`;
      
      // Add Shared Links button if Heir has tricks (potential for links)
      const hasHeirTricks = gameState.heir.tricks && gameState.heir.tricks.length > 0;
      const sharedLinksButton = hasHeirTricks ? `<div style="margin-top: 10px; text-align: center;">
        <button class="btn" id="player-shared-links-btn" style="background: transparent; border: 1px solid var(--info); color: var(--info); font-size: 0.85rem; padding: 8px 16px;">
          I Placed Tricks in Theater ‚Äî Check Shared Links
        </button>
      </div>` : '';
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Place Characters`,
        `${playerTurnBox("Place one of your Characters at their assigned Location.")}
         ${playerMagicianReminder}
         ${prophecyReminder}
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="color: var(--text-secondary); font-size: 0.9rem;">Heir has placed <strong>${gameState.heirPlacementsEndedEarly ? gameState.heirActualPlacements : heirPlaced}</strong> of <strong>${heirCharacterCount}</strong> characters this turn.${gameState.heirPlacementsEndedEarly ? ' <span style="color: var(--text-muted);">(ended early)</span>' : ''}</p>
           ${heirRemaining === 0 
             ? `<p style="color: var(--amber); font-size: 0.9rem; margin-top: 5px;">The Heir has placed all their characters. Continue placing yours until done.</p>`
             : ''
           }
         </div>
         ${rotationButton}
         ${sharedLinksButton}`,
        buttons
      );
      
      // Add event listeners for optional buttons
      setTimeout(() => {
        const rotateBtn = $('#player-rotated-prophecy-btn');
        if (rotateBtn) {
          rotateBtn.addEventListener('click', () => {
            showProphecySelection(() => showPlayerTurnScreen());
          });
        }
        
        const sharedLinksBtn = $('#player-shared-links-btn');
        if (sharedLinksBtn) {
          sharedLinksBtn.addEventListener('click', () => {
            showSharedLinksFromPlayerTurn();
          });
        }
      }, 0);
    }
    
    function showHeirTurnStart() {
      // Reset p22 tracking for new Heir turn
      gameState.heirP22FirstPlacementDone = false;
      
      // First, check/set stance, then proceed to contested check
      if (gameState.heirPlacementsThisTurn === 0) {
        // First Heir placement this turn - stance already set from Assignment phase
        showContestedCheck();
      } else {
        // Subsequent placement - may need to re-check stance
        showStanceRecheck();
      }
    }
    
    function showSharedLinksFromPlayerTurn() {
      // Same as showPlayerLinksWithHeirTricks but returns to Player Turn screen
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      const prophecyReminder = getProphecyReminderHtml('performance');
      
      // Check for shard-related prophecies
      const isExtraShard = gameState.activeProphecy?.id === 'p19';
      const isShardsGiveFame = gameState.activeProphecy?.id === 'p20';
      
      // Shared calculation function
      const calculateShardGains = () => {
        const selected = $('.shard-btn.btn-selected');
        let shards = selected ? parseInt(selected.dataset.shards) : 0;
        let fame = 0;
        
        if (shards > 0) {
          if (isExtraShard) {
            shards += 1;
          }
          if (isShardsGiveFame) {
            fame += 2;
          }
        }
        
        return { shards, fame };
      };
      
      // Update board action dynamically
      const updateShardBoardAction = () => {
        const gains = calculateShardGains();
        const currentShards = gameState.heir.shards;
        const currentFame = gameState.heir.fame;
        
        const boardActionEl = $('#shard-links-board-action-pt');
        if (boardActionEl) {
          let text = `Update Heir's Shards (${currentShards} ‚Üí ${currentShards + gains.shards})`;
          if (gains.fame > 0) {
            text += ` and Fame (${currentFame} ‚Üí ${currentFame + gains.fame})`;
          }
          boardActionEl.innerHTML = text;
        }
      };
      
      const currentShards = gameState.heir.shards;
      const currentFame = gameState.heir.fame;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Shared Links`,
        `${infoBox("When you create a Link over a Shard symbol with one of the Heir's tricks, <strong>both you AND the Heir</strong> receive 1 Shard.")}
         
         <p style="margin-top: 15px;">How many Links did you just create with the Heir's tricks over Shard symbols?</p>
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <label style="display: block; margin-bottom: 12px;"><strong>üíé Shards for the Heir</strong></label>
           <div class="shard-selector" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
             ${[0,1,2,3,4,5].map(n => `
               <button class="btn shard-btn${n === 0 ? ' btn-selected' : ''}" data-shards="${n}" style="min-width: 50px;">${n}</button>
             `).join('')}
           </div>
         </div>
         
         ${prophecyReminder}
         
         <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);" id="shard-links-board-action-pt">Update Heir's Shards (${currentShards} ‚Üí ${currentShards})</span></div>`,
        [
          { text: 'Done ‚Äî Back to Player Turn', action: () => {
            // Apply gains
            const gains = calculateShardGains();
            
            if (gains.shards > 0 || gains.fame > 0) {
              gameState.heir.shards += gains.shards;
              gameState.heir.fame += gains.fame;
              updateGameDisplay();
            }
            showPlayerTurnScreen();
          }}
        ]
      );
      
      // Add click handlers for shard buttons
      setTimeout(() => {
        $$('.shard-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            $$('.shard-btn').forEach(b => b.classList.remove('btn-selected'));
            btn.classList.add('btn-selected');
            updateShardBoardAction();
          });
        });
      }, 0);
    }

    function showStanceCheck() {
      // Re-check stance after an Heir action that could have changed it
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Place Characters`,
        `<p><strong>Re-check the Heir's Stance</strong></p>
         
         ${boardAction("Look at the Heir's current Fame and Tricks")}
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="margin-bottom: 10px;"><strong>READY</strong> if <em>both</em> are true:</p>
           <ol style="color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
             <li>Assignment card has icons on TOP and BOTTOM (a "Perform" card)</li>
             <li>Heir has at least one Trick at their Fame Level:
               <ul style="margin-top: 5px; margin-left: 15px;">
                 <li>Fame 0‚Äì15 ‚Üí needs any Trick (Level 1+)</li>
                 <li>Fame 16‚Äì35 ‚Üí needs a Level 2+ Trick</li>
                 <li>Fame 36+ ‚Üí needs a Level 3 Trick</li>
               </ul>
             </li>
           </ol>
           <p style="margin-top: 15px;"><strong>BUSY</strong> = everything else</p>
         </div>
         
         ${infoBox("Slide the Plan card UP for Ready, DOWN for Busy.")}
         
         <p style="margin-top: 15px;"><strong>Is the Heir Ready or Busy?</strong></p>`,
        [
          { text: 'Ready', action: () => { gameState.heir.stance = 'ready'; showContestedCheck(); } },
          { text: 'Busy', action: () => { gameState.heir.stance = 'busy'; showContestedCheck(); } }
        ]
      );
    }

    function showContestedCheck() {
      // Check for contested locations
      const exceptionBox = (text) => `<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è EXCEPTION:</span> ${text}</div>`;
      
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è REMINDER:</span> ${text}</div>`;
      
      const heirTurnBox = (text) => `<div style="background: rgba(212, 168, 71, 0.15); border: 2px solid var(--amber); padding: 15px; margin: 15px 0; border-radius: 8px; text-align: center;"><span style="color: var(--amber); font-weight: 600; font-size: 1.1rem;">üé≠ HEIR'S TURN</span><p style="margin-top: 8px; color: var(--text-primary);">${text}</p></div>`;
      
      // Standard prophecy reminder for place-characters phase (includes p22)
      const prophecyReminder = getProphecyReminderHtml('place-characters');
      
      const stance = gameState.heir.stance;
      const heirPlaced = gameState.heirPlacementsThisTurn || 0;
      const heirTotal = gameState.heir.characters.length;
      const isLastCharacter = (heirPlaced + 1) === heirTotal;
      
      // Check if this is p22 - needed for game logic
      const isP22Active = gameState.activeProphecy?.id === 'p22';
      const isP22SecondPlacement = isP22Active && gameState.heirP22FirstPlacementDone;
      
      // Skip contested check on Heir's last character - no strategic choice to make
      if (CONFIG.SKIP_CONTESTED_ON_LAST_HEIR_CHARACTER && isLastCharacter) {
        showSelectPriorityLocation();
        return;
      }
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Place Characters (Heir's Turn)`,
        `${heirTurnBox(`Placing character ${heirPlaced + 1} of ${heirTotal}`)}
         
         ${prophecyReminder}
         
         ${infoBox("The Heir sends whichever Character is assigned to the <strong>highest priority Location</strong> (not left to right).")}
         
         ${exceptionBox("Theater is NOT contested if the only character remaining to place there (for either side) is a Magician.")}
         ${exceptionBox("Workshop is NEVER contested.")}
         
         <details style="margin-top: 15px; color: var(--text-muted);">
           <summary style="cursor: pointer; color: var(--text-secondary);">Other Heir Rules & Definitions</summary>
           <div style="margin-top: 12px; font-size: 0.9rem;">
             <p style="margin-bottom: 8px;"><strong>üìç Heir Character Placement Order:</strong></p>
             <ul style="margin-left: 20px; margin-bottom: 12px;">
               <li><strong>Downtown:</strong> Left to right (higher ‚ö° first)</li>
               <li><strong>Theater:</strong> Left to right, <strong>except Magician always last</strong></li>
             </ul>
             <p style="margin-bottom: 8px;"><strong>Contested Location:</strong> Both you AND the Heir have at least one character assigned but NOT YET PLACED there.</p>
             <p style="margin-bottom: 8px;"><strong>Other Rules:</strong></p>
             <ul style="margin-left: 20px;">
               <li>The Heir never spends Shards</li>
               <li>The Heir gains +1‚ö° when using a Special Assignment card but ignores its text</li>
               <li>If Heir has 6‚ö° (rare): resolve as 5‚ö° and gain 1 Fame</li>
             </ul>
           </div>
         </details>
         
         <p style="margin-top: 15px;"><strong>Are any locations currently contested?</strong></p>`,
        [
          { text: 'Yes ‚Äî Contested locations exist', action: () => showSelectContestedLocation() },
          { text: 'No ‚Äî No contested locations', action: () => showSelectPriorityLocation() }
        ]
      );
    }
    
    function confirmAllHeirCharactersPlaced() {
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Confirm`,
        `<p><strong>Are you sure all Heir characters have been placed?</strong></p>
         
         <div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 15px 0; border-radius: 0 4px 4px 0;">
           <span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è WARNING:</span> This will end the Heir's turn and proceed to your turn. Make sure all Heir characters are actually on the board.
         </div>`,
        [
          { text: 'Yes ‚Äî End Heir\'s Turn', action: () => {
            gameState.heirP22FirstPlacementDone = false;
            // Store actual placements before marking as complete
            gameState.heirActualPlacements = gameState.heirPlacementsThisTurn || 0;
            gameState.heirPlacementsEndedEarly = true;
            // Mark Heir as having placed all characters
            gameState.heirPlacementsThisTurn = gameState.heir.characters.length;
            showPlayerTurnScreen();
          }},
          { text: 'No ‚Äî Go Back', action: () => showSelectPriorityLocation() }
        ]
      );
    }

    function showSelectContestedLocation() {
      // Player tells us which contested location to go to
      const stance = gameState.heir.stance;
      const priorityHtml = getLocationPriorityHtml(stance);
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Place Characters`,
        `<p><strong>Heir goes to a CONTESTED location</strong></p>
         
         <p style="margin-top: 10px;">If multiple locations are contested, use the Heir's priority list:</p>
         ${priorityHtml}
         
         <p style="margin-top: 15px;"><strong>Which contested location is the Heir going to?</strong></p>`,
        [
          { text: 'Downtown', action: () => showDowntownDiceInput() },
          { text: 'Market Row', action: () => showMarketRowInput() },
          { text: 'Dark Alley', action: () => showDarkAlleyInput() },
          { text: 'Theater', action: () => showTheaterInput() },
          { text: 'Back', action: () => showContestedCheck() }
        ]
      );
    }

    function showSelectPriorityLocation() {
      // No contested locations ‚Äî use priority list
      const stance = gameState.heir.stance;
      const priorityHtml = getLocationPriorityHtml(stance);
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Place Characters`,
        `<p><strong>No contested locations ‚Äî use Priority List</strong></p>
         
         ${priorityHtml}
         
         <p style="margin-top: 15px;"><strong>Which location is the Heir going to?</strong></p>`,
        [
          { text: 'Downtown', action: () => showDowntownDiceInput() },
          { text: 'Market Row', action: () => showMarketRowInput() },
          { text: 'Dark Alley', action: () => showDarkAlleyInput() },
          { text: 'Theater', action: () => showTheaterInput() },
          { text: 'Workshop', action: () => showWorkshopActions() },
          { text: 'Back', action: () => showContestedCheck() }
        ]
      );
      
      // Add the End Heir Placements button after render
      setTimeout(() => {
        const buttonsContainer = $('#action-buttons');
        if (buttonsContainer) {
          const endBtn = document.createElement('button');
          endBtn.className = 'btn';
          endBtn.style.cssText = 'background: #c0392b; border-color: #c0392b; color: white; margin-top: 15px; width: 100%;';
          endBtn.textContent = 'End Heir Placements';
          endBtn.addEventListener('click', confirmAllHeirCharactersPlaced);
          buttonsContainer.appendChild(endBtn);
        }
      }, 0);
    }

    function startPlaceCharactersSequence() {
      // Heir just finished placing a character
      gameState.heirPlacementsThisTurn = (gameState.heirPlacementsThisTurn || 0) + 1;
      
      // Check for p22 (Place Two Characters) - Heir places 2 characters per turn
      const isP22Active = gameState.activeProphecy?.id === 'p22';
      const heirCharacterCount = gameState.heir.characters.length;
      const heirRemaining = heirCharacterCount - gameState.heirPlacementsThisTurn;
      
      if (isP22Active && !gameState.heirP22FirstPlacementDone && heirRemaining > 0) {
        // p22 active, this was first placement, and Heir has more characters
        // Heir places a second character before returning to player
        gameState.heirP22FirstPlacementDone = true;
        showContestedCheck(); // Go directly to next Heir placement
      } else {
        // Normal flow: return to player's turn
        gameState.heirP22FirstPlacementDone = false;
        showPlayerTurnScreen();
      }
    }

    function showStanceRecheck() {
      // Stance changes are now detected automatically when Fame/Tricks change
      // So we just proceed directly to contested check
      showContestedCheck();
    }

    function showDowntownDiceInput() {
      // Check for The Gentleman's ability first
      const isGentleman = gameState.heirMagician?.id === 'gentleman';
      
      if (isGentleman) {
        showGentlemanMagicianCheck('downtown', () => checkMechanikerApprentice('downtown', showDowntownAPInput));
      } else {
        checkMechanikerApprentice('downtown', showDowntownAPInput);
      }
    }
    
    function showGentlemanMagicianCheck(location, continueFunc) {
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      const trickCount = gameState.heir.tricks.length;
      const previousFame = gameState.heir.fame;
      const newFame = previousFame + trickCount;
      const locationName = location.charAt(0).toUpperCase() + location.slice(1).replace('-', ' ');
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî ${locationName}`,
        `<p><strong>Is this the Magician being placed?</strong></p>
         
         ${magicianAbilityBox(`<strong>The Gentleman:</strong> When the Magician goes to Downtown, Market Row, or Dark Alley, the Heir gains Fame equal to the number of Tricks it has.`)}
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p>The Heir has <strong>${trickCount} Trick(s)</strong></p>
           <p style="color: var(--text-secondary); margin-top: 8px;">If this is the Magician ‚Üí <strong>+${trickCount} Fame</strong></p>
         </div>`,
        [
          { text: `Yes ‚Äî Magician (+${trickCount} Fame)`, action: () => {
            gameState.heir.fame += trickCount;
            updateGameDisplay();
            // Show board action for updating Fame
            setActionContent(
              `Turn ${gameState.currentTurn} ‚Äî ${locationName}`,
              `${magicianAbilityBox(`<strong>The Gentleman:</strong> Heir gains +${trickCount} Fame (${trickCount} Tricks)`)}
               ${boardAction(`Move the Heir's Fame marker from ${previousFame} to ${newFame}`)}`,
              [{ text: 'Continue', action: () => checkAndNotifyStanceChange(continueFunc) }]
            );
          }},
          { text: 'No ‚Äî Not the Magician', action: () => continueFunc() }
        ]
      );
    }
    
    function checkMechanikerApprentice(location, continueFunc) {
      // Only check for Mechaniker and only if first apprentice hasn't been placed
      const isMechaniker = gameState.heirMagician?.id === 'mechaniker';
      
      if (!isMechaniker || gameState.firstApprenticePlacedThisTurn) {
        // Check Optico next
        checkOpticoNonApprentice(location, continueFunc);
        return;
      }
      
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      
      const locationName = location.charAt(0).toUpperCase() + location.slice(1).replace('-', ' ');
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî ${locationName}`,
        `<p><strong>Is this an Apprentice?</strong></p>
         
         ${magicianAbilityBox(`<strong>The Mechaniker:</strong> The first Apprentice the Heir places each turn has <strong>+1 AP</strong>.`)}
         
         <p style="margin-top: 15px; color: var(--text-secondary);">If this is an Apprentice, remember to include the +1 AP bonus when selecting Action Points.</p>`,
        [
          { text: 'Yes ‚Äî Apprentice (+1 AP)', action: () => {
            gameState.firstApprenticePlacedThisTurn = true;
            continueFunc();
          }},
          { text: 'No ‚Äî Not an Apprentice', action: () => continueFunc() }
        ]
      );
    }
    
    // Helper to show Optico +1 AP reminder on AP selection screens
    function getOpticoAPReminderHtml() {
      const isOptico = gameState.heirMagician?.id === 'optico';
      const remainingBonus = (gameState.opticoPlayerSACards || 0) - (gameState.opticoNonApprenticesPlaced || 0);
      
      if (!isOptico || remainingBonus <= 0) return '';
      
      return `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;">
        <span style="color: #a6c; font-weight: 600;">‚ú® OPTICO:</span> 
        If this is a <strong>non-Apprentice</strong> (Magician/Specialist), include <strong>+1 AP</strong> in your selection. 
        <span style="color: var(--text-muted);">(${remainingBonus} bonus${remainingBonus > 1 ? 'es' : ''} remaining)</span>
      </div>`;
    }
    
    function checkOpticoNonApprentice(location, continueFunc) {
      // Only check for Optico and only if we haven't exhausted the bonus
      const isOptico = gameState.heirMagician?.id === 'optico';
      const remainingBonus = (gameState.opticoPlayerSACards || 0) - (gameState.opticoNonApprenticesPlaced || 0);
      
      if (!isOptico || remainingBonus <= 0) {
        continueFunc();
        return;
      }
      
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      
      const locationName = location.charAt(0).toUpperCase() + location.slice(1).replace('-', ' ');
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî ${locationName}`,
        `<p><strong>Is this a non-Apprentice (Magician/Specialist)?</strong></p>
         
         ${magicianAbilityBox(`<strong>The Great Optico:</strong> The first ${gameState.opticoPlayerSACards} non-Apprentice Character(s) gain <strong>+1 AP</strong>. (${remainingBonus} remaining)`)}
         
         <p style="margin-top: 15px; color: var(--text-secondary);">If this is a Magician or Specialist, remember to include the +1 AP bonus when selecting Action Points.</p>`,
        [
          { text: 'Yes ‚Äî Non-Apprentice (+1 AP)', action: () => {
            gameState.opticoNonApprenticesPlaced = (gameState.opticoNonApprenticesPlaced || 0) + 1;
            continueFunc();
          }},
          { text: 'No ‚Äî This is an Apprentice', action: () => continueFunc() }
        ]
      );
    }
    
    function showDowntownAPInput() {
      const heirProphecyReminder = getHeirProphecyReminderHtml('heir-downtown');
      const opticoReminder = getOpticoAPReminderHtml();
      
      // Ask for Action Points first
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Downtown`,
        `<p>The Heir is placing a Character at Downtown.</p>
         ${heirProphecyReminder}
         ${opticoReminder}
         <p><strong>How many Action Points does this Character have?</strong></p>
         <p style="color: var(--text-secondary); font-size: 0.9rem;">Include the slot's AP modifier and the Character's base AP.</p>
         <div class="ap-selector" style="display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap;">
           ${[1,2,3,4,5].map(ap => `
             <button class="btn ap-btn" data-ap="${ap}" style="min-width: 50px;">${ap} AP</button>
           `).join('')}
         </div>`,
        []
      );
      
      // Add event listeners to AP buttons
      setTimeout(() => {
        $$('.ap-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const ap = parseInt(btn.dataset.ap);
            showDowntownDiceSelection(ap);
          });
        });
      }, 0);
    }

    function showDowntownDiceSelection(actionPoints) {
      const diceCount = getDowntownDiceCount(actionPoints);
      const heirSchool = gameState.heirMagician.school;
      const saved = gameState.downtownDice;
      
      // Helper to generate select options with saved value pre-selected
      const selectOption = (value, label, savedValue) => 
        `<option value="${value}" ${savedValue === value ? 'selected' : ''}>${label}</option>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Downtown (${actionPoints} AP)`,
        `<p>The Heir will collect <strong>${diceCount} dice</strong>.</p>
         <p><strong>What are the Downtown dice showing?</strong></p>
         <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">Select the face showing on each die. Values are saved within the turn.</p>
         
         <div style="display: flex; flex-direction: column; gap: 20px; max-width: 500px; margin: 0 auto;">
           
           <!-- Character Dice (Grey) -->
           <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
             <div style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">Character Dice (Grey)</div>
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
               <div>
                 <label style="color: var(--text-secondary); font-size: 0.85rem;">Apprentice Die:</label>
                 <select id="apprentice-die" style="width: 100%; padding: 8px; margin-top: 4px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px;">
                   ${selectOption('x', 'X', saved.apprentice)}
                   ${selectOption('apprentice', 'Apprentice', saved.apprentice)}
                 </select>
               </div>
               <div>
                 <label style="color: var(--text-secondary); font-size: 0.85rem;">Specialist Die:</label>
                 <select id="specialist-die" style="width: 100%; padding: 8px; margin-top: 4px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px;">
                   ${selectOption('x', 'X', saved.specialist)}
                   ${selectOption('engineer', 'Engineer', saved.specialist)}
                   ${selectOption('manager', 'Manager', saved.specialist)}
                   ${selectOption('assistant', 'Assistant', saved.specialist)}
                 </select>
               </div>
             </div>
           </div>
           
           <!-- Trick Dice (White) -->
           <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
             <div style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">Trick Dice (White)</div>
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
               <div>
                 <label style="color: var(--text-secondary); font-size: 0.85rem;">Trick Die 1:</label>
                 <select id="trick-die-1" style="width: 100%; padding: 8px; margin-top: 4px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px;">
                   ${selectOption('x', 'X', saved.trick1)}
                   ${selectOption('mechanical', 'Mechanical', saved.trick1)}
                   ${selectOption('spiritual', 'Spiritual', saved.trick1)}
                   ${selectOption('escape', 'Escape', saved.trick1)}
                   ${selectOption('optical', 'Optical', saved.trick1)}
                   ${selectOption('wild', '? (Wild)', saved.trick1)}
                 </select>
               </div>
               <div>
                 <label style="color: var(--text-secondary); font-size: 0.85rem;">Trick Die 2:</label>
                 <select id="trick-die-2" style="width: 100%; padding: 8px; margin-top: 4px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px;">
                   ${selectOption('x', 'X', saved.trick2)}
                   ${selectOption('mechanical', 'Mechanical', saved.trick2)}
                   ${selectOption('spiritual', 'Spiritual', saved.trick2)}
                   ${selectOption('escape', 'Escape', saved.trick2)}
                   ${selectOption('optical', 'Optical', saved.trick2)}
                   ${selectOption('wild', '? (Wild)', saved.trick2)}
                 </select>
               </div>
             </div>
           </div>
           
           <!-- Bank Dice (Black) -->
           <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
             <div style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">Bank Dice (Black)</div>
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
               <div>
                 <label style="color: var(--text-secondary); font-size: 0.85rem;">Bank Die 1:</label>
                 <select id="bank-die-1" style="width: 100%; padding: 8px; margin-top: 4px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px;">
                   ${selectOption('x', 'X', saved.bank1)}
                   ${selectOption('3', '3 Coins', saved.bank1)}
                   ${selectOption('4', '4 Coins', saved.bank1)}
                   ${selectOption('5', '5 Coins', saved.bank1)}
                   ${selectOption('6', '6 Coins', saved.bank1)}
                 </select>
               </div>
               <div>
                 <label style="color: var(--text-secondary); font-size: 0.85rem;">Bank Die 2:</label>
                 <select id="bank-die-2" style="width: 100%; padding: 8px; margin-top: 4px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px;">
                   ${selectOption('x', 'X', saved.bank2)}
                   ${selectOption('3', '3 Coins', saved.bank2)}
                   ${selectOption('4', '4 Coins', saved.bank2)}
                   ${selectOption('5', '5 Coins', saved.bank2)}
                   ${selectOption('6', '6 Coins', saved.bank2)}
                 </select>
               </div>
             </div>
           </div>
           
         </div>`,
        [{ text: 'Calculate Heir\'s Actions', action: () => calculateDowntownActions(actionPoints) }]
      );
    }

    function calculateDowntownActions(actionPoints) {
      // Gather dice values
      const diceState = {
        trick1: $('#trick-die-1').value,
        trick2: $('#trick-die-2').value,
        apprentice: $('#apprentice-die').value,
        specialist: $('#specialist-die').value,
        bank1: $('#bank-die-1').value,
        bank2: $('#bank-die-2').value
      };
      
      // Save dice state for next Downtown visit this turn
      gameState.downtownDice = { ...diceState };
      
      // Store for later use in this flow
      gameState.pendingDowntown = { actionPoints, diceState };
      
      // Check if Heir will learn a trick (based on dice and conditions)
      const willLearnTrick = checkIfHeirWillLearnTrick(diceState);
      
      if (willLearnTrick) {
        // Need to ask about player tricks first
        showDowntownPlayerTrickCheck(willLearnTrick);
      } else {
        // No trick learning - proceed directly to instructions (trick skipped, die NOT consumed)
        showDowntownFinalInstructions('skipped');
      }
    }
    
    function checkIfHeirWillLearnTrick(diceState) {
      // Check if heir should learn a trick (conditions from shouldLearnTrick())
      if (!shouldLearnTrick()) return null;
      
      // Check if there's a usable trick die
      const heirSchool = gameState.heirMagician.school;
      const targetLevel = getTargetTrickLevel();
      
      // Priority: Heir's school die > Wild > Any other school
      let trickCategory = null;
      
      if (diceState.trick1 === heirSchool || diceState.trick2 === heirSchool) {
        trickCategory = heirSchool;
      } else if (diceState.trick1 === 'wild' || diceState.trick2 === 'wild') {
        trickCategory = heirSchool; // Wild uses heir's favorite
      } else {
        // Check for any other school (not X)
        const otherSchools = ['mechanical', 'spiritual', 'escape', 'optical'];
        for (const school of otherSchools) {
          if (diceState.trick1 === school || diceState.trick2 === school) {
            trickCategory = school;
            break;
          }
        }
      }
      
      if (!trickCategory) return null;
      
      // Check if tricks are available at this level/school
      const availableTricks = getAvailableTricksAtLevelForSchool(targetLevel, trickCategory);
      if (availableTricks.length === 0) return null;
      
      return { level: targetLevel, school: trickCategory };
    }
    
    function showDowntownPlayerTrickCheck(trickInfo) {
      const { level, school } = trickInfo;
      const schoolDisplay = school.charAt(0).toUpperCase() + school.slice(1);
      
      // Get all tricks at this level/school (before filtering)
      const levelKey = level === 1 ? 'level_1' : level === 2 ? 'level_16' : 'level_36';
      let allTricksAtLevel = ALL_TRICKS[school][levelKey];
      
      // Apply Level 1 exception filter
      if (level === 1) {
        const basicComponents = ['wood', 'glass', 'metal', 'fabric'];
        allTricksAtLevel = allTricksAtLevel.filter(trick => {
          const componentTypes = Object.keys(trick.components);
          if (componentTypes.length === 1 && basicComponents.includes(componentTypes[0])) {
            return false;
          }
          return true;
        });
      }
      
      // Get already owned tricks
      const heirTrickIds = gameState.heir.tricks.map(t => t.id);
      const playerTrickIds = gameState.player.tricks.map(t => t.id);
      
      // Build checkboxes for tricks player might have taken
      const trickCheckboxes = allTricksAtLevel.map(trick => {
        const alreadyOwned = heirTrickIds.includes(trick.id) || playerTrickIds.includes(trick.id);
        const ownedBy = heirTrickIds.includes(trick.id) ? ' (Heir has)' : playerTrickIds.includes(trick.id) ? ' (You have)' : '';
        
        return `
          <label style="display: flex; align-items: center; gap: 10px; padding: 8px; background: ${alreadyOwned ? 'var(--bg-main)' : 'var(--bg-card)'}; border-radius: 4px; ${alreadyOwned ? 'opacity: 0.5;' : 'cursor: pointer;'}">
            <input type="checkbox" class="player-trick-checkbox" data-trick-id="${trick.id}" ${alreadyOwned ? 'disabled checked' : ''}>
            <span style="flex: 1;">
              <strong>${trick.name}</strong>
              <span style="color: var(--text-muted); font-size: 0.85rem;">${ownedBy}</span>
            </span>
            <span style="color: var(--text-secondary); font-size: 0.85rem;">
              ${trick.fame}‚òÖ ${trick.coins}ü™ô ${trick.shards > 0 ? trick.shards + 'üíé' : ''}
            </span>
          </label>`;
      }).join('');
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Downtown (Trick Check)`,
        `<p>The Heir will learn a <strong>Level ${level} ${schoolDisplay}</strong> trick.</p>
         
         <p style="margin: 15px 0;"><strong>Do you have any of these tricks?</strong></p>
         <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">Check any tricks you currently own (so we know what's still in the deck).</p>
         
         <div style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">
           ${trickCheckboxes}
         </div>`,
        [
          { text: 'Continue', action: () => processPlayerTrickSelection(trickInfo) }
        ]
      );
    }
    
    function processPlayerTrickSelection(trickInfo) {
      // Get selected tricks and add to player's tricks
      $$('.player-trick-checkbox').forEach(checkbox => {
        if (checkbox.checked && !checkbox.disabled) {
          const trickId = checkbox.dataset.trickId;
          // Find the trick data
          const levelKey = trickInfo.level === 1 ? 'level_1' : trickInfo.level === 2 ? 'level_16' : 'level_36';
          const trick = ALL_TRICKS[trickInfo.school][levelKey].find(t => t.id === trickId);
          if (trick && !gameState.player.tricks.find(t => t.id === trickId)) {
            gameState.player.tricks.push({
              ...trick,
              school: trickInfo.school,
              level: trickInfo.level
            });
          }
        }
      });
      
      // Now show available tricks for Heir to take
      showDowntownHeirTrickSelection(trickInfo);
    }
    
    function showDowntownHeirTrickSelection(trickInfo) {
      const { level, school } = trickInfo;
      const schoolDisplay = school.charAt(0).toUpperCase() + school.slice(1);
      
      // Get available tricks (now properly excluding player's tricks)
      const availableTricks = getAvailableTricksAtLevelForSchool(level, school);
      
      if (availableTricks.length === 0) {
        // No tricks available - skip to other instructions (trick skipped, die NOT consumed)
        showDowntownFinalInstructions('skipped');
        return;
      }
      
      // Check if Heir needs to return a trick (4 slots max)
      const needsToReturn = gameState.heir.tricks.length >= 4;
      let returnNote = '';
      if (needsToReturn) {
        const lowestYieldTrick = gameState.heir.tricks[gameState.heir.tricks.length - 1];
        returnNote = `<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 15px 0; border-radius: 0 4px 4px 0;">
          <span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è SLOTS FULL:</span> The Heir has 4 tricks. Before learning a new one, return <strong>${lowestYieldTrick.name}</strong> (rightmost/lowest yield).
        </div>
        <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Return <strong>${lowestYieldTrick.name}</strong> card, its Symbol marker, and all its Trick markers (including from Theater) to Dahlgaard's Residence</span></div>`;
      }
      
      // Build buttons for each available trick
      const trickButtons = availableTricks.map(trick => `
        <button class="btn heir-trick-btn" data-trick-id="${trick.id}" style="display: block; width: 100%; text-align: left; padding: 12px; margin-bottom: 8px;">
          <strong>${trick.name}</strong>
          <span style="float: right; color: var(--text-secondary);">
            ${trick.fame}‚òÖ ${trick.coins}ü™ô ${trick.shards > 0 ? trick.shards + 'üíé' : ''}
          </span>
        </button>
      `).join('');
      
      // Conditional instruction text based on number of available tricks
      const trickInstruction = availableTricks.length === 1
        ? `<p>There is only <strong>1 available</strong> Level ${level} ${schoolDisplay} trick for the Heir:</p>`
        : `<p>Shuffle these <strong>${availableTricks.length} available</strong> Level ${level} ${schoolDisplay} tricks and draw one randomly for the Heir:</p>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Downtown (Heir Takes Trick)`,
        `${trickInstruction}
         
         ${returnNote}
         
         <div style="margin: 20px 0;">
           ${trickButtons}
         </div>
         
         <p style="color: var(--text-secondary); font-size: 0.9rem;">Click the trick the Heir received.</p>`,
        []
      );
      
      // Add click handlers
      setTimeout(() => {
        $$('.heir-trick-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const trickId = btn.dataset.trickId;
            selectHeirTrickFromDowntown(trickId, trickInfo);
          });
        });
      }, 0);
    }
    
    function selectHeirTrickFromDowntown(trickId, trickInfo) {
      const { level, school } = trickInfo;
      const levelKey = level === 1 ? 'level_1' : level === 2 ? 'level_16' : 'level_36';
      const trick = ALL_TRICKS[school][levelKey].find(t => t.id === trickId);
      
      if (!trick) return;
      
      // If slots full (4 max), remove rightmost trick first
      if (gameState.heir.tricks.length >= 4) {
        const removedTrick = gameState.heir.tricks.pop();
        // Note: removed trick goes back to deck - it's now available again
      }
      
      // Add the new trick to Heir
      addTrickToHeir(trick, level, school);
      
      // Show yield ordering help
      showDowntownTrickPlacement(trick, level);
    }
    
    function showDowntownTrickPlacement(newTrick, level) {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      // Get components for shopping list
      const newComponentTypes = getUniqueComponentTypes(newTrick.components);
      const shoppingListDisplay = newComponentTypes.join(', ');
      
      // Show the current order of tricks (sorted by yield) - horizontal like cards on board
      const trickOrderHtml = gameState.heir.tricks.map((trick, index) => {
        const isNew = trick.id === newTrick.id;
        return `
          <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: ${isNew ? 'rgba(212, 168, 71, 0.15)' : 'var(--bg-card)'};
            border: 2px solid ${isNew ? 'var(--amber)' : 'var(--border)'};
            border-radius: 6px;
            min-width: 90px;
            max-width: 110px;
            text-align: center;
            ${isNew ? 'box-shadow: 0 0 10px rgba(212, 168, 71, 0.3);' : ''}
          ">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Slot ${index + 1}</div>
            <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; line-height: 1.2;">${trick.name}</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">${trick.fame}‚òÖ ${trick.coins}ü™ô${trick.shards > 0 ? ' ' + trick.shards + 'üíé' : ''}</div>
            ${isNew ? '<div style="color: var(--amber); font-size: 0.75rem; margin-top: 6px; font-weight: 600;">NEW</div>' : ''}
          </div>`;
      }).join('');
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Downtown (Place Trick)`,
        `<p><strong>${newTrick.name}</strong> learned!</p>
         
         ${boardAction(`Place <strong>${newTrick.name}</strong> card on the Heir's board with ${newTrick.markers} Trick marker(s). It starts Prepared.`)}
         
         ${boardAction(`Add one of each Component type to the Heir's Shopping List (if not already there): <strong>${shoppingListDisplay}</strong>`)}
         
         <p style="margin: 15px 0;"><strong>Trick Order (highest yield on left):</strong></p>
         <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
           ${trickOrderHtml}
         </div>
         <div style="display: flex; justify-content: center; gap: 20px; color: var(--text-muted); font-size: 0.85rem;">
           <span>‚Üê Higher Yield</span>
           <span>Lower Yield ‚Üí</span>
         </div>`,
        [
          { text: 'Done ‚Äî Continue Placement', action: () => {
            checkAndNotifyStanceChange(() => {
              // Check if there are remaining dice after trick was taken
              const { actionPoints } = gameState.pendingDowntown;
              const diceCount = getDowntownDiceCount(actionPoints);
              
              // If only 1 die was collected and it was used for the trick, skip to placement
              if (diceCount <= 1) {
                startPlaceCharactersSequence();
              } else {
                showDowntownFinalInstructions('taken');
              }
            });
          }}
        ]
      );
    }
    
    // trickStatus: 'skipped' = conditions not met (no die consumed), 'taken' = trick selected (die consumed)
    function showDowntownFinalInstructions(trickStatus = 'skipped') {
      const { actionPoints, diceState } = gameState.pendingDowntown;
      
      // Generate remaining instructions with the appropriate trick status
      const instructions = generateDowntownInstructions(actionPoints, diceState, trickStatus);
      const instructionsHtml = formatDowntownInstructions(instructions);
      
      // Update display to show new coin count
      updateGameDisplay();
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Downtown Actions`,
        `<div style="margin-bottom: 20px;">${instructionsHtml}</div>`,
        [
          { text: 'Done ‚Äî Continue Placement', action: () => startPlaceCharactersSequence() }
        ]
      );
    }

    // ============================================
    // MARKET ROW LOCATION
    // ============================================

    function showMarketRowInput() {
      // Check for The Gentleman's ability first
      const isGentleman = gameState.heirMagician?.id === 'gentleman';
      
      if (isGentleman) {
        showGentlemanMagicianCheck('market-row', () => checkMechanikerApprentice('market-row', showMarketRowAPInput));
      } else {
        checkMechanikerApprentice('market-row', showMarketRowAPInput);
      }
    }
    
    function showMarketRowAPInput() {
      const heirProphecyReminder = getHeirProphecyReminderHtml('heir-market');
      const opticoReminder = getOpticoAPReminderHtml();
      
      // Ask for Action Points first
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Market Row`,
        `<p>The Heir is placing a Character at Market Row.</p>
         ${heirProphecyReminder}
         ${opticoReminder}
         <p style="margin-top: 15px;"><strong>How many Action Points does this Character have?</strong></p>
         <p style="color: var(--text-secondary); font-size: 0.9rem;">Include the slot's AP modifier and the Character's base AP.</p>
         <div class="ap-selector" style="display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap;">
           ${[1,2,3,4,5].map(ap => `
             <button class="btn ap-btn" data-ap="${ap}" style="min-width: 50px;">${ap} AP</button>
           `).join('')}
         </div>`,
        []
      );

      // Add click handlers for AP buttons
      setTimeout(() => {
        $$('.ap-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const ap = parseInt(btn.dataset.ap);
            showMarketRowComponentInput(ap);
          });
        });
      }, 0);
    }

    function showMarketRowComponentInput(actionPoints) {
      // Get the Heir's shopping list
      const shoppingList = gameState.heir.shoppingList;
      
      if (shoppingList.length === 0) {
        setActionContent(
          `Turn ${gameState.currentTurn} ‚Äî Market Row (${actionPoints} AP)`,
          `<p>The Heir's Shopping List is empty.</p>
           <p style="color: var(--text-secondary);">No components to acquire at Market Row.</p>`,
          [
            { text: 'Done ‚Äî Continue Placement', action: () => startPlaceCharactersSequence() }
          ]
        );
        return;
      }

      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Market Row (${actionPoints} AP)`,
        `<p>The Heir can order up to <strong>${actionPoints} components</strong>.</p>
         <p style="margin-top: 10px;"><strong>Heir's Shopping List:</strong> ${shoppingList.map(c => formatComponentWithTier(c)).join(', ')}</p>
         <p style="margin-top: 15px;"><strong>Which components from the Shopping List are currently available in the Market?</strong></p>
         
         <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 20px; max-width: 500px; margin-left: auto; margin-right: auto;">
           ${shoppingList.map((component, index) => {
             const tier = getComponentTier(component);
             const tierColor = tier === 'basic' ? '#8bc98a' : tier === 'advanced' ? '#c9a87a' : '#b87ac9';
             return `
             <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
               <input type="checkbox" id="market-component-${index}" data-component="${component}" style="width: 18px; height: 18px;">
               <span style="display: inline-block; width: 70px; font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; background: ${tierColor}22; color: ${tierColor}; text-transform: uppercase;">${tier}</span>
               <span style="flex: 1;">${component.charAt(0).toUpperCase() + component.slice(1)}</span>
               <span style="color: var(--text-muted); font-size: 0.85rem;">‚úì In Market</span>
             </label>
           `}).join('')}
         </div>`,
        [
          { text: 'Calculate Heir\'s Actions', action: () => calculateMarketRowActions(actionPoints) }
        ]
      );
    }
    
    function getComponentTier(component) {
      const c = component.toLowerCase();
      if (COMPONENTS.basic.includes(c)) return 'basic';
      if (COMPONENTS.advanced.includes(c)) return 'advanced';
      if (COMPONENTS.superior.includes(c)) return 'superior';
      return 'unknown';
    }
    
    function formatComponentWithTier(component) {
      const tier = getComponentTier(component);
      const name = component.charAt(0).toUpperCase() + component.slice(1);
      return name;
    }

    function calculateMarketRowActions(actionPoints) {
      const shoppingList = [...gameState.heir.shoppingList];
      
      // Get which components are available in the market
      const availableInMarket = [];
      const notAvailableInMarket = [];
      
      shoppingList.forEach((component, index) => {
        const checkbox = $(`#market-component-${index}`);
        if (checkbox && checkbox.checked) {
          availableInMarket.push(component);
        } else {
          notAvailableInMarket.push(component);
        }
      });

      // Generate instructions
      const instructions = generateMarketRowInstructions(actionPoints, availableInMarket, notAvailableInMarket);
      const instructionsHtml = formatMarketRowInstructions(instructions);

      // Actually remove available components from the shopping list (they're discarded)
      gameState.heir.shoppingList = gameState.heir.shoppingList.filter(
        component => !availableInMarket.includes(component)
      );
      
      // Update sidebar to reflect the change
      updateGameDisplay();

      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Market Row Actions`,
        `<div style="margin-bottom: 20px;">${instructionsHtml}</div>`,
        [
          { text: 'Done ‚Äî Player\'s Turn', action: () => startPlaceCharactersSequence() }
        ]
      );
    }

    function generateMarketRowInstructions(actionPoints, availableInMarket, notAvailableInMarket) {
      const instructions = [];
      
      // Step 1: Discard available components from Shopping List
      if (availableInMarket.length > 0) {
        instructions.push({
          type: 'action',
          step: 1,
          text: `<strong>Discard from Shopping List:</strong> ${availableInMarket.join(', ')}`,
          boardAction: `Remove ${availableInMarket.join(', ')} from Heir's Shopping List box`
        });
      } else {
        instructions.push({
          type: 'info',
          text: `No components from the Shopping List are currently available in the Market.`
        });
      }

      // Step 2: Order components not available (up to AP limit)
      if (notAvailableInMarket.length > 0) {
        const componentsToOrder = Math.min(notAvailableInMarket.length, actionPoints);
        
        if (componentsToOrder > 0) {
          // Randomly select which components to order if more needed than AP allows
          let orderedComponents;
          if (notAvailableInMarket.length <= actionPoints) {
            orderedComponents = notAvailableInMarket;
          } else {
            // Need to randomly select - tell user to do this
            orderedComponents = null; // Will be handled in display
          }

          if (orderedComponents) {
            instructions.push({
              type: 'action',
              step: 2,
              text: `<strong>Order components:</strong> ${orderedComponents.join(', ')}`,
              boardAction: `Place ${orderedComponents.join(', ')} onto the first ${orderedComponents.length} empty Order slot(s)`
            });
          } else {
            instructions.push({
              type: 'action',
              step: 2,
              text: `<strong>Randomly select ${actionPoints} component(s) to order</strong> from: ${notAvailableInMarket.join(', ')}`,
              substeps: [
                `The Heir has ${actionPoints} AP but ${notAvailableInMarket.length} components need ordering ‚Äî randomly select ${actionPoints}`
              ],
              boardAction: `Place the ${actionPoints} randomly selected component(s) onto empty Order slot(s)`
            });
          }
        }
      } else if (availableInMarket.length === 0) {
        instructions.push({
          type: 'info',
          text: `The Heir's Shopping List is now empty. No components to order.`
        });
      } else {
        instructions.push({
          type: 'info',
          text: `All Shopping List components are now available in the Market. Nothing to order.`
        });
      }

      // Summary
      const totalDiscarded = availableInMarket.length;
      const totalOrdered = Math.min(notAvailableInMarket.length, actionPoints);
      
      instructions.push({
        type: 'summary',
        text: `<strong>Summary:</strong> Discarded ${totalDiscarded} component(s), ordered ${totalOrdered} component(s).`
      });

      return instructions;
    }

    function formatMarketRowInstructions(instructions) {
      let html = '';
      
      instructions.forEach(inst => {
        if (inst.type === 'action') {
          html += `<div style="margin-bottom: 15px; padding: 12px; background: var(--bg-card); border-radius: 6px; border-left: 3px solid var(--amber);">`;
          html += `<div style="font-weight: 600; margin-bottom: 8px;">Step ${inst.step}</div>`;
          html += `<div style="margin-bottom: 8px;">${inst.text}</div>`;
          
          if (inst.boardAction) {
            html += `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;">`;
            html += `<span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${inst.boardAction}</span>`;
            html += `</div>`;
          }
          
          if (inst.substeps && inst.substeps.length > 0) {
            html += `<ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">`;
            inst.substeps.forEach(sub => {
              html += `<li style="margin-bottom: 4px;">${sub}</li>`;
            });
            html += `</ul>`;
          }
          html += `</div>`;
        } else if (inst.type === 'info') {
          html += `<div style="margin-bottom: 15px; padding: 12px; background: var(--bg-card); border-radius: 6px; color: var(--text-secondary);">`;
          html += inst.text;
          html += `</div>`;
        } else if (inst.type === 'summary') {
          html += `<div style="margin-top: 15px; padding: 12px; background: var(--bg-dark); border-radius: 6px; border: 1px solid var(--border);">`;
          html += inst.text;
          html += `</div>`;
        }
      });
      
      return html;
    }

    // ============================================
    // DARK ALLEY LOCATION
    // ============================================

    // Dark Alley Special Assignment card count based on AP and difficulty
    const DARK_ALLEY_CARD_COUNT = {
      easy:   { 1: 1, 2: 1, 3: 1, 4: 2, 5: 2 },
      normal: { 1: 1, 2: 1, 3: 2, 4: 2, 5: 3 },
      hard:   { 1: 1, 2: 2, 3: 2, 4: 3, 5: 3 }
    };

    function getDarkAlleyCardCount(actionPoints) {
      const difficulty = gameState.difficulty;
      return DARK_ALLEY_CARD_COUNT[difficulty][actionPoints] || 1;
    }

    function showDarkAlleyInput() {
      // Check for The Gentleman's ability first
      const isGentleman = gameState.heirMagician?.id === 'gentleman';
      
      if (isGentleman) {
        showGentlemanMagicianCheck('dark-alley', () => checkMechanikerApprentice('dark-alley', showDarkAlleyAPInput));
      } else {
        checkMechanikerApprentice('dark-alley', showDarkAlleyAPInput);
      }
    }
    
    function showDarkAlleyAPInput() {
      const heirProphecyReminder = getHeirProphecyReminderHtml('heir-darkalley');
      const opticoReminder = getOpticoAPReminderHtml();
      
      // Ask for Action Points first
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Dark Alley`,
        `<p>The Heir is placing a Character at Dark Alley.</p>
         ${heirProphecyReminder}
         ${opticoReminder}
         <p><strong>How many Action Points does this Character have?</strong></p>
         <p style="color: var(--text-secondary); font-size: 0.9rem;">Include the slot's AP modifier and the Character's base AP.</p>
         <div class="ap-selector" style="display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap;">
           ${[1,2,3,4,5].map(ap => `
             <button class="btn ap-btn" data-ap="${ap}" style="min-width: 50px;">${ap} AP</button>
           `).join('')}
         </div>`,
        []
      );

      // Add click handlers for AP buttons
      setTimeout(() => {
        $$('.ap-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const ap = parseInt(btn.dataset.ap);
            showDarkAlleyCoinFlip(ap);
          });
        });
      }, 0);
    }

    function showDarkAlleyCoinFlip(actionPoints) {
      const cardCount = getDarkAlleyCardCount(actionPoints);
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Dark Alley (${actionPoints} AP)`,
        `<p><strong>Step 1: Prophecy Rotation</strong></p>
         <p style="color: var(--text-secondary); margin-bottom: 20px;">Flip a coin to decide whether the Heir rotates the Prophecies.</p>
         
         <div id="coin-container" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
           <div id="coin" style="
             width: 80px;
             height: 80px;
             border-radius: 50%;
             background: linear-gradient(145deg, var(--amber), #8a6914);
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 2.5rem;
             box-shadow: 0 4px 15px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.2);
             cursor: pointer;
             transition: transform 0.1s ease;
             border: 3px solid #8a6914;
           ">‚ú¶</div>
           <button id="flip-coin-btn" class="btn" style="min-width: 150px;">Flip Coin</button>
         </div>
         
         <div id="coin-result" style="display: none; text-align: center; margin-top: 20px;"></div>`,
        []
      );

      setTimeout(() => {
        const coin = $('#coin');
        const flipBtn = $('#flip-coin-btn');
        
        flipBtn.addEventListener('click', () => {
          // Disable button during animation
          flipBtn.disabled = true;
          flipBtn.textContent = 'Flipping...';
          
          // Animate the coin
          let flips = 0;
          const maxFlips = 10;
          const flipInterval = setInterval(() => {
            flips++;
            coin.style.transform = `rotateY(${flips * 180}deg)`;
            coin.innerHTML = flips % 2 === 0 ? '‚ú¶' : '‚úß';
            
            if (flips >= maxFlips) {
              clearInterval(flipInterval);
              
              // Determine result (50/50)
              const rotate = Math.random() < 0.5;
              
              // Show result
              coin.innerHTML = rotate ? '‚Üª' : '‚Äî';
              coin.style.background = rotate 
                ? 'linear-gradient(145deg, #4a9e6b, #2d5e40)' 
                : 'linear-gradient(145deg, #9e4a4a, #5e2d2d)';
              
              const resultDiv = $('#coin-result');
              resultDiv.style.display = 'block';
              
              if (rotate) {
                // Check for Priestess ability
                const isPriestess = gameState.heirMagician?.id === 'priestess';
                const priestessNote = isPriestess
                  ? `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 10px auto; border-radius: 0 4px 4px 0; max-width: 400px; text-align: left;">
                       <span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);"><strong style="color: #a6c;">Priestess:</strong> Swap the next turn's Prophecy (Pending 1) with a randomly drawn one from the Prophecy deck.</span>
                     </div>`
                  : '';
                
                resultDiv.innerHTML = `
                  <div style="color: var(--success); font-size: 1.3rem; font-weight: 600; margin-bottom: 10px;">
                    ‚Üª ROTATE PROPHECIES
                  </div>
                  <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 10px auto; border-radius: 0 4px 4px 0; max-width: 400px; text-align: left;">
                    <span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Rotate all Prophecies one position (Active ‚Üí Discard, Pending 1 ‚Üí Active, etc.)</span>
                  </div>
                  ${priestessNote}`;
              } else {
                resultDiv.innerHTML = `
                  <div style="color: #9e6a6a; font-size: 1.3rem; font-weight: 600; margin-bottom: 10px;">
                    ‚Äî NO ROTATION
                  </div>
                  <p style="color: var(--text-secondary);">The Prophecies stay in their current positions.</p>`;
              }
              
              // Add continue button
              resultDiv.innerHTML += `
                <button id="continue-dark-alley-btn" class="btn" style="margin-top: 20px;">${rotate ? 'Select New Prophecy' : 'Continue to Step 2'}</button>
              `;
              
              $('#continue-dark-alley-btn').addEventListener('click', () => {
                if (rotate) {
                  // Rotation happened - select new prophecy first
                  showProphecySelection(() => showDarkAlleyCardDraw(actionPoints, cardCount));
                } else {
                  showDarkAlleyCardDraw(actionPoints, cardCount);
                }
              });
            }
          }, 100);
        });
        
        // Allow clicking coin to flip too
        coin.addEventListener('click', () => {
          if (!flipBtn.disabled) {
            flipBtn.click();
          }
        });
      }, 0);
    }

    function showDarkAlleyCardDraw(actionPoints, cardCount) {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      // Calculate which cards to draw based on fewest owned + priority
      const cardsToDraw = calculateSACardsToDraw(cardCount);
      
      // Count how many of each color to draw
      const drawCounts = {};
      cardsToDraw.forEach(color => {
        drawCounts[color] = (drawCounts[color] || 0) + 1;
      });
      
      // Build visual pile display - order matches physical board: Downtown, Market Row, Workshop, Theater
      // TODO: Add Academy pile when implementing Academy expansion
      const piles = [
        { key: 'downtown', icon: 'assets/images/locations/downtown.png', name: 'Downtown' },
        { key: 'market', icon: 'assets/images/locations/market_row.png', name: 'Market Row' },
        { key: 'workshop', icon: 'assets/images/locations/workshop.png', name: 'Workshop' },
        { key: 'theater', icon: 'assets/images/locations/theatre.png', name: 'Theater' }
      ];
      
      const pilesHtml = `
        <div style="display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
          ${piles.map(pile => {
            const isDrawing = drawCounts[pile.key] > 0;
            const count = drawCounts[pile.key] || 0;
            
            return `<div style="
              width: 70px;
              height: 95px;
              background: ${isDrawing ? 'rgba(212, 168, 71, 0.15)' : 'transparent'};
              border: 2px ${isDrawing ? 'solid var(--amber)' : 'dashed var(--border)'};
              border-radius: 6px;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              gap: 4px;
              ${isDrawing ? 'box-shadow: 0 0 12px rgba(212, 168, 71, 0.3);' : 'opacity: 0.5;'}
            ">
              <img src="${pile.icon}" alt="${pile.name}" style="width: 40px; height: 40px; object-fit: contain;">
              <span style="font-size: 0.7rem; color: ${isDrawing ? 'var(--amber)' : 'var(--text-muted)'}; text-align: center; line-height: 1.2;">${pile.name}</span>
              ${isDrawing ? `<span style="font-size: 0.85rem; font-weight: 600; color: var(--amber);">√ó${count}</span>` : ''}
            </div>`;
          }).join('')}
        </div>`;
      
      // Show current counts
      const currentCounts = gameState.heir.specialAssignments;
      const countsDisplay = `Downtown: ${currentCounts.downtown}, Market: ${currentCounts.market}, Workshop: ${currentCounts.workshop}, Theater: ${currentCounts.theater}`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Dark Alley (${actionPoints} AP)`,
        `<p><strong>Step 2: Draw Special Assignment Cards</strong></p>
         <p style="margin: 15px 0;">The Heir draws <strong>${cardCount} Special Assignment card${cardCount > 1 ? 's' : ''}</strong>.</p>
         
         ${pilesHtml}
         
         ${boardAction(`Draw ${cardCount} SA card${cardCount > 1 ? 's' : ''} from the highlighted pile${Object.keys(drawCounts).length > 1 ? 's' : ''}`)}
         
         <div style="background: var(--bg-card); padding: 12px; border-radius: 6px; margin: 15px 0;">
           <p style="color: var(--text-secondary); font-size: 0.85rem;"><strong>Current SA Cards:</strong> ${countsDisplay}</p>
         </div>`,
        [
          { text: 'Confirm Draw', action: () => confirmSACardDraw(cardsToDraw) }
        ]
      );
    }
    
    function calculateSACardsToDraw(count) {
      // Priority order (no Academy in base game)
      const priority = ['theater', 'downtown', 'market', 'workshop'];
      const cardsToDraw = [];
      
      // Create a working copy of current counts
      const workingCounts = { ...gameState.heir.specialAssignments };
      
      for (let i = 0; i < count; i++) {
        // Find the color(s) with the minimum count
        const minCount = Math.min(...priority.map(c => workingCounts[c]));
        
        // Among those with min count, pick by priority order
        for (const color of priority) {
          if (workingCounts[color] === minCount) {
            cardsToDraw.push(color);
            workingCounts[color]++; // Increment for next iteration
            break;
          }
        }
      }
      
      return cardsToDraw;
    }
    
    function confirmSACardDraw(cardsToDraw) {
      // Update the counts
      cardsToDraw.forEach(color => {
        gameState.heir.specialAssignments[color]++;
      });
      
      updateGameDisplay();
      
      // Continue to placement
      startPlaceCharactersSequence();
    }

    // ============================================
    // THEATER LOCATION
    // ============================================

    // Theater Trick Marker count based on AP and difficulty
    const THEATER_MARKER_COUNT = {
      easy:   { 1: 1, 2: 2, 3: 2 },
      normal: { 1: 1, 2: 2, 3: 3 },
      hard:   { 1: 2, 2: 3, 3: 4 }
    };

    function getTheaterMarkerCount(actionPoints) {
      const difficulty = gameState.difficulty;
      const ap = Math.min(actionPoints, 3); // Cap at 3 AP for theater
      return THEATER_MARKER_COUNT[difficulty][ap] || 1;
    }

    function showTheaterInput() {
      // If magician already placed at Theater this turn, skip directly to non-magician
      if (gameState.heir.magicianAtTheaterThisTurn) {
        showTheaterNonMagicianPreCheck();
        return;
      }
      
      // First ask: Magician or non-Magician?
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater`,
        `<p>The Heir is placing a Character at the Theater.</p>
         <p style="margin-top: 15px;"><strong>Which character is being placed?</strong></p>`,
        [
          { text: 'Magician', action: () => showTheaterMagician() },
          { text: 'Non-Magician (Specialist/Apprentice)', action: () => showTheaterNonMagicianPreCheck() },
          { text: '‚Üê Back', action: () => showContestedCheck(), style: 'secondary' }
        ]
      );
    }

    function showTheaterMagician() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      const stance = gameState.heir.stance;
      const dayPreference = stance === 'ready' ? 'earliest available day' : 'latest available day';
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Magician)`,
        `<p>The Heir's Magician goes to the Theater.</p>
         
         ${infoBox("The Magician is placed in the Performance spot and does nothing else.")}
         
         ${boardAction(`Place the Heir's Magician disk in the Performance spot on the <strong>${dayPreference}</strong>`)}
         
         <p style="margin-top: 15px; color: var(--text-muted); font-size: 0.9rem;"><em>Why: Heir is ${stance.charAt(0).toUpperCase() + stance.slice(1)}, so prefers the ${dayPreference} for performances.</em></p>`,
        [
          { text: 'Done ‚Äî Continue Placement', action: () => {
            gameState.heir.magicianAtTheaterThisTurn = true;
            startPlaceCharactersSequence();
          }}
        ]
      );
    }

    function showTheaterNonMagicianPreCheck() {
      // Pre-check: Does Heir have any Trick markers available?
      const exceptionBox = (text) => `<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è IMPORTANT:</span> ${text}</div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Non-Magician)`,
        `<p><strong>Pre-check: Available Trick Markers</strong></p>
         <p style="margin: 15px 0;">Before placing at the Theater, check if the Heir has any Trick markers available to place.</p>
         
         <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;"><em>Why: If no Trick markers can be placed, the Heir must send a different Character instead.</em></p>
         
         <p><strong>Does the Heir have at least one Trick marker available?</strong></p>
         <p style="color: var(--text-secondary); font-size: 0.9rem;">(Check Heir's Tricks ‚Äî do any have markers on them?)</p>`,
        [
          { text: 'Yes ‚Äî Has Trick markers', action: () => checkMechanikerApprentice('theater', showTheaterAPInput) },
          { text: 'No ‚Äî No markers available', action: () => showTheaterNoMarkers() }
        ]
      );
    }

    function showTheaterNoMarkers() {
      const exceptionBox = (text) => `<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è IMPORTANT:</span> ${text}</div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater`,
        `${exceptionBox("Cannot send to Theater ‚Äî no Trick markers available!")}
         
         <p style="margin: 15px 0;">The Heir must send a different Character to a different location instead.</p>
         
         <p style="color: var(--text-muted); font-size: 0.9rem;"><em>Why: Sending a non-Magician to the Theater that results in zero Tricks being placed is not allowed. Re-evaluate the Heir's next placement.</em></p>`,
        [
          { text: 'Continue (Re-evaluate placement)', action: () => showContestedCheck() }
        ]
      );
    }

    function showTheaterAPInput() {
      const exceptionBox = (text) => `<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è EXCEPTION:</span> ${text}</div>`;
      const heirProphecyReminder = getHeirProphecyReminderHtml('heir-theater-nonmagician');
      const opticoReminder = getOpticoAPReminderHtml();
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Non-Magician)`,
        `<p><strong>Step 1: Determine Trick Markers</strong></p>
         ${heirProphecyReminder}
         ${opticoReminder}
         ${exceptionBox("Ignore the +1/‚àí1 AP slot modifier for the Heir. Use only the Character's base AP.")}
         <p style="margin: 15px 0;"><strong>How many Action Points does this Character have?</strong></p>
         <div class="ap-selector" style="display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap;">
           ${[1,2,3].map(ap => `
             <button class="btn ap-btn" data-ap="${ap}" style="min-width: 50px;">${ap} AP</button>
           `).join('')}
         </div>`,
        []
      );

      setTimeout(() => {
        $$('.ap-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const ap = parseInt(btn.dataset.ap);
            const markerCount = getTheaterMarkerCount(ap);
            showTheaterPriority1(ap, markerCount);
          });
        });
      }, 0);
    }

    function showTheaterPriority1(actionPoints, markerCount) {
      // Start the marker-by-marker placement flow
      showTheaterMarkerPlacement(actionPoints, markerCount, 1);
    }

    function showTheaterMarkerPlacement(actionPoints, totalMarkers, currentMarker) {
      const isFinalTurn = gameState.currentTurn === 7;
      const markersRemaining = totalMarkers - currentMarker + 1;
      
      // Stance-based day preference reminder
      const stance = gameState.heir.stance;
      const dayPreference = stance === 'ready' ? 'earliest available day (left)' : 'latest available day (right)';
      const stanceReminder = `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 0 0 15px 0; border-radius: 0 4px 4px 0;">
          <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è PLACEMENT PREFERENCE:</span> Heir is <strong>${stance.charAt(0).toUpperCase() + stance.slice(1)}</strong> ‚Äî place on the <strong>${dayPreference}</strong> when choosing between cards.
        </div>`;
      
      // Removal warning/note
      // Cards are removed from Turn 3 onwards (Turn 1-2: no removal)
      let removalNote = '';
      if (isFinalTurn) {
        removalNote = `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 0 0 15px 0; border-radius: 0 4px 4px 0;">
          <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è FINAL TURN:</span> The Heir CAN place on any card (no restrictions ‚Äî this is the last chance to perform all cards).
        </div>`;
      } else if (gameState.currentTurn >= 3) {
        removalNote = `<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 0 0 15px 0; border-radius: 0 4px 4px 0;">
          <span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è AVOID RIGHTMOST CARD:</span> The rightmost Performance card will be removed at end of turn. The Heir should avoid placing there unless it's the only free space.
        </div>`;
      }
      // Turns 1-2: No removal warning needed (no cards removed yet)
      
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      
      // Check for Master of Chains - first trick can be oriented freely
      const isChains = gameState.heirMagician?.id === 'chains';
      const chainsNote = (isChains && currentMarker === 1)
        ? magicianAbilityBox(`<strong>Master of Chains:</strong> This first Trick can be <strong>oriented freely</strong> ‚Äî it does NOT need to create a Link. Place it on ANY legal space.`)
        : '';
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Marker ${currentMarker} of ${totalMarkers})`,
        `${stanceReminder}
         
         ${removalNote}
         
         <p><strong>Step 2: Identify the Trick</strong></p>
         
         ${chainsNote}
         
         ${boardAction("Find the leftmost Heir Trick that still has markers available")}
         
         <p style="margin: 15px 0; color: var(--text-muted); font-size: 0.9rem;"><em>Why: The Heir always collects markers from its Tricks left to right.</em></p>
         
         <p style="margin-top: 15px;"><strong>Ready to place this marker?</strong></p>`,
        [
          { text: 'Continue', action: () => showTheaterMarkerPriority1(actionPoints, totalMarkers, currentMarker) }
        ]
      );
    }

    function showTheaterMarkerPriority1(actionPoints, totalMarkers, currentMarker) {
      const isFinalTurn = gameState.currentTurn === 7;
      const markersRemaining = totalMarkers - currentMarker + 1;
      
      let removalNote = '';
      if (!isFinalTurn) {
        removalNote = `<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 0 0 15px 0; border-radius: 0 4px 4px 0;">
          <span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è REMEMBER:</span> Avoid the card due for removal, unless it's the only free space.
        </div>`;
      }
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Marker ${currentMarker} of ${totalMarkers})`,
        `<p><strong>Step 3: Select Performance Card ‚Äî Priority 1</strong></p>
         
         ${removalNote}
         
         <p style="margin: 15px 0;">Can this Trick be legally placed on a card that already has <strong>Heir Tricks</strong> on it?</p>
         
         <p style="color: var(--text-muted); font-size: 0.9rem;"><em>Why: The Heir prefers to add to cards where it already has Tricks, to create Links.</em></p>
         
         <p style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9rem;">(Check: Is there a card with Heir Tricks that has an empty spot for this Trick type?)</p>`,
        [
          { text: 'Yes ‚Äî Can place with Heir Tricks', action: () => showTheaterMarkerPlaceOnCard(actionPoints, totalMarkers, currentMarker, 'heir') },
          { text: 'No ‚Äî Cannot place there', action: () => showTheaterMarkerPriority2(actionPoints, totalMarkers, currentMarker) }
        ]
      );
    }

    function showTheaterMarkerPriority2(actionPoints, totalMarkers, currentMarker) {
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Marker ${currentMarker} of ${totalMarkers})`,
        `<p><strong>Step 3: Select Performance Card ‚Äî Priority 2</strong></p>
         
         <p style="margin: 15px 0;">Can this Trick be legally placed on a card that has <strong>your (player's) Tricks</strong> on it?</p>
         
         <p style="color: var(--text-muted); font-size: 0.9rem;"><em>Why: If no Heir Tricks available, the Heir tries to Link with your Tricks.</em></p>`,
        [
          { text: 'Yes ‚Äî Can place with my Tricks', action: () => showTheaterMarkerPlaceOnCard(actionPoints, totalMarkers, currentMarker, 'player') },
          { text: 'No ‚Äî Cannot place there', action: () => showTheaterMarkerPriority3(actionPoints, totalMarkers, currentMarker) }
        ]
      );
    }

    function showTheaterMarkerPriority3(actionPoints, totalMarkers, currentMarker) {
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Marker ${currentMarker} of ${totalMarkers})`,
        `<p><strong>Step 3: Select Performance Card ‚Äî Priority 3</strong></p>
         
         <p style="margin: 15px 0;">Use the <strong>leftmost available</strong> Performance card that can legally take this Trick.</p>
         
         <p style="color: var(--text-muted); font-size: 0.9rem;"><em>Why: No existing Tricks to Link with, so use the first valid card.</em></p>
         
         <p style="margin-top: 15px;">Can this Trick be placed on any available card?</p>`,
        [
          { text: 'Yes ‚Äî Can place on a card', action: () => showTheaterMarkerPlaceOnCard(actionPoints, totalMarkers, currentMarker, 'leftmost') },
          { text: 'No ‚Äî Cannot place this Trick', action: () => showTheaterMarkerSkip(actionPoints, totalMarkers, currentMarker) }
        ]
      );
    }

    function showTheaterMarkerSkip(actionPoints, totalMarkers, currentMarker) {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      const infoBox = `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
        <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> This Trick cannot be legally placed. Skip it and try the next Trick.
      </div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Marker ${currentMarker} of ${totalMarkers})`,
        `<p><strong>Trick Cannot Be Placed</strong></p>
         
         ${infoBox}
         
         ${boardAction("Move to the next Trick on the Heir board (left to right) that has markers")}
         
         <p style="margin-top: 15px;">Is there another Trick with markers available?</p>`,
        [
          { text: 'Yes ‚Äî Try next Trick', action: () => showTheaterMarkerPriority1(actionPoints, totalMarkers, currentMarker) },
          { text: 'No ‚Äî No more Tricks available', action: () => showTheaterPlacementComplete(actionPoints, totalMarkers, currentMarker - 1) }
        ]
      );
    }

    function showTheaterMarkerPlaceOnCard(actionPoints, totalMarkers, currentMarker, priorityType) {
      const markersRemaining = totalMarkers - currentMarker;
      
      let targetDescription = '';
      if (priorityType === 'heir') {
        targetDescription = 'the leftmost Performance card with Heir Tricks';
      } else if (priorityType === 'player') {
        targetDescription = 'the leftmost Performance card with your Tricks';
      } else {
        targetDescription = 'the leftmost available Performance card';
      }
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Marker ${currentMarker} of ${totalMarkers})`,
        `<p><strong>Step 4: Check for Links</strong></p>
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p><strong>Target:</strong> ${targetDescription}</p>
         </div>
         
         <p style="margin: 15px 0;">Can this Trick marker create a <strong>Link</strong> on this card?</p>
         
         <p style="color: var(--text-muted); font-size: 0.9rem;"><em>A Link is created when matching Trick categories are adjacent.</em></p>`,
        [
          { text: 'Yes ‚Äî Can create Link', action: () => showTheaterMarkerDoPlacement(actionPoints, totalMarkers, currentMarker, true, priorityType) },
          { text: 'No ‚Äî No Link possible', action: () => showTheaterMarkerDoPlacement(actionPoints, totalMarkers, currentMarker, false, priorityType) }
        ]
      );
    }

    function showTheaterMarkerDoPlacement(actionPoints, totalMarkers, currentMarker, hasLink, priorityType) {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      const exceptionBox = (text) => `<div style="background: var(--exception-bg); border-left: 3px solid var(--exception); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--exception); font-weight: 600;">‚ö†Ô∏è EXCEPTION:</span> ${text}</div>`;
      
      const markersRemaining = totalMarkers - currentMarker;
      
      // If no link, simple placement flow
      if (!hasLink) {
        let nextAction;
        let buttonText;
        if (markersRemaining > 0) {
          buttonText = `Continue to Marker ${currentMarker + 1}`;
          nextAction = () => showTheaterMarkerPlacement(actionPoints, totalMarkers, currentMarker + 1);
        } else {
          buttonText = 'Done ‚Äî All Markers Placed';
          nextAction = () => showTheaterPlacementComplete(actionPoints, totalMarkers, totalMarkers);
        }
        
        setActionContent(
          `Turn ${gameState.currentTurn} ‚Äî Theater (Marker ${currentMarker} of ${totalMarkers})`,
          `<p><strong>Step 5: Place the Marker (No Link)</strong></p>
           
           <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
             <p><strong>No Link available:</strong> Place on the <strong>first empty spot</strong></p>
             <p style="color: var(--text-secondary); margin-top: 8px;">Order: left ‚Üí right, top ‚Üí bottom</p>
           </div>
           
           ${boardAction("Place the Trick marker on the first empty spot")}
           
           ${exceptionBox("Limit 1 of each Trick per card ‚Äî the Heir cannot place two copies of the same Trick on one Performance card.")}
           
           <p style="margin-top: 15px; color: var(--text-secondary);">${markersRemaining > 0 ? `${markersRemaining} marker(s) remaining to place.` : 'This is the last marker.'}</p>`,
          [
            { text: buttonText, action: nextAction }
          ]
        );
        return;
      }
      
      // Has link - need to collect level, links, and shards info
      const isPlayerLink = priorityType === 'player';
      const currentFame = gameState.heir.fame;
      const currentShards = gameState.heir.shards;
      
      // Check for special abilities and prophecies
      const isLumenia = gameState.heirMagician?.id === 'lumenia';
      const isExtraShard = gameState.activeProphecy?.id === 'p19';
      const isShardsGiveFame = gameState.activeProphecy?.id === 'p20';
      
      // Check for school prophecies (p07-p10)
      // Note: Using lighter text colors for readability on dark backgrounds
      // Escape uses a lighter gray since #5a5a5a is too dark for text
      const schoolProphecyMap = {
        'p07': { school: 'Mechanical', article: 'a', color: 'var(--mechanical)' },
        'p08': { school: 'Escape', article: 'an', color: '#9a9a9a' },
        'p09': { school: 'Spiritual', article: 'a', color: 'var(--spiritual)' },
        'p10': { school: 'Optical', article: 'an', color: 'var(--optical)' }
      };
      const activeSchoolProphecy = schoolProphecyMap[gameState.activeProphecy?.id];
      
      // Get prophecy reminder for theater phase
      const prophecyReminder = getProphecyReminderHtml('theater');
      
      // Note about multiple tricks on same card (show if more markers remaining)
      let multiTrickNote = '';
      if (markersRemaining > 0) {
        multiTrickNote = `
          <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
            <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> If placing multiple different Tricks on the same card this turn, order them to generate the <strong>highest Link bonus</strong>.
          </div>
        `;
      }
      
      // Lumenia ability note
      const lumeniaNote = isLumenia ? `
        <div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;">
          <span style="color: #a6c; font-weight: 600;">‚ú® LUMENIA:</span> +1 additional Fame per Link created (already included in calculation)
        </div>
      ` : '';
      
      // School prophecy question with Yes/No option cards
      const schoolProphecyQuestion = activeSchoolProphecy ? `
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
          <p style="margin-bottom: 10px;">Is this ${activeSchoolProphecy.article} <strong style="color: ${activeSchoolProphecy.color};">${activeSchoolProphecy.school}</strong> Trick? (+2 Fame)</p>
          <div class="option-grid" style="grid-template-columns: repeat(2, 1fr);">
            <div class="option-card theater-school-btn selected" data-value="no">
              <div class="title">No</div>
            </div>
            <div class="option-card theater-school-btn" data-value="yes">
              <div class="title">Yes</div>
            </div>
          </div>
        </div>
      ` : '';
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater (Marker ${currentMarker} of ${totalMarkers})`,
        `<p><strong>Step 5: Place the Marker & Collect Link Bonus</strong></p>
         
         <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;">
           <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> <strong>Link Placement Rules:</strong>
           <ol style="color: var(--text-secondary); line-height: 1.8; margin: 8px 0 0 20px;">
             <li><strong>Maximize Links</strong> ‚Äî place to create the most Links possible</li>
             <li><strong>Prefer Shards</strong> ‚Äî if tied on Links, choose the position that gives a Shard</li>
             <li><strong>Tiebreaker</strong> ‚Äî if still tied, use the <strong>topmost/leftmost</strong> position</li>
           </ol>
         </div>
         
         ${boardAction("Place the Trick marker to create the Link")}
         
         ${multiTrickNote}
         
         ${exceptionBox("Limit 1 of each Trick per card ‚Äî the Heir cannot place two copies of the same Trick on one Performance card.")}
         
         <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;">
           <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> Grey neutral markers count for Links, but you cannot place on top of them.
         </div>
         
         ${lumeniaNote}
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="margin-bottom: 15px;"><strong>Link Bonus Calculation:</strong></p>
           
           <div style="margin-bottom: 20px;">
             <p style="margin-bottom: 10px;">What level is this Trick?</p>
             <div class="option-grid" style="grid-template-columns: repeat(3, 1fr);">
               <div class="option-card theater-level-btn selected" data-level="1">
                 <div class="title">Level 1</div>
                 <div class="description">+1 Fame/Link</div>
               </div>
               <div class="option-card theater-level-btn" data-level="2">
                 <div class="title">Level 2</div>
                 <div class="description">+2 Fame/Link</div>
               </div>
               <div class="option-card theater-level-btn" data-level="3">
                 <div class="title">Level 3</div>
                 <div class="description">+3 Fame/Link</div>
               </div>
             </div>
           </div>
           
           <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
             <div>
               <p style="margin-bottom: 10px;">‚≠ê Links created</p>
               <div class="option-grid" style="grid-template-columns: repeat(4, 1fr);">
                 <div class="option-card theater-links-btn" data-links="0">
                   <div class="title">0</div>
                 </div>
                 <div class="option-card theater-links-btn selected" data-links="1">
                   <div class="title">1</div>
                 </div>
                 <div class="option-card theater-links-btn" data-links="2">
                   <div class="title">2</div>
                 </div>
                 <div class="option-card theater-links-btn" data-links="3">
                   <div class="title">3</div>
                 </div>
               </div>
             </div>
             <div>
               <p style="margin-bottom: 10px;">üíé Shard-space links</p>
               <div class="option-grid" style="grid-template-columns: repeat(4, 1fr);">
                 <div class="option-card theater-shards-btn selected" data-shards="0">
                   <div class="title">0</div>
                 </div>
                 <div class="option-card theater-shards-btn" data-shards="1">
                   <div class="title">1</div>
                 </div>
                 <div class="option-card theater-shards-btn" data-shards="2">
                   <div class="title">2</div>
                 </div>
                 <div class="option-card theater-shards-btn" data-shards="3">
                   <div class="title">3</div>
                 </div>
               </div>
             </div>
           </div>
           
           ${prophecyReminder}
           
           ${schoolProphecyQuestion}
         </div>
         
         <div id="theater-link-board-action">
           ${boardAction(`Update Heir's Fame (${currentFame} ‚Üí ${currentFame + 1}) and Shards (${currentShards} ‚Üí ${currentShards})`)}
         </div>
         
         ${isPlayerLink ? `<div id="theater-player-shard-action" class="hidden">
           ${boardAction(`<strong>You</strong> also receive Shard(s) from linking with the Heir!`)}
         </div>` : ''}
         
         <p style="margin-top: 15px; color: var(--text-secondary);">${markersRemaining > 0 ? `${markersRemaining} marker(s) remaining to place.` : 'This is the last marker.'}</p>`,
        [
          { text: markersRemaining > 0 ? `Continue to Marker ${currentMarker + 1}` : 'Done ‚Äî All Markers Placed', action: () => {
            // Get selected values from option cards
            const levelCard = document.querySelector('.theater-level-btn.selected');
            const linksCard = document.querySelector('.theater-links-btn.selected');
            const shardsCard = document.querySelector('.theater-shards-btn.selected');
            const schoolCard = document.querySelector('.theater-school-btn[data-value="yes"].selected');
            
            const level = levelCard ? parseInt(levelCard.dataset.level) : 1;
            const links = linksCard ? parseInt(linksCard.dataset.links) : 1;
            const shardLinks = shardsCard ? parseInt(shardsCard.dataset.shards) : 0;
            const schoolMatch = !!schoolCard;
            
            let fameGain = level * links;
            let shardGain = shardLinks;
            
            // Lumenia: +1 Fame per link
            if (isLumenia) {
              fameGain += links;
            }
            
            // School prophecy: +2 Fame if trick matches
            if (activeSchoolProphecy && schoolMatch) {
              fameGain += 2;
            }
            
            // p19: +1 extra shard if any shards received
            if (isExtraShard && shardGain > 0) {
              shardGain += 1;
            }
            
            // p20: +2 Fame if any shards received
            if (isShardsGiveFame && shardGain > 0) {
              fameGain += 2;
            }
            
            gameState.heir.fame += fameGain;
            gameState.heir.shards += shardGain;
            updateGameDisplay();
            
            if (markersRemaining > 0) {
              showTheaterMarkerPlacement(actionPoints, totalMarkers, currentMarker + 1);
            } else {
              showTheaterPlacementComplete(actionPoints, totalMarkers, totalMarkers);
            }
          }, id: 'theater-link-continue-btn' }
        ]
      );
      
      // Set up option card click handlers and dynamic update
      setTimeout(() => {
        const updateBoardAction = () => {
          const levelCard = document.querySelector('.theater-level-btn.selected');
          const linksCard = document.querySelector('.theater-links-btn.selected');
          const shardsCard = document.querySelector('.theater-shards-btn.selected');
          const schoolCard = document.querySelector('.theater-school-btn[data-value="yes"].selected');
          
          const level = levelCard ? parseInt(levelCard.dataset.level) : 1;
          const links = linksCard ? parseInt(linksCard.dataset.links) : 1;
          const shardLinks = shardsCard ? parseInt(shardsCard.dataset.shards) : 0;
          const schoolMatch = !!schoolCard;
          
          let fameGain = level * links;
          let shardGain = shardLinks;
          
          // Lumenia: +1 Fame per link
          if (isLumenia) {
            fameGain += links;
          }
          
          // School prophecy: +2 Fame if trick matches
          if (activeSchoolProphecy && schoolMatch) {
            fameGain += 2;
          }
          
          // p19: +1 extra shard if any shards received
          if (isExtraShard && shardGain > 0) {
            shardGain += 1;
          }
          
          // p20: +2 Fame if any shards received
          if (isShardsGiveFame && shardGain > 0) {
            fameGain += 2;
          }
          
          const boardActionEl = $('#theater-link-board-action');
          if (boardActionEl) {
            boardActionEl.innerHTML = `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">Update Heir's Fame (${currentFame} ‚Üí ${currentFame + fameGain}) and Shards (${currentShards} ‚Üí ${currentShards + shardGain})</span></div>`;
          }
          
          // Show/hide player shard action
          if (isPlayerLink) {
            const playerActionEl = $('#theater-player-shard-action');
            if (playerActionEl) {
              if (shardLinks > 0) {
                // Calculate player shards (same p19 bonus applies to player)
                let playerShardGain = shardLinks;
                if (isExtraShard) {
                  playerShardGain += 1;
                }
                // Check for p20 Fame bonus
                const p20Bonus = isShardsGiveFame ? ' and <strong>+2 Fame</strong>' : '';
                playerActionEl.classList.remove('hidden');
                playerActionEl.innerHTML = `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);"><strong>You</strong> also receive <strong>${playerShardGain}</strong> Shard(s)${p20Bonus} from linking with the Heir!</span></div>`;
              } else {
                playerActionEl.classList.add('hidden');
              }
            }
          }
        };
        
        // Level cards
        $$('.theater-level-btn').forEach(card => {
          card.addEventListener('click', () => {
            $$('.theater-level-btn').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            updateBoardAction();
          });
        });
        
        // Links cards
        $$('.theater-links-btn').forEach(card => {
          card.addEventListener('click', () => {
            $$('.theater-links-btn').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            updateBoardAction();
          });
        });
        
        // Shards cards
        $$('.theater-shards-btn').forEach(card => {
          card.addEventListener('click', () => {
            $$('.theater-shards-btn').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            updateBoardAction();
          });
        });
        
        // School prophecy cards
        $$('.theater-school-btn').forEach(card => {
          card.addEventListener('click', () => {
            $$('.theater-school-btn').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            updateBoardAction();
          });
        });
      }, 0);
    }

    function showTheaterPlacementComplete(actionPoints, totalMarkers, markersPlaced) {
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
        <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}
      </div>`;
      
      // Check for Master of Chains' ability (informational - already used during placement)
      const isChains = gameState.heirMagician?.id === 'chains';
      const chainsNote = isChains
        ? infoBox(`<strong>Master of Chains:</strong> The first Trick placed this turn could be oriented freely (didn't need to create a Link).`)
        : '';
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Theater Complete`,
        `<p><strong>Theater Placement Complete</strong></p>
         
         ${infoBox(`<strong>${markersPlaced}</strong> of <strong>${totalMarkers}</strong> marker(s) placed.`)}
         
         ${chainsNote}
         
         <p style="color: var(--text-secondary);">Fame and Shards from Links have already been added to the Heir's totals during placement.</p>`,
        [
          { text: 'Done ‚Äî Continue Placement', action: () => {
            // Track non-magician placed at Theater (for backstage bonus calculation)
            gameState.heir.nonMagiciansAtTheaterThisTurn++;
            
            updateGameDisplay();
            checkAndNotifyStanceChange(() => startPlaceCharactersSequence());
          }}
        ]
      );
    }

    // ============================================
    // WORKSHOP LOCATION
    // ============================================

    function showWorkshopActions() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Workshop`,
        `<p>The Heir is placing a Character at the Workshop.</p>
         
         ${infoBox("Nothing happens. The Heir's Tricks are always Prepared automatically, so there's no Workshop action to take.")}`,
        [
          { text: 'Done ‚Äî Continue Placement', action: () => startPlaceCharactersSequence() }
        ]
      );
    }

    // ============================================
    // PERFORMANCE PHASE
    // ============================================

    function handlePerformancePhase() {
      // Shared Links now handled via button on Player Turn screen
      showPerformanceStart();
    }
    
    function showPerformanceStart() {
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      
      const prophecyReminder = getProphecyReminderHtml('performance');
      
      // Check for Yoruba's ability - Heir always performs first
      const isYoruba = gameState.heirMagician?.id === 'yoruba';
      
      if (isYoruba) {
        // Yoruba: Heir automatically goes first IF performing
        setActionContent(
          `Turn ${gameState.currentTurn} ‚Äî Performance Order`,
          `${prophecyReminder}
           <p><strong>Who performs first?</strong></p>
           
           ${magicianAbilityBox(`<strong>Yoruba Spiritmaster:</strong> The Heir always performs <strong>first</strong>, regardless of Theater workday assignment.`)}
           
           <div style="background: var(--bg-card); padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
             <div style="font-size: 1.5rem; margin-bottom: 10px;">üë§ ‚Üí üé≠</div>
             <div style="font-size: 1.1rem; font-weight: 600; color: var(--amber);">Heir Performs First (if performing)</div>
             <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px;">Then you perform (if applicable)</div>
           </div>
           
           <p style="margin-top: 15px;"><strong>Is the Heir performing this turn?</strong></p>
           <p style="color: var(--text-secondary); font-size: 0.9rem;">The Heir performs if BOTH conditions are met:</p>
           <ul style="color: var(--text-secondary); font-size: 0.9rem; margin: 5px 0 0 20px;">
             <li>Its Magician is in a Performance slot (Theater)</li>
             <li>It has Trick markers on at least one Performance card</li>
           </ul>`,
          [
            { text: 'Yes ‚Äî Heir is performing', action: () => {
              gameState.performanceOrder = 'heir-first';
              showPerformanceCardSelection();
            }},
            { text: 'No ‚Äî Heir is not performing', action: () => {
              gameState.performanceOrder = 'heir-first';
              askIfPlayerPerforming();
            }},
            { text: '‚è≠Ô∏è No One Performs', action: () => handleEndTurnPhase() }
          ]
        );
      } else {
        // Normal: Ask who performs first based on Theater placement
        setActionContent(
          `Turn ${gameState.currentTurn} ‚Äî Performance Order`,
          `${prophecyReminder}
           <p><strong>Who performs first?</strong></p>
           <p style="color: var(--text-secondary); margin-bottom: 20px;">Check the Theater workday order (Thursday ‚Üí Sunday). Who has their Magician in the earliest slot?</p>
           
           ${infoBox("Performance order is determined by Theater workday placement, NOT initiative order.")}
           
           <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 15px;"><em>If neither you nor the Heir has a Magician in a Performance slot, select "No one performs".</em></p>`,
          [
            { text: 'üé≠ Player First', action: () => {
              gameState.performanceOrder = 'player-first';
              showHeirPerformingCheck();
            }},
            { text: 'üë§ Heir First', action: () => {
              gameState.performanceOrder = 'heir-first';
              showHeirPerformingCheck();
            }},
            { text: '‚è≠Ô∏è No One Performs', action: () => handleEndTurnPhase() }
          ]
        );
      }
    }
    
    function showHeirPerformingCheck() {
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      
      // Default to heir-first if not set (safer - will ask about player)
      const isHeirFirst = !gameState.performanceOrder || gameState.performanceOrder === 'heir-first';
      
      if (isHeirFirst) {
        // Heir First - keep original layout
        setActionContent(
          `Turn ${gameState.currentTurn} ‚Äî Performance`,
          `<p style="background: var(--bg-card); padding: 10px 15px; border-radius: 6px; margin-bottom: 15px;"><strong>Order:</strong> Heir performs first, then you.</p>
           
           ${infoBox("The Heir ignores Thursday/Sunday yield modifiers ‚Äî it always receives base Yields.")}
           
           <p style="margin-top: 20px;"><strong>Is the Heir performing this turn?</strong></p>
           <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">The Heir performs if BOTH conditions are met:</p>
           <ul style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 20px;">
             <li>Its Magician is in a Performance slot (Theater)</li>
             <li>It has Trick markers on at least one Performance card</li>
           </ul>`,
          [
            { text: 'Yes ‚Äî Heir is performing', action: () => showPerformanceCardSelection() },
            { text: 'No ‚Äî Heir is not performing', action: () => askIfPlayerPerforming() }
          ]
        );
      } else {
        // Player First - go directly to player performance screen
        showPlayerPerformanceScreen();
      }
    }

    function getPerformanceCardCount() {
      // Solo/2-player: Start with 1 card, add 1 each turn until Turn 3, then steady at 3
      // Turn 1: 2 cards (1 at setup + 1 added end of turn 1... but during Turn 1 it's still 1+1=2 after first end turn)
      // Actually: Setup has 1 card. End of Turn 1 adds 1 (total 2). End of Turn 2 adds 1 (total 3).
      // From Turn 3: remove 1, add 1 (stays at 3)
      // So DURING the turn: Turn 1 = 1, Turn 2 = 2, Turn 3+ = 3
      const turn = gameState.currentTurn;
      if (turn === 1) return 1;
      if (turn === 2) return 2;
      return 3; // Turn 3 onwards: steady state of 3 cards
    }
    
    function showPerformanceCardSelection() {
      const cardCount = getPerformanceCardCount();
      
      // Build visual representation of 5 slots
      const cardSlotsHtml = `
        <div style="display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap;">
          ${[1,2,3,4,5].map(i => {
            const hasCard = i <= cardCount;
            
            if (hasCard) {
              return `<div class="perf-card-slot selectable" data-slot="${i}" style="
                width: 50px;
                height: 70px;
                background: var(--bg-card);
                border: 2px solid var(--border);
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.15s ease;
              ">${i}</div>`;
            } else {
              return `<div style="
                width: 50px;
                height: 70px;
                background: transparent;
                border: 2px dashed var(--border);
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-muted);
                font-size: 0.8rem;
                opacity: 0.4;
              ">‚Äî</div>`;
            }
          }).join('')}
        </div>
        <p style="text-align: center; color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px;">
          ‚Üê Slot 1 (newest) ‚Äî Slot 5 (oldest) ‚Üí
        </p>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Heir)`,
        `<p><strong>Which cards have the Heir's Trick markers?</strong></p>
         <p style="color: var(--text-secondary); margin-bottom: 15px;">Click the card slots that have at least one of the Heir's markers.</p>
         
         ${cardSlotsHtml}
         
         <p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-top: 15px;">
           <strong id="selected-count">0</strong> card(s) selected
         </p>`,
        [
          { text: 'Continue with selected cards', action: () => processSelectedCards(), id: 'continue-btn', disabled: true },
          { text: 'Heir has no Tricks ‚Äî Skip Heir Performance', action: () => {
            // Explicitly skip - don't process any cards
            const isHeirFirst = !gameState.performanceOrder || gameState.performanceOrder === 'heir-first';
            if (isHeirFirst) {
              askIfPlayerPerforming();
            } else {
              // Player first - player already performed, go to End Turn
              advancePhase();
            }
          }}
        ]
      );
      
      setTimeout(() => {
        $$('.perf-card-slot.selectable').forEach(slot => {
          slot.addEventListener('click', () => {
            // Toggle selection
            const isSelected = slot.dataset.selected === 'true';
            
            if (isSelected) {
              slot.dataset.selected = 'false';
              slot.classList.remove('slot-selected');
            } else {
              slot.dataset.selected = 'true';
              slot.classList.add('slot-selected');
            }
            
            // Update count and button state
            const selectedCount = $$('.perf-card-slot[data-selected="true"]').length;
            $('#selected-count').textContent = selectedCount;
            
            // Enable/disable continue button based on selection
            const continueBtn = $('#continue-btn');
            if (continueBtn) {
              continueBtn.disabled = selectedCount === 0;
            }
          });
        });
      }, 0);
    }
    
    function processSelectedCards() {
      const selectedSlots = Array.from($$('.perf-card-slot[data-selected="true"]'))
        .map(slot => parseInt(slot.dataset.slot))
        .sort((a, b) => a - b);
      
      if (selectedSlots.length === 0) {
        // No cards selected - skip heir's performance
        // Default to heir-first if not set (safer - will ask about player)
        const isHeirFirst = !gameState.performanceOrder || gameState.performanceOrder === 'heir-first';
        if (isHeirFirst) {
          askIfPlayerPerforming();
        } else {
          // Player first - shared tricks already handled, go to End Turn
          advancePhase();
        }
        return;
      }
      
      // If only 1 card, use simplified flow - no need to calculate winner
      if (selectedSlots.length === 1) {
        showSingleCardPerformance(selectedSlots[0]);
        return;
      }
      
      // Store selected slots and start gathering bonuses
      gameState.selectedPerformanceSlots = selectedSlots;
      gatherCardBonuses(selectedSlots, 0, []);
    }
    
    function showSingleCardPerformance(cardSlot) {
      const cardCount = getPerformanceCardCount();
      
      // Build visual representation showing the single card highlighted
      const cardSlotsHtml = `
        <div style="display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap;">
          ${[1,2,3,4,5].map(i => {
            const hasCard = i <= cardCount;
            const isSelectedCard = i === cardSlot;
            
            if (!hasCard) {
              return `<div style="
                width: 50px;
                height: 70px;
                background: transparent;
                border: 2px dashed var(--border);
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-muted);
                font-size: 0.8rem;
                opacity: 0.4;
              ">‚Äî</div>`;
            }
            
            if (isSelectedCard) {
              return `<div style="
                width: 50px;
                height: 70px;
                background: rgba(212, 168, 71, 0.2);
                border: 2px solid var(--amber);
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--amber);
                font-weight: 600;
                font-size: 1.2rem;
                box-shadow: 0 0 15px rgba(212, 168, 71, 0.4);
              ">‚òÖ</div>`;
            }
            
            return `<div style="
              width: 50px;
              height: 70px;
              background: var(--bg-main);
              border: 2px solid var(--border);
              border-radius: 4px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: var(--text-muted);
              font-weight: 600;
              font-size: 0.9rem;
            ">${i}</div>`;
          }).join('')}
        </div>
        <p style="text-align: center; color: var(--amber); font-size: 0.95rem; margin-bottom: 15px;">
          <strong>The Heir performs card ${cardSlot}</strong> (only card with markers)
        </p>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Heir)`,
        `${cardSlotsHtml}
         
         <div style="background: var(--bg-card); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
           <p style="margin-bottom: 15px;"><strong>How many Links are on card ${cardSlot}?</strong></p>
           <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">Count where two matching category symbols meet in a Link circle.</p>
           <div style="display: flex; gap: 8px; flex-wrap: wrap;">
             ${[0,1,2,3,4,5,6].map(n => `<button class="btn link-count-btn-single" data-links="${n}" style="min-width: 40px;">${n}</button>`).join('')}
           </div>
           <p id="selected-links-single" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;">Links: <strong>none selected</strong></p>
         </div>`,
        [
          { text: 'Continue', action: () => processSingleCardPerformance(cardSlot), id: 'continue-btn', disabled: true }
        ]
      );
      
      // Add click handlers
      setTimeout(() => {
        $$('.link-count-btn-single').forEach(btn => {
          btn.addEventListener('click', () => {
            $$('.link-count-btn-single').forEach(b => {
              b.classList.remove('btn-selected');
              b.dataset.selected = 'false';
            });
            btn.classList.add('btn-selected');
            btn.dataset.selected = 'true';
            $('#selected-links-single').innerHTML = `Links: <strong>${btn.dataset.links}</strong>`;
            
            // Enable continue button
            const continueBtn = $('#continue-btn');
            if (continueBtn) continueBtn.disabled = false;
          });
        });
      }, 0);
    }
    
    function processSingleCardPerformance(cardSlot) {
      // Get selected links
      let links = 0;
      $$('.link-count-btn-single').forEach(btn => {
        if (btn.dataset.selected === 'true') {
          links = parseInt(btn.dataset.links);
        }
      });
      
      // Create a minimal results array for the performance wizard
      const results = [{
        card: cardSlot,
        links: links,
        cardFame: 0,
        cardShards: 0,
        cardCoins: 0,
        totalFame: links,
        totalShards: 0,
        totalCoins: 0
      }];
      
      showHeirPerformanceStep1_TrickYields(cardSlot, results);
    }

    function gatherCardBonuses(selectedSlots, currentIndex, results) {
      if (currentIndex >= selectedSlots.length) {
        // All cards gathered - calculate winner
        calculatePerformanceWinner(results);
        return;
      }
      
      const currentSlot = selectedSlots[currentIndex];
      const cardCount = getPerformanceCardCount();
      
      // Build visual representation of card slots showing current one highlighted
      const cardSlotsHtml = `
        <div style="display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap;">
          ${[1,2,3,4,5].map(i => {
            const hasCard = i <= cardCount;
            const isCurrentCard = i === currentSlot;
            const isSelected = selectedSlots.includes(i);
            const isDone = selectedSlots.indexOf(i) < currentIndex && selectedSlots.indexOf(i) !== -1;
            
            if (!hasCard) {
              // Empty slot - dotted
              return `<div style="
                width: 50px;
                height: 70px;
                background: transparent;
                border: 2px dashed var(--border);
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-muted);
                font-size: 0.8rem;
                opacity: 0.4;
              ">‚Äî</div>`;
            }
            
            let bgColor = 'var(--bg-main)';
            let borderColor = 'var(--border)';
            let textColor = 'var(--text-muted)';
            let boxShadow = 'none';
            let borderStyle = 'solid';
            let content = i;
            
            if (isCurrentCard) {
              // Currently entering this card
              bgColor = 'rgba(212, 168, 71, 0.2)';
              borderColor = 'var(--amber)';
              textColor = 'var(--amber)';
              boxShadow = '0 0 15px rgba(212, 168, 71, 0.4)';
            } else if (isDone) {
              // Already entered
              bgColor = 'rgba(74, 158, 107, 0.15)';
              borderColor = 'var(--success, #4a9e6b)';
              textColor = 'var(--success, #4a9e6b)';
              content = '‚úì';
            } else if (isSelected) {
              // Selected but not yet entered
              bgColor = 'var(--bg-card)';
              borderColor = 'var(--amber)';
              textColor = 'var(--text-secondary)';
            } else {
              // Not selected (no Heir markers)
              bgColor = 'var(--bg-main)';
              textColor = 'var(--text-muted)';
              content = i;
            }
            
            return `<div style="
              width: 50px;
              height: 70px;
              background: ${bgColor};
              border: 2px ${borderStyle} ${borderColor};
              border-radius: 4px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: ${textColor};
              font-weight: 600;
              font-size: 0.9rem;
              box-shadow: ${boxShadow};
            ">${content}</div>`;
          }).join('')}
        </div>
        <p style="text-align: center; color: var(--amber); font-size: 0.9rem; margin-bottom: 15px;">
          Entering details for <strong>Card ${currentSlot}</strong> (${currentIndex + 1} of ${selectedSlots.length})
        </p>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Card ${currentSlot})`,
        `${cardSlotsHtml}
         
         <div style="background: var(--bg-card); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
           <p style="margin-bottom: 15px;"><strong>How many Links are on this card?</strong></p>
           <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">Count where two matching category symbols meet in a Link circle.</p>
           <div style="display: flex; gap: 8px; flex-wrap: wrap;">
             ${[0,1,2,3,4,5,6].map(n => `<button class="btn link-count-btn" data-links="${n}" style="min-width: 40px;">${n}</button>`).join('')}
           </div>
           <p id="selected-links-display" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;">Links: <strong>none selected</strong></p>
         </div>
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px;">
           <p style="margin-bottom: 15px;"><strong>What's the Performance card bonus?</strong></p>
           <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 6px;">Look at the bottom of the card and select the matching bonus:</p>
           
           <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
             <button class="btn bonus-btn" data-fame="1" data-shards="0" data-coins="0">1‚òÖ</button>
             <button class="btn bonus-btn" data-fame="2" data-shards="0" data-coins="0">2‚òÖ</button>
             <button class="btn bonus-btn" data-fame="3" data-shards="0" data-coins="0">3‚òÖ</button>
             <button class="btn bonus-btn" data-fame="4" data-shards="0" data-coins="0">4‚òÖ</button>
             <button class="btn bonus-btn" data-fame="0" data-shards="0" data-coins="1">1ü™ô</button>
             <button class="btn bonus-btn" data-fame="0" data-shards="0" data-coins="2">2ü™ô</button>
             <button class="btn bonus-btn" data-fame="0" data-shards="0" data-coins="3">3ü™ô</button>
             <button class="btn bonus-btn" data-fame="0" data-shards="1" data-coins="0">1üíé</button>
             <button class="btn bonus-btn" data-fame="2" data-shards="0" data-coins="2">2‚òÖ 2ü™ô</button>
             <button class="btn bonus-btn" data-fame="2" data-shards="1" data-coins="0">2‚òÖ 1üíé</button>
             <button class="btn bonus-btn" data-fame="1" data-shards="1" data-coins="0">1‚òÖ 1üíé</button>
             <button class="btn bonus-btn" data-fame="0" data-shards="1" data-coins="1">1ü™ô 1üíé</button>
           </div>
           <p id="selected-bonus-display" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;">Bonus: <strong>none selected</strong></p>
         </div>`,
        [
          { text: currentIndex < selectedSlots.length - 1 ? `Next Card ‚Üí` : 'Calculate Winner', action: () => saveCardBonusAndContinue(selectedSlots, currentIndex, results), id: 'continue-btn', disabled: true }
        ]
      );
      
      // Helper to check if both selections are made
      const updateContinueButton = () => {
        const linksSelected = $$('.link-count-btn[data-selected="true"]').length > 0;
        const bonusSelected = $$('.bonus-btn[data-selected="true"]').length > 0;
        const continueBtn = $('#continue-btn');
        if (continueBtn) {
          continueBtn.disabled = !(linksSelected && bonusSelected);
        }
      };
      
      // Add click handlers
      setTimeout(() => {
        // Link buttons
        $$('.link-count-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            $$('.link-count-btn').forEach(b => {
              b.classList.remove('btn-selected');
              b.dataset.selected = 'false';
            });
            btn.classList.add('btn-selected');
            btn.dataset.selected = 'true';
            $('#selected-links-display').innerHTML = `Links: <strong>${btn.dataset.links}</strong>`;
            updateContinueButton();
          });
        });
        
        // Bonus buttons
        $$('.bonus-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            $$('.bonus-btn').forEach(b => {
              b.classList.remove('btn-selected');
              b.dataset.selected = 'false';
            });
            btn.classList.add('btn-selected');
            btn.dataset.selected = 'true';
            $('#selected-bonus-display').innerHTML = `Bonus: <strong>${btn.textContent}</strong>`;
            updateContinueButton();
          });
        });
      }, 0);
    }

    function saveCardBonusAndContinue(selectedSlots, currentIndex, results) {
      const currentSlot = selectedSlots[currentIndex];
      
      // Get selected links
      let links = 0;
      $$('.link-count-btn').forEach(btn => {
        if (btn.dataset.selected === 'true') {
          links = parseInt(btn.dataset.links);
        }
      });
      
      // Get selected bonus
      let fame = 0, shards = 0, coins = 0;
      $$('.bonus-btn').forEach(btn => {
        if (btn.dataset.selected === 'true') {
          fame = parseInt(btn.dataset.fame) || 0;
          shards = parseInt(btn.dataset.shards) || 0;
          coins = parseInt(btn.dataset.coins) || 0;
        }
      });
      
      // Links give 1 Fame each for the performer
      const totalFame = links + fame;
      
      results.push({
        card: currentSlot,
        links: links,
        cardFame: fame,
        cardShards: shards,
        cardCoins: coins,
        totalFame: totalFame,
        totalShards: shards,
        totalCoins: coins
      });
      
      // Continue to next card
      gatherCardBonuses(selectedSlots, currentIndex + 1, results);
    }

    function calculatePerformanceWinner(results) {
      // Sort by: most Fame, then most Shards, then most Coins, then leftmost (lowest card number)
      results.sort((a, b) => {
        if (b.totalFame !== a.totalFame) return b.totalFame - a.totalFame;
        if (b.totalShards !== a.totalShards) return b.totalShards - a.totalShards;
        if (b.totalCoins !== a.totalCoins) return b.totalCoins - a.totalCoins;
        return a.card - b.card; // Lower card number = leftmost = wins ties
      });
      
      const winner = results[0];
      showHeirPerformanceStep1_TrickYields(winner.card, results);
    }

    // ============================================
    // HEIR PERFORMANCE WIZARD (3-Step Flow)
    // ============================================
    
    // Temp storage for wizard steps (allows Back navigation)
    let heirPerformanceTempData = {
      winningCard: null,
      winningLinks: 0,
      results: [],
      trickYields: { fame: 0, coins: 0, shards: 0 },
      trickCountsByLevel: { level1: 0, level2: 0, level3: 0 },
      cardBonus: { fame: 0, coins: 0, shards: 0 },
      redLotusTricks: 0,
      playerHasTricksOnCard: false
    };
    
    function showHeirPerformanceStep1_TrickYields(winningCard, results) {
      // Initialize temp data
      const winningCardData = results.find(r => r.card === winningCard);
      const winningLinks = winningCardData?.links || 0;
      
      heirPerformanceTempData = {
        winningCard: winningCard,
        winningLinks: winningLinks,
        results: results,
        trickYields: heirPerformanceTempData.trickYields || { fame: 0, coins: 0, shards: 0 },
        trickCountsByLevel: heirPerformanceTempData.trickCountsByLevel || { level1: 0, level2: 0, level3: 0 },
        cardBonus: heirPerformanceTempData.cardBonus || { fame: 0, coins: 0, shards: 0 },
        redLotusTricks: heirPerformanceTempData.redLotusTricks || 0,
        playerHasTricksOnCard: heirPerformanceTempData.playerHasTricksOnCard || false
      };
      
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      
      const isElektra = gameState.heirMagician?.id === 'elektra';
      
      // Build card visual
      const cardCount = getPerformanceCardCount();
      const selectedSlots = results.map(r => r.card);
      const cardSlotsHtml = buildCardSlotsVisual(cardCount, selectedSlots, winningCard);
      
      let inputHtml = '';
      
      if (isElektra) {
        // Elektra: ask for trick count per level
        inputHtml = `
          ${magicianAbilityBox(`<strong>Elektra:</strong> Add <strong>+1/+2/+3</strong> to ALL Yields for each Trick based on its Level.`)}
          
          <p style="margin: 15px 0;"><strong>How many Heir Tricks were performed at each level?</strong></p>
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">Count only the Heir's Tricks on card ${winningCard}.</p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="text-align: center;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600;">Level 1</label>
              <input type="number" id="elektra-level1" value="${heirPerformanceTempData.trickCountsByLevel.level1}" min="0" max="10" style="width: 60px; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
              <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px;">+1 each</p>
            </div>
            <div style="text-align: center;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600;">Level 2</label>
              <input type="number" id="elektra-level2" value="${heirPerformanceTempData.trickCountsByLevel.level2}" min="0" max="10" style="width: 60px; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
              <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px;">+2 each</p>
            </div>
            <div style="text-align: center;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600;">Level 3</label>
              <input type="number" id="elektra-level3" value="${heirPerformanceTempData.trickCountsByLevel.level3}" min="0" max="10" style="width: 60px; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
              <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px;">+3 each</p>
            </div>
          </div>
          
          <p style="margin: 15px 0;"><strong>Base Trick Yields</strong> (from Trick cards, before Elektra bonus):</p>
        `;
      } else {
        inputHtml = `
          <p style="margin: 15px 0;"><strong>Enter the base yields from the Heir's Trick cards:</strong></p>
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">Sum the Fame, Coins, and Shards printed on all Heir Tricks performed on card ${winningCard}.</p>
        `;
      }
      
      inputHtml += `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
          <div>
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
              <span style="font-size: 1.3rem;">‚òÖ</span> Fame
            </label>
            <input type="number" id="trick-yield-fame" value="${heirPerformanceTempData.trickYields.fame}" min="0" max="50" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
          </div>
          <div>
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
              <span style="font-size: 1.3rem;">ü™ô</span> Coins
            </label>
            <input type="number" id="trick-yield-coins" value="${heirPerformanceTempData.trickYields.coins}" min="0" max="50" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
          </div>
          <div>
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
              <span style="font-size: 1.3rem;">üíé</span> Shards
            </label>
            <input type="number" id="trick-yield-shards" value="${heirPerformanceTempData.trickYields.shards}" min="0" max="10" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
          </div>
        </div>
      `;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Step 1 of 3)`,
        `${cardSlotsHtml}
         
         ${noteBox("The Heir ignores Thursday/Sunday yield modifiers ‚Äî always use base Trick Yields.")}
         
         ${inputHtml}`,
        [
          { text: 'Continue ‚Üí', action: () => {
            // Save inputs
            heirPerformanceTempData.trickYields = {
              fame: parseInt($('#trick-yield-fame')?.value) || 0,
              coins: parseInt($('#trick-yield-coins')?.value) || 0,
              shards: parseInt($('#trick-yield-shards')?.value) || 0
            };
            
            if (isElektra) {
              heirPerformanceTempData.trickCountsByLevel = {
                level1: parseInt($('#elektra-level1')?.value) || 0,
                level2: parseInt($('#elektra-level2')?.value) || 0,
                level3: parseInt($('#elektra-level3')?.value) || 0
              };
            }
            
            showHeirPerformanceStep2_CardBonus();
          }}
        ]
      );
    }
    
    function showHeirPerformanceStep2_CardBonus() {
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const magicianAbilityBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú® MAGICIAN ABILITY:</span> ${text}</div>`;
      
      const winningCard = heirPerformanceTempData.winningCard;
      const isRedLotus = gameState.heirMagician?.id === 'redlotus';
      
      // Build card visual
      const cardCount = getPerformanceCardCount();
      const selectedSlots = heirPerformanceTempData.results.map(r => r.card);
      const cardSlotsHtml = buildCardSlotsVisual(cardCount, selectedSlots, winningCard);
      
      let redLotusHtml = '';
      if (isRedLotus) {
        redLotusHtml = `
          ${magicianAbilityBox(`<strong>Red Lotus:</strong> The Heir gets <strong>+1 Fame</strong> for each of YOUR Tricks on its selected Performance card.`)}
          
          <div style="margin: 15px 0;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #a6c;">
              <span style="font-size: 1.3rem;">‚ú®</span> Your Tricks on card ${winningCard}
            </label>
            <input type="number" id="red-lotus-tricks" value="${heirPerformanceTempData.redLotusTricks}" min="0" max="10" style="width: 100px; padding: 10px; border-radius: 4px; border: 1px solid #a6c; background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
          </div>
        `;
      }
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Step 2 of 3)`,
        `${cardSlotsHtml}
         
         <p style="margin: 15px 0;"><strong>Enter the Performance Card Bonus:</strong></p>
         <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">This is the bonus printed at the bottom of Performance card ${winningCard}.</p>
         
         <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
           <div>
             <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
               <span style="font-size: 1.3rem;">‚òÖ</span> Fame
             </label>
             <input type="number" id="card-bonus-fame" value="${heirPerformanceTempData.cardBonus.fame}" min="0" max="20" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
           </div>
           <div>
             <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
               <span style="font-size: 1.3rem;">ü™ô</span> Coins
             </label>
             <input type="number" id="card-bonus-coins" value="${heirPerformanceTempData.cardBonus.coins}" min="0" max="20" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
           </div>
           <div>
             <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
               <span style="font-size: 1.3rem;">üíé</span> Shards
             </label>
             <input type="number" id="card-bonus-shards" value="${heirPerformanceTempData.cardBonus.shards}" min="0" max="5" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
           </div>
         </div>
         
         ${redLotusHtml}`,
        [
          { text: '‚Üê Back', action: () => {
            // Save current inputs before going back
            heirPerformanceTempData.cardBonus = {
              fame: parseInt($('#card-bonus-fame')?.value) || 0,
              coins: parseInt($('#card-bonus-coins')?.value) || 0,
              shards: parseInt($('#card-bonus-shards')?.value) || 0
            };
            if (isRedLotus) {
              heirPerformanceTempData.redLotusTricks = parseInt($('#red-lotus-tricks')?.value) || 0;
            }
            showHeirPerformanceStep1_TrickYields(heirPerformanceTempData.winningCard, heirPerformanceTempData.results);
          }},
          { text: 'Continue ‚Üí', action: () => {
            // Save inputs
            heirPerformanceTempData.cardBonus = {
              fame: parseInt($('#card-bonus-fame')?.value) || 0,
              coins: parseInt($('#card-bonus-coins')?.value) || 0,
              shards: parseInt($('#card-bonus-shards')?.value) || 0
            };
            if (isRedLotus) {
              heirPerformanceTempData.redLotusTricks = parseInt($('#red-lotus-tricks')?.value) || 0;
            }
            showHeirPerformanceStep3_FinalTotals();
          }}
        ]
      );
    }
    
    function showHeirPerformanceStep3_FinalTotals() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const magicianBox = (text) => `<div style="background: rgba(180, 100, 200, 0.15); border-left: 3px solid #a6c; padding: 4px 12px; margin: 4px 0; border-radius: 0 4px 4px 0;"><span style="color: #a6c; font-weight: 600;">‚ú®</span> ${text}</div>`;
      
      const data = heirPerformanceTempData;
      const winningCard = data.winningCard;
      const isElektra = gameState.heirMagician?.id === 'elektra';
      const isRedLotus = gameState.heirMagician?.id === 'redlotus';
      
      // Get prophecy effects
      const isDoublePerformerBonus = gameState.activeProphecy?.id === 'p14';
      const isCoinsAsFame = gameState.activeProphecy?.id === 'p16';
      const isExtraShard = gameState.activeProphecy?.id === 'p19';
      const isShardsGiveFame = gameState.activeProphecy?.id === 'p20';
      
      // Calculate backstage bonus
      const backstageCount = gameState.heir.nonMagiciansAtTheaterThisTurn || 0;
      let backstageFame = 0;
      let backstageCoins = 0;
      if (gameState.difficulty === 'hard') {
        backstageFame = backstageCount * 1;
      } else if (gameState.difficulty === 'normal') {
        backstageCoins = backstageCount * 2;
      }
      // Easy = nothing
      
      // Calculate Elektra bonus
      let elektraBonusFame = 0;
      let elektraBonusCoins = 0;
      let elektraBonusShards = 0;
      if (isElektra) {
        const l1 = data.trickCountsByLevel.level1 || 0;
        const l2 = data.trickCountsByLevel.level2 || 0;
        const l3 = data.trickCountsByLevel.level3 || 0;
        elektraBonusFame = (l1 * 1) + (l2 * 2) + (l3 * 3);
        elektraBonusCoins = elektraBonusFame;
        elektraBonusShards = elektraBonusFame;
      }
      
      // Red Lotus bonus
      const redLotusFame = isRedLotus ? (data.redLotusTricks || 0) : 0;
      
      // Base totals (before prophecy effects)
      let baseFame = data.trickYields.fame + data.cardBonus.fame + data.winningLinks + backstageFame + elektraBonusFame + redLotusFame;
      let baseCoins = data.trickYields.coins + data.cardBonus.coins + backstageCoins + elektraBonusCoins;
      let baseShards = data.trickYields.shards + data.cardBonus.shards + elektraBonusShards;
      
      // Apply p14 (Double Performer Bonus) - doubles Links + Backstage + Card Bonus (NOT trick yields)
      let p14BonusFame = 0;
      let p14BonusCoins = 0;
      let p14BonusShards = 0;
      if (isDoublePerformerBonus) {
        p14BonusFame = data.winningLinks + backstageFame + data.cardBonus.fame;
        p14BonusCoins = backstageCoins + data.cardBonus.coins;
        p14BonusShards = data.cardBonus.shards; // Card bonus shards are also performer bonus
      }
      
      // Calculate final totals
      let finalFame = baseFame + p14BonusFame;
      let finalCoins = baseCoins + p14BonusCoins;
      let finalShards = baseShards + p14BonusShards;
      
      // Apply p19 (Extra Shard)
      let p19ExtraShard = 0;
      if (isExtraShard && finalShards > 0) {
        p19ExtraShard = 1;
        finalShards += 1;
      }
      
      // Apply p20 (Shards Give Fame) - +2 Fame if any shards received
      let p20BonusFame = 0;
      if (isShardsGiveFame && (baseShards + p19ExtraShard) > 0) {
        p20BonusFame = 2;
        finalFame += 2;
      }
      
      // Apply p16 (Coins As Fame) - convert all coins to fame
      let p16ConvertedCoins = 0;
      if (isCoinsAsFame) {
        p16ConvertedCoins = finalCoins;
        finalFame += finalCoins;
        finalCoins = 0;
      }
      
      // Build the breakdown display
      let fameBreakdown = `
        <div style="background: var(--bg-card); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
          <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">‚òÖ Fame</h4>
          <table style="width: 100%; font-size: 0.9rem;">
            <tr><td>Trick Yields</td><td style="text-align: right; font-weight: 600;">+${data.trickYields.fame}</td></tr>
            <tr><td>Card Bonus</td><td style="text-align: right; font-weight: 600;">+${data.cardBonus.fame}</td></tr>
            <tr><td>Links (${data.winningLinks})</td><td style="text-align: right; font-weight: 600;">+${data.winningLinks}</td></tr>
      `;
      
      if (backstageFame > 0) {
        fameBreakdown += `<tr><td>Backstage (${backstageCount} chars)</td><td style="text-align: right; font-weight: 600;">+${backstageFame}</td></tr>`;
      }
      if (isElektra && elektraBonusFame > 0) {
        fameBreakdown += `<tr style="color: #a6c;"><td>‚ú® Elektra Bonus</td><td style="text-align: right; font-weight: 600;">+${elektraBonusFame}</td></tr>`;
      }
      if (redLotusFame > 0) {
        fameBreakdown += `<tr style="color: #a6c;"><td>‚ú® Red Lotus (${data.redLotusTricks} tricks)</td><td style="text-align: right; font-weight: 600;">+${redLotusFame}</td></tr>`;
      }
      if (p14BonusFame > 0) {
        fameBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p14 Doubled</td><td style="text-align: right; font-weight: 600;">+${p14BonusFame}</td></tr>`;
      }
      if (p20BonusFame > 0) {
        fameBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p20 Shards ‚Üí Fame</td><td style="text-align: right; font-weight: 600;">+${p20BonusFame}</td></tr>`;
      }
      if (p16ConvertedCoins > 0) {
        fameBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p16 Coins ‚Üí Fame</td><td style="text-align: right; font-weight: 600;">+${p16ConvertedCoins}</td></tr>`;
      }
      
      fameBreakdown += `
          </table>
        </div>
      `;
      
      // Coins breakdown
      let coinsBreakdown = `
        <div style="background: var(--bg-card); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
          <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">ü™ô Coins</h4>
          <table style="width: 100%; font-size: 0.9rem;">
            <tr><td>Trick Yields</td><td style="text-align: right; font-weight: 600;">+${data.trickYields.coins}</td></tr>
            <tr><td>Card Bonus</td><td style="text-align: right; font-weight: 600;">+${data.cardBonus.coins}</td></tr>
      `;
      
      if (backstageCoins > 0) {
        coinsBreakdown += `<tr><td>Backstage (${backstageCount} chars)</td><td style="text-align: right; font-weight: 600;">+${backstageCoins}</td></tr>`;
      }
      if (isElektra && elektraBonusCoins > 0) {
        coinsBreakdown += `<tr style="color: #a6c;"><td>‚ú® Elektra Bonus</td><td style="text-align: right; font-weight: 600;">+${elektraBonusCoins}</td></tr>`;
      }
      if (p14BonusCoins > 0) {
        coinsBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p14 Doubled</td><td style="text-align: right; font-weight: 600;">+${p14BonusCoins}</td></tr>`;
      }
      if (p16ConvertedCoins > 0) {
        coinsBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p16 ‚Üí Fame</td><td style="text-align: right; font-weight: 600; text-decoration: line-through;">-${p16ConvertedCoins}</td></tr>`;
      }
      
      coinsBreakdown += `
          </table>
        </div>
      `;
      
      // Shards breakdown
      let shardsBreakdown = `
        <div style="background: var(--bg-card); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
          <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">üíé Shards</h4>
          <table style="width: 100%; font-size: 0.9rem;">
            <tr><td>Trick Yields</td><td style="text-align: right; font-weight: 600;">+${data.trickYields.shards}</td></tr>
            <tr><td>Card Bonus</td><td style="text-align: right; font-weight: 600;">+${data.cardBonus.shards}</td></tr>
      `;
      
      if (isElektra && elektraBonusShards > 0) {
        shardsBreakdown += `<tr style="color: #a6c;"><td>‚ú® Elektra Bonus</td><td style="text-align: right; font-weight: 600;">+${elektraBonusShards}</td></tr>`;
      }
      if (p14BonusShards > 0) {
        shardsBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p14 Doubled</td><td style="text-align: right; font-weight: 600;">+${p14BonusShards}</td></tr>`;
      }
      if (p19ExtraShard > 0) {
        shardsBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p19 Extra Shard</td><td style="text-align: right; font-weight: 600;">+${p19ExtraShard}</td></tr>`;
      }
      
      shardsBreakdown += `
          </table>
        </div>
      `;
      
      // Build card visual
      const cardCount = getPerformanceCardCount();
      const selectedSlots = data.results.map(r => r.card);
      const cardSlotsHtml = buildCardSlotsVisual(cardCount, selectedSlots, winningCard);
      
      // Get current values for before/after display
      const currentFame = gameState.heir.fame;
      const currentCoins = gameState.heir.coins;
      const currentShards = gameState.heir.shards;
      
      // Build conditional board actions
      const fameAction = finalFame > 0 
        ? boardAction(`Update the Heir's Fame tracker with <strong>+${finalFame} Fame</strong>. (${currentFame} ‚Üí ${currentFame + finalFame})`)
        : '';
      const coinsAction = finalCoins > 0 
        ? boardAction(`Update the Heir's Coins with <strong>+${finalCoins} Coins</strong>. (${currentCoins} ‚Üí ${currentCoins + finalCoins})`)
        : '';
      const shardsAction = finalShards > 0 
        ? boardAction(`Update the Heir's Shards with <strong>+${finalShards} Shards</strong>. (${currentShards} ‚Üí ${currentShards + finalShards})`)
        : '';
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Step 3 of 3)`,
        `${cardSlotsHtml}
         
         <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0;">
           ${fameBreakdown}
           ${coinsBreakdown}
           ${shardsBreakdown}
         </div>
         
         <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0; padding: 15px; background: rgba(212, 168, 71, 0.15); border: 2px solid var(--amber); border-radius: 8px;">
           <div style="text-align: center;">
             <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">TOTAL</div>
             <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${finalFame} ‚òÖ</div>
           </div>
           <div style="text-align: center;">
             <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">TOTAL</div>
             <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${finalCoins} ü™ô</div>
           </div>
           <div style="text-align: center;">
             <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">TOTAL</div>
             <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${finalShards} üíé</div>
           </div>
         </div>
         
         ${fameAction}
         ${coinsAction}
         ${shardsAction}
         
         ${boardAction("Return ALL of the Heir's Trick markers from card " + winningCard + " back to their Trick cards")}
         
         <div style="background: rgba(74, 158, 107, 0.15); border-left: 3px solid var(--success); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;">
           <span style="color: var(--success); font-weight: 600;">üë§ PLAYER:</span> If you have Tricks on card ${winningCard}, collect your Trick Yields now (Fame, Coins, Shards from your Trick cards).
         </div>
         
         ${boardAction("Return YOUR Trick markers (if any) from card " + winningCard + " to your supply")}`,
        [
          { text: '‚Üê Back', action: () => {
            showHeirPerformanceStep2_CardBonus();
          }},
          { text: 'Done', action: () => {
            // Update gameState with final totals
            gameState.heir.fame += finalFame;
            gameState.heir.coins += finalCoins;
            gameState.heir.shards += finalShards;
            updateGameDisplay();
            
            // Reset temp data
            heirPerformanceTempData = {
              winningCard: null,
              winningLinks: 0,
              results: [],
              trickYields: { fame: 0, coins: 0, shards: 0 },
              trickCountsByLevel: { level1: 0, level2: 0, level3: 0 },
              cardBonus: { fame: 0, coins: 0, shards: 0 },
              redLotusTricks: 0,
              playerHasTricksOnCard: false
            };
            
            // Route to next phase
            const isHeirFirst = !gameState.performanceOrder || gameState.performanceOrder === 'heir-first';
            if (isHeirFirst) {
              askIfPlayerPerforming();
            } else {
              advancePhase();
            }
          }}
        ]
      );
    }
    
    // Helper function to build card slots visual
    function buildCardSlotsVisual(cardCount, selectedSlots, winningCard) {
      return `
        <div style="display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap;">
          ${[1,2,3,4,5].map(i => {
            const hasCard = i <= cardCount;
            const isWinningCard = i === winningCard;
            const isSelectedCard = selectedSlots.includes(i);
            
            if (!hasCard) {
              return `<div style="
                width: 50px;
                height: 70px;
                background: transparent;
                border: 2px dashed var(--border);
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-muted);
                font-size: 0.8rem;
                opacity: 0.4;
              ">‚Äî</div>`;
            }
            
            let bgColor = 'var(--bg-main)';
            let borderColor = 'var(--border)';
            let textColor = 'var(--text-muted)';
            let boxShadow = 'none';
            let content = i;
            
            if (isWinningCard) {
              bgColor = 'rgba(212, 168, 71, 0.2)';
              borderColor = 'var(--amber)';
              textColor = 'var(--amber)';
              boxShadow = '0 0 15px rgba(212, 168, 71, 0.4)';
              content = '‚òÖ';
            } else if (isSelectedCard) {
              bgColor = 'var(--bg-card)';
              borderColor = 'var(--amber)';
              textColor = 'var(--text-secondary)';
            }
            
            return `<div style="
              width: 50px;
              height: 70px;
              background: ${bgColor};
              border: 2px solid var(--prophecy);
              border-radius: 4px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: ${textColor};
              font-weight: 600;
              font-size: ${isWinningCard ? '1.2rem' : '0.9rem'};
              box-shadow: ${boxShadow};
            ">${content}</div>`;
          }).join('')}
        </div>
        <p style="text-align: center; color: var(--amber); font-size: 0.95rem; margin-bottom: 15px;">
          <strong>The Heir performs card ${winningCard}</strong>
        </p>`;
    }
    
    function askIfPlayerPerforming() {
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Your Turn)`,
        `<p><strong>Are you performing this turn?</strong></p>
         
         ${infoBox("You perform if your Magician is in a Performance slot (Theater) and you have Trick markers on at least one Performance card.")}`,
        [
          { text: 'Yes ‚Äî I am performing', action: () => showPlayerPerformanceScreen() },
          { text: 'No ‚Äî I am not performing', action: () => advancePhase() }
        ]
      );
    }
    
    function showPlayerPerformanceScreen() {
      // Consolidated screen for when player performs
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      
      const prophecyReminder = getProphecyReminderHtml('performance');
      const isPlayerFirst = gameState.performanceOrder === 'player-first';
      
      // Check for prophecies that affect Heir yield calculations
      const isCoinsAsFame = gameState.activeProphecy?.id === 'p16';
      const isExtraShard = gameState.activeProphecy?.id === 'p19';
      const isShardsGiveFame = gameState.activeProphecy?.id === 'p20';
      
      // Shared calculation function
      const calculatePlayerPerfGains = () => {
        let fame = Math.max(0, parseInt($('#heir-player-perf-fame')?.value) || 0);
        let coins = Math.max(0, parseInt($('#heir-player-perf-coins')?.value) || 0);
        let shards = Math.max(0, parseInt($('#heir-player-perf-shards')?.value) || 0);
        
        // Apply p16 (Coins As Fame) - convert all coins to fame
        if (isCoinsAsFame && coins > 0) {
          fame += coins;
          coins = 0;
        }
        
        // Add p19 bonus (Extra Shard) - +1 shard if any shards received
        if (isExtraShard && shards > 0) {
          shards += 1;
        }
        
        // Add p20 bonus (Shards Give Fame) - +2 Fame if any shards received
        if (isShardsGiveFame && shards > 0) {
          fame += 2;
        }
        
        return { fame, coins, shards };
      };
      
      // Update board action text dynamically
      const updatePlayerPerfBoardAction = () => {
        const gains = calculatePlayerPerfGains();
        const currentFame = gameState.heir.fame;
        const currentCoins = gameState.heir.coins;
        const currentShards = gameState.heir.shards;
        
        const boardActionEl = $('#player-perf-board-action');
        if (boardActionEl) {
          boardActionEl.innerHTML = `Update Heir's Fame (${currentFame} ‚Üí ${currentFame + gains.fame}), Coins (${currentCoins} ‚Üí ${currentCoins + gains.coins}), and Shards (${currentShards} ‚Üí ${currentShards + gains.shards})`;
        }
      };
      
      // Sanitize input to prevent negative values
      const sanitizeInput = (e) => {
        const val = parseInt(e.target.value);
        if (val < 0) e.target.value = 0;
        updatePlayerPerfBoardAction();
      };
      
      // Current values for initial display
      const currentFame = gameState.heir.fame;
      const currentCoins = gameState.heir.coins;
      const currentShards = gameState.heir.shards;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Player)`,
        `${boardAction("Perform ALL tricks on a Performance card with at least 1 of your trick markers on")}
         
         ${infoBox("If the Heir had tricks on your performed card, they also receive base yields from those tricks. Enter below (leave as 0 if no Heir tricks).")}
         
         ${noteBox("The Heir ignores Thursday/Sunday modifiers ‚Äî always use base Trick Yields.")}
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="margin-bottom: 15px; color: var(--text-secondary); font-size: 0.9rem;"><strong>Heir's Yields from your performed card:</strong></p>
           
           <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
             <div>
               <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
                 <span style="font-size: 1.3rem;">‚òÖ</span> Fame
               </label>
               <input type="number" id="heir-player-perf-fame" value="0" min="0" max="30" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
             </div>
             <div>
               <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
                 <span style="font-size: 1.3rem;">ü™ô</span> Coins
               </label>
               <input type="number" id="heir-player-perf-coins" value="0" min="0" max="30" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
             </div>
             <div>
               <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
                 <span style="font-size: 1.3rem;">üíé</span> Shards
               </label>
               <input type="number" id="heir-player-perf-shards" value="0" min="0" max="10" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
             </div>
           </div>
         </div>
         
         ${prophecyReminder}
         
         <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);" id="player-perf-board-action">Update Heir's Fame (${currentFame} ‚Üí ${currentFame}), Coins (${currentCoins} ‚Üí ${currentCoins}), and Shards (${currentShards} ‚Üí ${currentShards})</span></div>
         
         ${boardAction("Return your trick markers to your supply")}
         
         ${boardAction("Return the Heir's trick markers (if any) to their tricks")}`,
        [
          { text: 'Continue', action: () => {
            // Use shared calculation function
            const gains = calculatePlayerPerfGains();
            
            gameState.heir.fame += gains.fame;
            gameState.heir.coins += gains.coins;
            gameState.heir.shards += gains.shards;
            updateGameDisplay();
            
            if (isPlayerFirst) {
              showHeirPerformingCheckAfterPlayer();
            } else {
              advancePhase();
            }
          }}
        ]
      );
      
      // Add input listeners for dynamic board action update
      setTimeout(() => {
        const inputs = ['#heir-player-perf-fame', '#heir-player-perf-coins', '#heir-player-perf-shards'];
        inputs.forEach(selector => {
          const input = $(selector);
          if (input) {
            input.addEventListener('input', sanitizeInput);
          }
        });
      }, 0);
    }
    
    function showHeirPerformingCheckAfterPlayer() {
      // After player performed and shared tricks handled, now check if Heir is performing
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Performance (Heir)`,
        `<p style="margin-bottom: 15px;"><strong>Is the Heir performing this turn?</strong></p>
         
         ${noteBox("The Heir performs if BOTH conditions are met:<br>‚Ä¢ Its Magician is in a Performance slot (Theater)<br>‚Ä¢ It has Trick markers on at least one Performance card")}
         
         ${infoBox("The Heir ignores Thursday/Sunday yield modifiers ‚Äî it always receives base Yields.")}`,
        [
          { text: 'Yes ‚Äî Heir is performing', action: () => showPerformanceCardSelection() },
          { text: 'No ‚Äî Heir is not performing', action: () => advancePhase() }
        ]
      );
    }

    function handleEndTurnPhase() {
      // Dawn of Technology: Optional challenge rule - ask before normal End Turn
      if (gameState.expansions.dawnChallengeRule) {
        showDawnChallengeRuleInput();
        return;
      }
      
      // Normal End Turn flow
      continueToEndTurn();
    }
    
    function showDawnChallengeRuleInput() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî Dawn of Technology Challenge`,
        `<div style="background: rgba(212, 168, 71, 0.1); border: 1px solid var(--amber); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
           <p style="color: var(--amber); font-weight: 600; margin-bottom: 8px;">‚öô Dawn of Technology ‚Äî Challenge Rule</p>
           <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">The Heir gains resources based on your Contraption usage this turn.</p>
         </div>
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <div style="margin-bottom: 15px;">
             <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">How many Contraptions did you <strong>NOT</strong> reactivate this turn?</label>
             <input type="number" id="dawn-unreactivated" value="0" min="0" max="4" style="width: 100px; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
             <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 10px;">(Heir gains 1 Fame each)</span>
           </div>
           
           <div style="margin-bottom: 15px;">
             <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">How many <strong>empty</strong> Contraption slots do you have?</label>
             <input type="number" id="dawn-empty-slots" value="0" min="0" max="4" style="width: 100px; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
             <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 10px;">(Heir gains 1 Coin each)</span>
           </div>
         </div>
         
         ${infoBox("If the Heir gains neither Fame nor Coins from this rule, it gains 1 Shard instead.")}
         
         <div id="dawn-result-preview" style="background: var(--bg-card); padding: 12px; border-radius: 6px; border: 1px solid var(--border);"></div>`,
        [{ text: 'Apply & Continue', action: applyDawnChallengeRule }]
      );
      
      // Update preview on input change
      setTimeout(() => {
        const updatePreview = () => {
          const unreactivated = Math.max(0, parseInt($('#dawn-unreactivated')?.value) || 0);
          const emptySlots = Math.max(0, parseInt($('#dawn-empty-slots')?.value) || 0);
          const preview = $('#dawn-result-preview');
          
          if (preview) {
            let resultText = '';
            if (unreactivated > 0 || emptySlots > 0) {
              const parts = [];
              if (unreactivated > 0) parts.push(`<strong>+${unreactivated}‚òÖ Fame</strong>`);
              if (emptySlots > 0) parts.push(`<strong>+${emptySlots} Coins</strong>`);
              resultText = `Heir gains: ${parts.join(' and ')}`;
            } else {
              resultText = `Heir gains: <strong>+1 Shard</strong> (neither Fame nor Coins apply)`;
            }
            preview.innerHTML = `<p style="margin: 0; color: var(--text-secondary);">Result: ${resultText}</p>`;
          }
        };
        
        $('#dawn-unreactivated')?.addEventListener('input', updatePreview);
        $('#dawn-empty-slots')?.addEventListener('input', updatePreview);
        updatePreview(); // Initial preview
      }, 0);
    }
    
    function applyDawnChallengeRule() {
      const unreactivated = Math.max(0, parseInt($('#dawn-unreactivated')?.value) || 0);
      const emptySlots = Math.max(0, parseInt($('#dawn-empty-slots')?.value) || 0);
      
      if (unreactivated > 0 || emptySlots > 0) {
        // Apply Fame and Coins
        gameState.heir.fame += unreactivated;
        gameState.heir.coins += emptySlots;
      } else {
        // Neither applies - gain 1 Shard
        gameState.heir.shards += 1;
        
        // Check p19 (Extra Shard) and p20 (Shards Give Fame)
        if (gameState.activeProphecy?.id === 'p19') {
          gameState.heir.shards += 1;
        }
        if (gameState.activeProphecy?.id === 'p20') {
          gameState.heir.fame += 2;
        }
      }
      
      updateGameDisplay();
      continueToEndTurn();
    }
    
    function continueToEndTurn() {
      // Turn 7 has a streamlined End Turn (no setup for next turn)
      if (gameState.currentTurn === 7) {
        showEndTurnFinalTurn();
      } else if (gameState.currentTurn >= 3) {
        // For Turn 3-6, we need to ask about tricks on removed Performance card
        showEndTurnPartOne();
      } else {
        // Turns 1-2: no card removal
        showEndTurnFull();
      }
    }
    
    function showEndTurnPartOne() {
      // Steps 1-3, then ask about removed card
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      
      // Capture pending characters before processing
      const newCharacters = [...gameState.heir.pendingCharacters];
      
      // Heir wage conversion
      const famePerSet = gameState.difficulty === 'easy' ? 2 : 3;
      let coinsConverted = 0;
      let fameGained = 0;
      
      while (gameState.heir.coins >= 10) {
        gameState.heir.coins -= 10;
        coinsConverted += 10;
        fameGained += famePerSet;
        gameState.heir.fame += famePerSet;
      }
      
      updateGameDisplay();
      
      let content = '';
      
      // Pay Wages
      content += boardAction("Player pays wages");
      content += noteBox("You pay: 1 Coin per non-Idle Apprentice, 2 Coins per Specialist");
      
      if (coinsConverted > 0) {
        content += `
          <div style="background: rgba(212, 168, 71, 0.1); border: 1px solid var(--amber); padding: 10px; border-radius: 6px; margin: 8px 0;">
            <p style="color: var(--amber); font-weight: 600; margin-bottom: 4px;">Heir Coin Conversion</p>
            <p style="margin: 0;">The Heir had ${coinsConverted + gameState.heir.coins} coins ‚Üí converted ${coinsConverted} coins to <strong>${fameGained}‚òÖ Fame</strong> (${gameState.heir.coins} remaining)</p>
          </div>`;
        content += boardAction(`Move the Heir's Fame marker forward <strong>${fameGained}</strong> spaces (to ${gameState.heir.fame}‚òÖ)`);
      } else {
        content += infoBox(`The Heir has ${gameState.heir.coins} coins (less than 10) ‚Äî no conversion.`);
      }
      
      // Return Characters
      content += boardAction("Return all Character disks to their boards");
      content += noteBox("If you hired any new characters this turn, add them to your board now.");
      
      if (gameState.heir.pendingCharacters.length > 0) {
        const newCount = gameState.heir.pendingCharacters.length;
        const newTypes = gameState.heir.pendingCharacters.join(', ');
        content += boardAction(`Move the Heir's <strong>${newCount}</strong> newly hired character(s) (${newTypes}) into their board slots`);
        
        gameState.heir.characters.push(...gameState.heir.pendingCharacters);
        gameState.heir.pendingCharacters = [];
        updateGameDisplay();
      }
      
      // Build dynamic character order icons
      const sortOrder = { 'magician': 0, 'engineer': 1, 'manager': 2, 'assistant': 3, 'apprentice': 4 };
      const allChars = [...gameState.heir.characters].sort((a, b) => sortOrder[a] - sortOrder[b]);
      
      const characterOrderIcons = allChars.map((char, index) => {
        const isNew = newCharacters.includes(char) && newCharacters.indexOf(char) <= allChars.filter((c, i) => i <= index && newCharacters.includes(c)).length - 1;
        // Check if this specific instance is new (handle multiple apprentices)
        const countBefore = allChars.slice(0, index + 1).filter(c => c === char).length;
        const newCountOfType = newCharacters.filter(c => c === char).length;
        const existingCountOfType = gameState.heir.characters.filter(c => c === char).length - newCountOfType;
        const isNewInstance = countBefore > existingCountOfType;
        
        const highlight = isNewInstance ? 'border: 2px solid var(--amber); border-radius: 50%; box-shadow: 0 0 8px var(--amber);' : '';
        return `<img src="assets/images/characters/${char}.png" alt="${char}" style="width: 28px; height: 28px; vertical-align: middle; ${highlight}">`;
      }).join(' ‚Üí ');
      
      content += `
          <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
            <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è Heir board order:</span>
            <span style="margin-left: 8px;">${characterOrderIcons}</span>
          </div>`;
      
      // Orders Arrive
      content += boardAction("Move all Components from Order slots to the Buy area of Market Row");
      
      // Move Performance Cards - ask about removed card
      content += boardAction("Move all Performance cards one slot clockwise");
      content += boardAction("Discard the rightmost Performance card");
      
      content += `
          <div style="background: rgba(212, 168, 71, 0.1); border: 1px solid var(--amber); padding: 10px; border-radius: 6px; margin: 8px 0;">
            <p style="color: var(--amber); font-weight: 600; margin-bottom: 6px;">Check the discarded card:</p>
            <p style="margin: 0;">Did the removed card have any of the <strong>Heir's Trick markers</strong>? If yes, the Heir receives Yields (minus 1 Coin and 1 Fame per Trick).</p>
          </div>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî End Turn (Part 1)`,
        content,
        [
          { text: 'Yes ‚Äî Heir had Tricks on removed card', action: () => showRemovedCardYields() },
          { text: 'No ‚Äî Continue', action: () => showEndTurnPartTwo() }
        ]
      );
    }
    
    function showRemovedCardYields() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      // p19 and p20 apply "any time" shards received - mapped to 'end-turn' phase
      // Note: p16 (Coins As Fame) does NOT apply here - it only affects Performance phase
      const prophecyReminder = getProphecyReminderHtml('end-turn');
      
      // Still need these flags for the calculation logic
      const isExtraShard = gameState.activeProphecy?.id === 'p19';
      const isShardsGiveFame = gameState.activeProphecy?.id === 'p20';
      
      // Shared calculation function
      const calculateRemovedCardGains = () => {
        let fame = Math.max(0, parseInt($('#removed-card-fame')?.value) || 0);
        let coins = Math.max(0, parseInt($('#removed-card-coins')?.value) || 0);
        let shards = Math.max(0, parseInt($('#removed-card-shards')?.value) || 0);
        
        // Add p19 bonus (Extra Shard) - +1 shard if any shards received
        if (isExtraShard && shards > 0) {
          shards += 1;
        }
        
        // Add p20 bonus (Shards Give Fame) - +2 Fame if any shards received
        if (isShardsGiveFame && shards > 0) {
          fame += 2;
        }
        
        return { fame, coins, shards };
      };
      
      // Update board action text dynamically
      const updateRemovedCardBoardAction = () => {
        const gains = calculateRemovedCardGains();
        const currentFame = gameState.heir.fame;
        const currentCoins = gameState.heir.coins;
        const currentShards = gameState.heir.shards;
        
        const boardActionEl = $('#removed-card-board-action');
        if (boardActionEl) {
          boardActionEl.innerHTML = `Update Heir's Fame (${currentFame} ‚Üí ${currentFame + gains.fame}), Coins (${currentCoins} ‚Üí ${currentCoins + gains.coins}), and Shards (${currentShards} ‚Üí ${currentShards + gains.shards})`;
        }
      };
      
      // Sanitize input to prevent negative values
      const sanitizeInput = (e) => {
        const val = parseInt(e.target.value);
        if (val < 0) e.target.value = 0;
        updateRemovedCardBoardAction();
      };
      
      // Current values for initial display
      const currentFame = gameState.heir.fame;
      const currentCoins = gameState.heir.coins;
      const currentShards = gameState.heir.shards;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî End Turn (Removed Card Yields)`,
        `<p><strong>Heir receives Yields from Tricks on the removed Performance card</strong></p>
         
         ${infoBox("The Heir receives the Yield of each Trick, <strong>minus 1 Coin and 1 Fame per Trick</strong>.")}
         
         ${infoBox("<strong>Example:</strong> If Heir had 2 Tricks with yields of (3‚òÖ, 2ü™ô) and (2‚òÖ, 1ü™ô), total is 5‚òÖ and 3ü™ô, then subtract 2‚òÖ and 2ü™ô = <strong>3‚òÖ Fame, 1ü™ô Coin</strong>")}
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
             <div>
               <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
                 <span style="font-size: 1.3rem;">‚òÖ</span> Fame (after -1 each)
               </label>
               <input type="number" id="removed-card-fame" value="0" min="0" max="30" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
             </div>
             <div>
               <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
                 <span style="font-size: 1.3rem;">ü™ô</span> Coins (after -1 each)
               </label>
               <input type="number" id="removed-card-coins" value="0" min="0" max="30" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
             </div>
             <div>
               <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--text-secondary);">
                 <span style="font-size: 1.3rem;">üíé</span> Shards
               </label>
               <input type="number" id="removed-card-shards" value="0" min="0" max="10" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 1.1rem; text-align: center;">
             </div>
           </div>
         </div>
         
         ${prophecyReminder}
         
         <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);" id="removed-card-board-action">Update Heir's Fame (${currentFame} ‚Üí ${currentFame}), Coins (${currentCoins} ‚Üí ${currentCoins}), and Shards (${currentShards} ‚Üí ${currentShards})</span></div>
         ${boardAction("Return the Heir's Trick markers from the removed card to their Trick cards")}`,
        [
          { text: 'Continue', action: () => {
            // Use shared calculation function
            const gains = calculateRemovedCardGains();
            
            gameState.heir.fame += gains.fame;
            gameState.heir.coins += gains.coins;
            gameState.heir.shards += gains.shards;
            updateGameDisplay();
            showEndTurnPartTwo();
          }}
        ]
      );
      
      // Add input listeners for dynamic board action update
      setTimeout(() => {
        const inputs = ['#removed-card-fame', '#removed-card-coins', '#removed-card-shards'];
        inputs.forEach(selector => {
          const input = $(selector);
          if (input) {
            input.addEventListener('input', sanitizeInput);
          }
        });
      }, 0);
    }
    
    function showEndTurnPartTwo() {
      // First ask about SA card usage this turn
      const totalSACards = Object.values(gameState.heir.specialAssignments).reduce((a, b) => a + b, 0);
      
      if (totalSACards > 0) {
        showSACardUsageQuestion();
      } else {
        showEndTurnPartTwoFinal();
      }
    }
    
    function showSACardUsageQuestion() {
      const assignments = gameState.heir.specialAssignments;
      
      // Build location buttons only for colors they have
      let locationButtons = '';
      if (assignments.theater > 0) locationButtons += `<button class="btn sa-select-btn" data-color="theater" style="background: rgba(152, 48, 48, 0.2); border: 2px solid #983030;">Theater</button>`;
      if (assignments.downtown > 0) locationButtons += `<button class="btn sa-select-btn" data-color="downtown" style="background: rgba(201, 184, 74, 0.2); border: 2px solid #C9B84A;">Downtown</button>`;
      if (assignments.market > 0) locationButtons += `<button class="btn sa-select-btn" data-color="market" style="background: rgba(196, 128, 64, 0.2); border: 2px solid #C48040;">Market</button>`;
      if (assignments.workshop > 0) locationButtons += `<button class="btn sa-select-btn" data-color="workshop" style="background: rgba(200, 112, 96, 0.2); border: 2px solid #C87060;">Workshop</button>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî End Turn (SA Cards)`,
        `<p><strong>Did the Heir use a Special Assignment card this turn?</strong></p>
         
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="margin-bottom: 10px;"><strong>Current SA Cards:</strong></p>
           <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
             ${assignments.theater > 0 ? `<span class="assignment-badge" style="background: rgba(152, 48, 48, 0.2); border: 1px solid #983030; padding: 4px 8px; border-radius: 4px;">Theater: ${assignments.theater}</span>` : ''}
             ${assignments.downtown > 0 ? `<span class="assignment-badge" style="background: rgba(201, 184, 74, 0.2); border: 1px solid #C9B84A; padding: 4px 8px; border-radius: 4px;">Downtown: ${assignments.downtown}</span>` : ''}
             ${assignments.market > 0 ? `<span class="assignment-badge" style="background: rgba(196, 128, 64, 0.2); border: 1px solid #C48040; padding: 4px 8px; border-radius: 4px;">Market: ${assignments.market}</span>` : ''}
             ${assignments.workshop > 0 ? `<span class="assignment-badge" style="background: rgba(200, 112, 96, 0.2); border: 1px solid #C87060; padding: 4px 8px; border-radius: 4px;">Workshop: ${assignments.workshop}</span>` : ''}
           </div>
         </div>
         
         <p style="margin-top: 15px;"><strong>Which SA card was used? (Select one)</strong></p>
         <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
           <button class="btn sa-select-btn" data-color="none">None</button>
           ${locationButtons}
         </div>
         
         <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 15px;"><em>Used cards are discarded and won't count for end game scoring.</em></p>`,
        [
          { text: 'Continue', action: () => processSACardUsage() }
        ]
      );
      
      // Single-select behavior + disable Continue until selection made
      setTimeout(() => {
        const continueBtn = $('#action-buttons .btn');
        continueBtn.disabled = true;
        
        $$('.sa-select-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            // Deselect all - reset to original colors
            $$('.sa-select-btn').forEach(b => {
              b.classList.remove('selected');
              b.classList.remove('btn-selected');
              if (b.dataset.color === 'none') {
                b.style.background = 'var(--bg-card)';
                b.style.borderColor = 'var(--border)';
                b.style.color = 'var(--text-primary)';
              } else {
                b.style.borderColor = LOCATION_COLORS[b.dataset.color].border;
                b.style.background = LOCATION_COLORS[b.dataset.color].bg;
                b.style.color = 'var(--text-primary)';
              }
            });
            // Select clicked
            btn.classList.add('selected');
            btn.classList.add('btn-selected');
            // Enable continue button
            continueBtn.disabled = false;
          });
        });
      }, 0);
    }
    
    function processSACardUsage() {
      // Find selected SA card (if not "none")
      const selected = $('.sa-select-btn.selected');
      if (selected && selected.dataset.color !== 'none') {
        const color = selected.dataset.color;
        if (gameState.heir.specialAssignments[color] > 0) {
          gameState.heir.specialAssignments[color]--;
        }
      }
      
      updateGameDisplay();
      showEndTurnPartTwoFinal();
    }
    
    function showEndTurnPartTwoFinal() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      
      let content = '';
      
      // Place new Performance card
      content += boardAction("Place a new Performance card in the leftmost empty slot");
      
      // Return Magician Posters
      content += boardAction("Return all Magician Posters to their respective player boards");
      
      // Move Prophecies
      const prophecyInstruction = gameState.activeProphecy 
        ? "Discard the Active Prophecy; move Pending Prophecies left; draw a new Prophecy for the rightmost slot"
        : "Move Pending Prophecies left; draw a new Prophecy for the rightmost slot";
      content += boardAction(prophecyInstruction);
      
      // Discard Special Assignment cards
      content += boardAction("Discard any used Special Assignment cards to their respective discard piles");
      content += noteBox("Keep collected SA cards face-up near your board for end game scoring");
      
      // Return Assignment Cards
      content += boardAction("Return all Assignment cards (yours and the Heir's) to their respective boards");
      
      // Move Trickerion Stone
      content += boardAction("Advance the Trickerion Stone token one step forward on the Turn Counter track");
      
      const isLastTurn = gameState.currentTurn >= 7;
      const buttonText = isLastTurn ? 'End Game Scoring' : `Start Turn ${gameState.currentTurn + 1}`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî End Turn (Part 2)`,
        content,
        [{ text: buttonText, action: () => isLastTurn ? endGame() : startNextTurn() }]
      );
    }
    
    function showEndTurnFull() {
      // First do the coin conversion
      const famePerSet = gameState.difficulty === 'easy' ? 2 : 3;
      let coinsConverted = 0;
      let fameGained = 0;
      
      while (gameState.heir.coins >= 10) {
        gameState.heir.coins -= 10;
        coinsConverted += 10;
        fameGained += famePerSet;
        gameState.heir.fame += famePerSet;
      }
      
      updateGameDisplay();
      
      // Store conversion info for display
      gameState.pendingEndTurn = { coinsConverted, fameGained };
      
      // Check if we need to ask about SA card usage
      const totalSACards = Object.values(gameState.heir.specialAssignments).reduce((a, b) => a + b, 0);
      
      if (totalSACards > 0) {
        showSACardUsageQuestionFull();
      } else {
        showEndTurnFullFinal();
      }
    }
    
    function showSACardUsageQuestionFull() {
      const assignments = gameState.heir.specialAssignments;
      
      // Build location buttons only for colors they have
      let locationButtons = '';
      if (assignments.theater > 0) locationButtons += `<button class="btn sa-select-btn-full" data-color="theater" style="background: rgba(152, 48, 48, 0.2); border: 2px solid #983030;">Theater</button>`;
      if (assignments.downtown > 0) locationButtons += `<button class="btn sa-select-btn-full" data-color="downtown" style="background: rgba(201, 184, 74, 0.2); border: 2px solid #C9B84A;">Downtown</button>`;
      if (assignments.market > 0) locationButtons += `<button class="btn sa-select-btn-full" data-color="market" style="background: rgba(196, 128, 64, 0.2); border: 2px solid #C48040;">Market</button>`;
      if (assignments.workshop > 0) locationButtons += `<button class="btn sa-select-btn-full" data-color="workshop" style="background: rgba(200, 112, 96, 0.2); border: 2px solid #C87060;">Workshop</button>`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî End Turn (SA Cards)`,
        `<p><strong>Did the Heir use a Special Assignment card this turn?</strong></p>
         
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="margin-bottom: 10px;"><strong>Current SA Cards:</strong></p>
           <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
             ${assignments.theater > 0 ? `<span class="assignment-badge" style="background: rgba(152, 48, 48, 0.2); border: 1px solid #983030; padding: 4px 8px; border-radius: 4px;">Theater: ${assignments.theater}</span>` : ''}
             ${assignments.downtown > 0 ? `<span class="assignment-badge" style="background: rgba(201, 184, 74, 0.2); border: 1px solid #C9B84A; padding: 4px 8px; border-radius: 4px;">Downtown: ${assignments.downtown}</span>` : ''}
             ${assignments.market > 0 ? `<span class="assignment-badge" style="background: rgba(196, 128, 64, 0.2); border: 1px solid #C48040; padding: 4px 8px; border-radius: 4px;">Market: ${assignments.market}</span>` : ''}
             ${assignments.workshop > 0 ? `<span class="assignment-badge" style="background: rgba(200, 112, 96, 0.2); border: 1px solid #C87060; padding: 4px 8px; border-radius: 4px;">Workshop: ${assignments.workshop}</span>` : ''}
           </div>
         </div>
         
         <p style="margin-top: 15px;"><strong>Which SA card was used? (Select one)</strong></p>
         <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
           <button class="btn sa-select-btn-full" data-color="none">None</button>
           ${locationButtons}
         </div>
         
         <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 15px;"><em>Used cards are discarded and won't count for end game scoring.</em></p>`,
        [
          { text: 'Continue', action: () => processSACardUsageFull() }
        ]
      );
      
      // Single-select behavior + disable Continue until selection made
      setTimeout(() => {
        const continueBtn = $('#action-buttons .btn');
        continueBtn.disabled = true;
        
        $$('.sa-select-btn-full').forEach(btn => {
          btn.addEventListener('click', () => {
            // Deselect all - reset to original colors
            $$('.sa-select-btn-full').forEach(b => {
              b.classList.remove('selected');
              b.classList.remove('btn-selected');
              if (b.dataset.color === 'none') {
                b.style.background = 'var(--bg-card)';
                b.style.borderColor = 'var(--border)';
                b.style.color = 'var(--text-primary)';
              } else {
                b.style.borderColor = LOCATION_COLORS[b.dataset.color].border;
                b.style.background = LOCATION_COLORS[b.dataset.color].bg;
                b.style.color = 'var(--text-primary)';
              }
            });
            // Select clicked
            btn.classList.add('selected');
            btn.classList.add('btn-selected');
            // Enable continue button
            continueBtn.disabled = false;
          });
        });
      }, 0);
    }
    
    function processSACardUsageFull() {
      // Find selected SA card (if not "none")
      const selected = $('.sa-select-btn-full.selected');
      if (selected && selected.dataset.color !== 'none') {
        const color = selected.dataset.color;
        if (gameState.heir.specialAssignments[color] > 0) {
          gameState.heir.specialAssignments[color]--;
        }
      }
      
      updateGameDisplay();
      showEndTurnFullFinal();
    }
    
    function showEndTurnFullFinal() {
      // For Turns 1-2, no card is removed, so show full End Turn in one screen
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      
      // Capture pending characters before processing
      const newCharacters = [...gameState.heir.pendingCharacters];
      
      // Get stored conversion info
      const { coinsConverted, fameGained } = gameState.pendingEndTurn || { coinsConverted: 0, fameGained: 0 };
      
      let content = '';
      
      // Pay Wages
      content += boardAction("Player pays wages");
      content += noteBox("You pay: 1 Coin per non-Idle Apprentice, 2 Coins per Specialist");
      
      if (coinsConverted > 0) {
        content += `
          <div style="background: rgba(212, 168, 71, 0.1); border: 1px solid var(--amber); padding: 10px; border-radius: 6px; margin: 8px 0;">
            <p style="color: var(--amber); font-weight: 600; margin-bottom: 4px;">Heir Coin Conversion</p>
            <p style="margin: 0;">The Heir had ${coinsConverted + gameState.heir.coins} coins ‚Üí converted ${coinsConverted} coins to <strong>${fameGained}‚òÖ Fame</strong> (${gameState.heir.coins} remaining)</p>
          </div>`;
        content += boardAction(`Move the Heir's Fame marker forward <strong>${fameGained}</strong> spaces (to ${gameState.heir.fame}‚òÖ)`);
      } else {
        content += infoBox(`The Heir has ${gameState.heir.coins} coins (less than 10) ‚Äî no conversion.`);
      }
      
      // Return Characters
      content += boardAction("Return all Character disks to their boards");
      content += noteBox("If you hired any new characters this turn, add them to your board now.");
      
      if (gameState.heir.pendingCharacters.length > 0) {
        const newCount = gameState.heir.pendingCharacters.length;
        const newTypes = gameState.heir.pendingCharacters.join(', ');
        content += boardAction(`Move the Heir's <strong>${newCount}</strong> newly hired character(s) (${newTypes}) into their board slots`);
        
        gameState.heir.characters.push(...gameState.heir.pendingCharacters);
        gameState.heir.pendingCharacters = [];
        updateGameDisplay();
      }
      
      // Build dynamic character order icons
      const sortOrder = { 'magician': 0, 'engineer': 1, 'manager': 2, 'assistant': 3, 'apprentice': 4 };
      const allChars = [...gameState.heir.characters].sort((a, b) => sortOrder[a] - sortOrder[b]);
      
      const characterOrderIcons = allChars.map((char, index) => {
        // Check if this specific instance is new (handle multiple apprentices)
        const countBefore = allChars.slice(0, index + 1).filter(c => c === char).length;
        const newCountOfType = newCharacters.filter(c => c === char).length;
        const existingCountOfType = gameState.heir.characters.filter(c => c === char).length - newCountOfType;
        const isNewInstance = countBefore > existingCountOfType;
        
        const highlight = isNewInstance ? 'border: 2px solid var(--amber); border-radius: 50%; box-shadow: 0 0 8px var(--amber);' : '';
        return `<img src="assets/images/characters/${char}.png" alt="${char}" style="width: 28px; height: 28px; vertical-align: middle; ${highlight}">`;
      }).join(' ‚Üí ');
      
      content += `
          <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;">
            <span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è Heir board order:</span>
            <span style="margin-left: 8px;">${characterOrderIcons}</span>
          </div>`;
      
      // Orders Arrive
      content += boardAction("Move all Components from Order slots to the Buy area of Market Row");
      
      // Move Performance Cards (no removal for Turn 1-2)
      content += boardAction("Move all Performance cards one slot clockwise");
      content += boardAction("Place a new Performance card in the leftmost empty slot");
      content += noteBox("No card is discarded until Turn 3.");
      
      // Return Magician Posters
      content += boardAction("Return all Magician Posters to their respective player boards");
      
      // Move Prophecies
      const prophecyInstruction2 = gameState.activeProphecy 
        ? "Discard the Active Prophecy; move Pending Prophecies left; draw a new Prophecy for the rightmost slot"
        : "Move Pending Prophecies left; draw a new Prophecy for the rightmost slot";
      content += boardAction(prophecyInstruction2);
      
      // Discard Special Assignment cards
      content += boardAction("Discard any used Special Assignment cards to their respective discard piles");
      content += noteBox("Keep collected SA cards face-up near your board for end game scoring");
      
      // Return Assignment Cards
      content += boardAction("Return all Assignment cards (yours and the Heir's) to their respective boards");
      
      // Move Trickerion Stone
      content += boardAction("Advance the Trickerion Stone token one step forward on the Turn Counter track");
      
      const isLastTurn = gameState.currentTurn >= 7;
      const buttonText = isLastTurn ? 'End Game Scoring' : `Start Turn ${gameState.currentTurn + 1}`;
      
      setActionContent(
        `Turn ${gameState.currentTurn} ‚Äî End Turn`,
        content,
        [{ text: buttonText, action: () => isLastTurn ? endGame() : startNextTurn() }]
      );
    }
    
    // ============================================
    // TURN 7 END TURN (Streamlined - no next turn setup)
    // ============================================
    
    function showEndTurnFinalTurn() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      
      // Heir coin conversion
      const famePerSet = gameState.difficulty === 'easy' ? 2 : 3;
      let coinsConverted = 0;
      let fameGained = 0;
      
      while (gameState.heir.coins >= 10) {
        gameState.heir.coins -= 10;
        coinsConverted += 10;
        fameGained += famePerSet;
        gameState.heir.fame += famePerSet;
      }
      
      updateGameDisplay();
      
      // Store conversion info for potential use
      gameState.pendingEndTurn = { coinsConverted, fameGained };
      
      let content = '';
      
      // Pay Wages
      content += boardAction("Player pays wages");
      content += noteBox("You pay: 1 Coin per non-Idle Apprentice, 2 Coins per Specialist");
      
      // Heir Coin Conversion
      if (coinsConverted > 0) {
        content += `
          <div style="background: rgba(212, 168, 71, 0.1); border: 1px solid var(--amber); padding: 10px; border-radius: 6px; margin: 8px 0;">
            <p style="color: var(--amber); font-weight: 600; margin-bottom: 4px;">Heir Coin Conversion</p>
            <p style="margin: 0;">The Heir had ${coinsConverted + gameState.heir.coins} coins ‚Üí converted ${coinsConverted} coins to <strong>${fameGained}‚òÖ Fame</strong> (${gameState.heir.coins} remaining)</p>
          </div>`;
        content += boardAction(`Move the Heir's Fame marker forward <strong>${fameGained}</strong> spaces (to ${gameState.heir.fame}‚òÖ)`);
      } else {
        content += infoBox(`The Heir has ${gameState.heir.coins} coins (less than 10) ‚Äî no conversion.`);
      }
      
      // Discard Performance Card
      content += boardAction("Discard the rightmost Performance card");
      content += boardAction("Return the Heir's Trick markers from the removed card back to their Trick cards");
      
      content += `
          <div style="background: rgba(212, 168, 71, 0.1); border: 1px solid var(--amber); padding: 10px; border-radius: 6px; margin: 8px 0;">
            <p style="color: var(--amber); font-weight: 600; margin-bottom: 6px;">Check the discarded card:</p>
            <p style="margin: 0;">Did the removed card have any of the <strong>Heir's Trick markers</strong>? If yes, the Heir receives Yields (minus 1 Coin and 1 Fame per Trick).</p>
          </div>`;
      
      setActionContent(
        `Turn 7 ‚Äî Final End Turn`,
        content,
        [
          { text: 'Yes ‚Äî Heir had Tricks on removed card', action: () => showRemovedCardYieldsFinalTurn() },
          { text: 'No ‚Äî Continue', action: () => showEndTurnFinalTurnPartTwo() }
        ]
      );
    }
    
    function showRemovedCardYieldsFinalTurn() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      // p19 and p20 apply "any time" shards received
      const prophecyReminder = getProphecyReminderHtml('end-turn');
      
      const isExtraShard = gameState.activeProphecy?.id === 'p19';
      const isShardsGiveFame = gameState.activeProphecy?.id === 'p20';
      
      // Shared calculation function
      const calculateRemovedCardGains = () => {
        let fame = Math.max(0, parseInt($('#removed-card-fame-final')?.value) || 0);
        let coins = Math.max(0, parseInt($('#removed-card-coins-final')?.value) || 0);
        let shards = Math.max(0, parseInt($('#removed-card-shards-final')?.value) || 0);
        
        if (isExtraShard && shards > 0) shards += 1;
        if (isShardsGiveFame && shards > 0) fame += 2;
        
        return { fame, coins, shards };
      };
      
      // Update board action text dynamically
      const updateRemovedCardBoardAction = () => {
        const gains = calculateRemovedCardGains();
        const currentFame = gameState.heir.fame;
        const currentCoins = gameState.heir.coins;
        const currentShards = gameState.heir.shards;
        
        const boardActionEl = $('#removed-card-board-action-final');
        if (boardActionEl) {
          boardActionEl.innerHTML = `Update Heir's Fame (${currentFame} ‚Üí ${currentFame + gains.fame}), Coins (${currentCoins} ‚Üí ${currentCoins + gains.coins}), and Shards (${currentShards} ‚Üí ${currentShards + gains.shards})`;
        }
      };
      
      const sanitizeInput = (e) => {
        const val = parseInt(e.target.value);
        if (val < 0) e.target.value = 0;
        updateRemovedCardBoardAction();
      };
      
      const currentFame = gameState.heir.fame;
      const currentCoins = gameState.heir.coins;
      const currentShards = gameState.heir.shards;
      
      setActionContent(
        `Turn 7 ‚Äî Final End Turn (Removed Card Yields)`,
        `<p><strong>Heir receives Yields from Tricks on the removed Performance card</strong></p>
         
         ${infoBox("The Heir receives the Yield of each Trick, <strong>minus 1 Coin and 1 Fame per Trick</strong>.")}
         
         ${infoBox("<strong>Example:</strong> If Heir had 2 Tricks with yields of (3‚òÖ, 2ü™ô) and (2‚òÖ, 1ü™ô), total is 5‚òÖ and 3ü™ô, then subtract 2‚òÖ and 2ü™ô = <strong>3‚òÖ Fame, 1ü™ô Coin</strong>")}
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
             <div>
               <label style="display: block; margin-bottom: 5px;">‚≠ê Fame</label>
               <input type="number" id="removed-card-fame-final" value="0" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
             </div>
             <div>
               <label style="display: block; margin-bottom: 5px;">ü™ô Coins</label>
               <input type="number" id="removed-card-coins-final" value="0" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
             </div>
             <div>
               <label style="display: block; margin-bottom: 5px;">üíé Shards</label>
               <input type="number" id="removed-card-shards-final" value="0" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
             </div>
           </div>
         </div>
         
         ${prophecyReminder}
         
         <div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);" id="removed-card-board-action-final">Update Heir's Fame (${currentFame} ‚Üí ${currentFame}), Coins (${currentCoins} ‚Üí ${currentCoins}), and Shards (${currentShards} ‚Üí ${currentShards})</span></div>`,
        [
          { text: 'Continue', action: () => {
            const gains = calculateRemovedCardGains();
            gameState.heir.fame += gains.fame;
            gameState.heir.coins += gains.coins;
            gameState.heir.shards += gains.shards;
            updateGameDisplay();
            showEndTurnFinalTurnPartTwo();
          }}
        ]
      );
      
      setTimeout(() => {
        ['#removed-card-fame-final', '#removed-card-coins-final', '#removed-card-shards-final'].forEach(sel => {
          $(sel)?.addEventListener('input', sanitizeInput);
        });
      }, 0);
    }
    
    function showEndTurnFinalTurnPartTwo() {
      // Check if we need to ask about SA card usage
      const totalSACards = Object.values(gameState.heir.specialAssignments).reduce((a, b) => a + b, 0);
      
      if (totalSACards > 0) {
        showSACardUsageQuestionFinalTurn();
      } else {
        showEndTurnFinalTurnFinal();
      }
    }
    
    function showSACardUsageQuestionFinalTurn() {
      const assignments = gameState.heir.specialAssignments;
      
      let locationButtons = '';
      if (assignments.theater > 0) locationButtons += `<button class="btn sa-select-btn-final" data-color="theater" style="background: rgba(152, 48, 48, 0.2); border: 2px solid #983030;">Theater</button>`;
      if (assignments.downtown > 0) locationButtons += `<button class="btn sa-select-btn-final" data-color="downtown" style="background: rgba(201, 184, 74, 0.2); border: 2px solid #C9B84A;">Downtown</button>`;
      if (assignments.market > 0) locationButtons += `<button class="btn sa-select-btn-final" data-color="market" style="background: rgba(196, 128, 64, 0.2); border: 2px solid #C48040;">Market</button>`;
      if (assignments.workshop > 0) locationButtons += `<button class="btn sa-select-btn-final" data-color="workshop" style="background: rgba(200, 112, 96, 0.2); border: 2px solid #C87060;">Workshop</button>`;
      
      setActionContent(
        `Turn 7 ‚Äî Final End Turn (SA Cards)`,
        `<p><strong>Did the Heir use a Special Assignment card this turn?</strong></p>
         
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="margin-bottom: 10px;"><strong>Current SA Cards:</strong></p>
           <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
             ${assignments.theater > 0 ? `<span class="assignment-badge" style="background: rgba(152, 48, 48, 0.2); border: 1px solid #983030; padding: 4px 8px; border-radius: 4px;">Theater: ${assignments.theater}</span>` : ''}
             ${assignments.downtown > 0 ? `<span class="assignment-badge" style="background: rgba(201, 184, 74, 0.2); border: 1px solid #C9B84A; padding: 4px 8px; border-radius: 4px;">Downtown: ${assignments.downtown}</span>` : ''}
             ${assignments.market > 0 ? `<span class="assignment-badge" style="background: rgba(196, 128, 64, 0.2); border: 1px solid #C48040; padding: 4px 8px; border-radius: 4px;">Market: ${assignments.market}</span>` : ''}
             ${assignments.workshop > 0 ? `<span class="assignment-badge" style="background: rgba(200, 112, 96, 0.2); border: 1px solid #C87060; padding: 4px 8px; border-radius: 4px;">Workshop: ${assignments.workshop}</span>` : ''}
           </div>
         </div>
         
         <p style="margin-top: 15px;"><strong>Which SA card was used? (Select one)</strong></p>
         <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
           <button class="btn sa-select-btn-final" data-color="none">None</button>
           ${locationButtons}
         </div>
         
         <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 15px;"><em>Used cards are discarded and won't count for end game scoring.</em></p>`,
        [
          { text: 'Continue', action: () => processSACardUsageFinalTurn(), id: 'continue-btn-final', disabled: true }
        ]
      );
      
      setTimeout(() => {
        const continueBtn = $('#continue-btn-final');
        
        $$('.sa-select-btn-final').forEach(btn => {
          btn.addEventListener('click', () => {
            $$('.sa-select-btn-final').forEach(b => {
              b.classList.remove('selected');
              b.classList.remove('btn-selected');
              if (b.dataset.color === 'none') {
                b.style.background = 'var(--bg-card)';
                b.style.borderColor = 'var(--border)';
              } else {
                b.style.borderColor = LOCATION_COLORS[b.dataset.color].border;
                b.style.background = LOCATION_COLORS[b.dataset.color].bg;
              }
            });
            btn.classList.add('selected');
            btn.classList.add('btn-selected');
            if (continueBtn) continueBtn.disabled = false;
          });
        });
      }, 0);
    }
    
    function processSACardUsageFinalTurn() {
      const selected = $('.sa-select-btn-final.selected');
      if (selected && selected.dataset.color !== 'none') {
        const color = selected.dataset.color;
        if (gameState.heir.specialAssignments[color] > 0) {
          gameState.heir.specialAssignments[color]--;
        }
      }
      
      updateGameDisplay();
      showEndTurnFinalTurnFinal();
    }
    
    function showEndTurnFinalTurnFinal() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      
      let content = '';
      
      content += boardAction("Discard any used Special Assignment cards to their respective discard piles");
      content += noteBox("Keep collected SA cards face-up near your board ‚Äî unused cards count for end game scoring (2 Fame each).");
      
      setActionContent(
        `Turn 7 ‚Äî Final End Turn`,
        content,
        [{ text: 'End Game Scoring', action: () => endGame() }]
      );
    }

    function startNextTurn() {
      gameState.currentTurn++;
      gameState.currentPhaseIndex = 0;
      
      // Reset prophecy for new turn (will be selected after Roll Dice)
      gameState.activeProphecy = null;
      
      // Reset performance order for new turn
      gameState.performanceOrder = null;
      
      // Reset downtown dice for new turn (they get re-rolled)
      gameState.downtownDice = {
        trick1: 'x',
        trick2: 'x',
        apprentice: 'x',
        specialist: 'x',
        bank1: 'x',
        bank2: 'x'
      };
      
      updateGameDisplay();
      handlePhase('roll-dice');
    }

    function endTurn() {
      handleEndTurnPhase();
    }

    function endGame() {
      // Start the End Game Scoring wizard
      showEndGameStep1_TricksOnCards();
    }
    
    // Temp storage for end game wizard
    let endGameTempData = {
      trickCount: 0,
      trickFame: 0,
      trickCoins: 0,
      trickShards: 0
    };
    
    function showEndGameStep1_TricksOnCards() {
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0 20px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      // Standard prophecy reminder (p19, p20 mapped to 'end-game')
      const prophecyReminder = getProphecyReminderHtml('end-game');
      
      // Still need these flags for calculation logic
      const isExtraShard = gameState.activeProphecy?.id === 'p19';
      const isShardsGiveFame = gameState.activeProphecy?.id === 'p20';
      
      // Restore previous values if going back
      const prevCount = endGameTempData.trickCount || 0;
      const prevFame = endGameTempData.trickFame || 0;
      const prevCoins = endGameTempData.trickCoins || 0;
      const prevShards = endGameTempData.trickShards || 0;
      
      setActionContent(
        'End Game Scoring (Step 1 of 2)',
        `<p><strong>Tricks Remaining on Performance Cards</strong></p>
         
         ${prophecyReminder}
         
         ${infoBox("The Heir receives the Yield of Tricks still on Performance cards, but <strong>minus 1 Fame and 1 Coin per Trick</strong>. Enter the <strong>raw values</strong> from the cards ‚Äî the app will calculate the adjustment.")}
         
         <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin: 15px 0;">
           <p style="margin-bottom: 15px; color: var(--text-secondary);">Count the Heir's Trick markers remaining on Performance cards and sum their yields:</p>
           
           <div style="margin-bottom: 15px;">
             <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Number of Trick markers on Performance cards:</label>
             <input type="number" id="endgame-trick-count" value="${prevCount}" min="0" style="width: 100px; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
           </div>
           
           <p style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9rem;">Total yields from those tricks (raw values from cards):</p>
           
           <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
             <div>
               <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">‚òÖ Fame</label>
               <input type="number" id="endgame-trick-fame" value="${prevFame}" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
             </div>
             <div>
               <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">ü™ô Coins</label>
               <input type="number" id="endgame-trick-coins" value="${prevCoins}" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
             </div>
             <div>
               <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">üíé Shards</label>
               <input type="number" id="endgame-trick-shards" value="${prevShards}" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary);">
             </div>
           </div>
         </div>
         
         <p style="color: var(--text-muted); font-size: 0.85rem;">If no tricks remain on Performance cards, leave all values at 0.</p>`,
        [
          { text: 'Continue ‚Üí', action: () => {
            // Save inputs
            endGameTempData.trickCount = parseInt($('#endgame-trick-count')?.value) || 0;
            endGameTempData.trickFame = parseInt($('#endgame-trick-fame')?.value) || 0;
            endGameTempData.trickCoins = parseInt($('#endgame-trick-coins')?.value) || 0;
            endGameTempData.trickShards = parseInt($('#endgame-trick-shards')?.value) || 0;
            showEndGameStep2_FinalTotals();
          }}
        ]
      );
    }
    
    function showEndGameStep2_FinalTotals() {
      const boardAction = (text) => `<div style="background: var(--physical-action-bg); border-left: 3px solid var(--physical-action); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--physical-action); font-weight: 600;">‚öô BOARD:</span> <span style="color: var(--text-primary);">${text}</span></div>`;
      const noteBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è NOTE:</span> ${text}</div>`;
      
      // Get difficulty bonuses
      const l3Bonus = gameState.difficulty === 'easy' ? 5 : (gameState.difficulty === 'normal' ? 7 : 10);
      const charBonus = gameState.difficulty === 'easy' ? 0 : (gameState.difficulty === 'normal' ? 1 : 2);
      
      // Get tracked values
      const baseFame = gameState.heir.fame;
      const baseCoins = gameState.heir.coins;
      const baseShards = gameState.heir.shards;
      const saCards = Object.values(gameState.heir.specialAssignments).reduce((a, b) => a + b, 0);
      const characterCount = gameState.heir.characters.length;
      const l3TrickCount = gameState.heir.tricks.filter(t => t.level === 3).length;
      
      // Calculate tricks on cards adjustment
      const trickCount = endGameTempData.trickCount;
      const rawTrickFame = endGameTempData.trickFame;
      const rawTrickCoins = endGameTempData.trickCoins;
      const rawTrickShards = endGameTempData.trickShards;
      
      const adjustedTrickFame = Math.max(0, rawTrickFame - trickCount);
      const adjustedTrickCoins = Math.max(0, rawTrickCoins - trickCount);
      
      // Check for p19 (Extra Shard) and p20 (Shards Give Fame) applying to trick shards
      const isExtraShard = gameState.activeProphecy?.id === 'p19';
      const isShardsGiveFame = gameState.activeProphecy?.id === 'p20';
      const p19Bonus = (isExtraShard && rawTrickShards > 0) ? 1 : 0;
      const p20Bonus = (isShardsGiveFame && rawTrickShards > 0) ? 2 : 0;
      
      // Calculate bonus Fame categories (each capped at 20)
      const totalShards = baseShards + rawTrickShards + p19Bonus;
      const shardFame = Math.min(totalShards, 20);
      const saFame = Math.min(saCards * 2, 20);
      const l3Fame = Math.min(l3TrickCount * l3Bonus, 20);
      const extraChars = Math.max(0, characterCount - 6);
      const charFame = Math.min(extraChars * charBonus, 20);
      
      // Calculate final totals (include p20 bonus Fame)
      const finalFame = baseFame + adjustedTrickFame + shardFame + saFame + l3Fame + charFame + p20Bonus;
      const finalCoins = baseCoins + adjustedTrickCoins;
      const finalShards = totalShards;
      
      // Build Fame breakdown
      let fameBreakdown = `
        <div style="background: var(--bg-card); padding: 12px; border-radius: 6px;">
          <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">‚òÖ Fame Breakdown</h4>
          <table style="width: 100%; font-size: 0.9rem;">
            <tr><td>Base Fame (during game)</td><td style="text-align: right; font-weight: 600;">${baseFame}</td></tr>`;
      
      if (trickCount > 0) {
        fameBreakdown += `<tr><td>Tricks on cards (${rawTrickFame} - ${trickCount})</td><td style="text-align: right; font-weight: 600;">+${adjustedTrickFame}</td></tr>`;
      }
      
      fameBreakdown += `<tr><td>Shards (${totalShards} √ó 1, max 20)</td><td style="text-align: right; font-weight: 600;">+${shardFame}</td></tr>`;
      fameBreakdown += `<tr><td>SA Cards (${saCards} √ó 2, max 20)</td><td style="text-align: right; font-weight: 600;">+${saFame}</td></tr>`;
      
      if (l3TrickCount > 0) {
        fameBreakdown += `<tr><td>Level 3 Tricks (${l3TrickCount} √ó ${l3Bonus}, max 20)</td><td style="text-align: right; font-weight: 600;">+${l3Fame}</td></tr>`;
      }
      
      if (extraChars > 0 && charBonus > 0) {
        fameBreakdown += `<tr><td>Extra Characters (${extraChars} √ó ${charBonus}, max 20)</td><td style="text-align: right; font-weight: 600;">+${charFame}</td></tr>`;
      }
      
      if (p20Bonus > 0) {
        fameBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p20 Shards Give Fame</td><td style="text-align: right; font-weight: 600;">+${p20Bonus}</td></tr>`;
      }
      
      fameBreakdown += `
          </table>
        </div>`;
      
      // Build Coins breakdown (informational only)
      let coinsBreakdown = `
        <div style="background: var(--bg-card); padding: 12px; border-radius: 6px;">
          <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">ü™ô Coins</h4>
          <table style="width: 100%; font-size: 0.9rem;">
            <tr><td>Tracked Coins</td><td style="text-align: right; font-weight: 600;">${baseCoins}</td></tr>`;
      
      if (trickCount > 0) {
        coinsBreakdown += `<tr><td>Tricks on cards (${rawTrickCoins} - ${trickCount})</td><td style="text-align: right; font-weight: 600;">+${adjustedTrickCoins}</td></tr>`;
      }
      
      coinsBreakdown += `
          </table>
          <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px; font-style: italic;">Heir does not score Fame from leftover Coins</p>
        </div>`;
      
      // Build Shards breakdown
      let shardsBreakdown = `
        <div style="background: var(--bg-card); padding: 12px; border-radius: 6px;">
          <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">üíé Shards</h4>
          <table style="width: 100%; font-size: 0.9rem;">
            <tr><td>Tracked Shards</td><td style="text-align: right; font-weight: 600;">${baseShards}</td></tr>`;
      
      if (rawTrickShards > 0) {
        shardsBreakdown += `<tr><td>From tricks on cards</td><td style="text-align: right; font-weight: 600;">+${rawTrickShards}</td></tr>`;
      }
      
      if (p19Bonus > 0) {
        shardsBreakdown += `<tr style="color: var(--amber);"><td>‚ö†Ô∏è p19 Extra Shard</td><td style="text-align: right; font-weight: 600;">+${p19Bonus}</td></tr>`;
      }
      
      shardsBreakdown += `
          </table>
        </div>`;
      
      // Build conditional board actions
      const fameToAdd = finalFame - baseFame;
      const coinsToAdd = finalCoins - baseCoins;
      const shardsToAdd = finalShards - baseShards;
      
      let boardActions = '';
      if (fameToAdd > 0) {
        boardActions += boardAction(`Update the Heir's Fame tracker with <strong>+${fameToAdd} Fame</strong>. (${baseFame} ‚Üí ${finalFame})`);
      }
      if (coinsToAdd > 0) {
        boardActions += boardAction(`Update the Heir's Coins with <strong>+${coinsToAdd} Coins</strong>. (${baseCoins} ‚Üí ${finalCoins})`);
      }
      if (shardsToAdd > 0) {
        boardActions += boardAction(`Update the Heir's Shards with <strong>+${shardsToAdd} Shards</strong>. (${baseShards} ‚Üí ${finalShards})`);
      }
      
      setActionContent(
        'End Game Scoring (Step 2 of 2)',
        `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0;">
           ${fameBreakdown}
           ${coinsBreakdown}
           ${shardsBreakdown}
         </div>
         
         <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 15px 0; padding: 15px; background: rgba(212, 168, 71, 0.15); border: 2px solid var(--amber); border-radius: 8px;">
           <div style="text-align: center;">
             <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">TOTAL FAME</div>
             <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${finalFame} ‚òÖ</div>
           </div>
           <div style="text-align: center;">
             <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">TOTAL COINS</div>
             <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${finalCoins} ü™ô</div>
           </div>
           <div style="text-align: center;">
             <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">TOTAL SHARDS</div>
             <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${finalShards} üíé</div>
           </div>
         </div>
         
         ${boardActions}
         
         ${noteBox("The Heir's final Fame score is <strong>" + finalFame + " ‚òÖ</strong>")}`,
        [
          { text: '‚Üê Back', action: () => showEndGameStep1_TricksOnCards() },
          { text: 'Continue to Player Scoring ‚Üí', action: () => {
            // Update gameState with final values
            gameState.heir.fame = finalFame;
            gameState.heir.coins = finalCoins;
            gameState.heir.shards = finalShards;
            updateGameDisplay();
            showEndGameStep3_PlayerGuide(finalFame);
          }}
        ]
      );
    }
    
    function showEndGameStep3_PlayerGuide(heirFinalFame) {
      const infoBox = (text) => `<div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 8px 12px; margin: 8px 0; border-radius: 0 4px 4px 0;"><span style="color: var(--info); font-weight: 600;">‚ÑπÔ∏è INFO:</span> ${text}</div>`;
      
      setActionContent(
        'End Game ‚Äî Your Score',
        `<div style="background: rgba(212, 168, 71, 0.2); border: 3px solid var(--amber); padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
           <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">THE HEIR'S FINAL SCORE</div>
           <div style="font-size: 2.5rem; font-weight: 700; color: var(--amber);">${heirFinalFame} ‚òÖ</div>
         </div>
         
         <p style="margin-bottom: 15px;"><strong>Calculate Your Final Score:</strong></p>
         
         <div style="background: var(--info-bg); border-left: 3px solid var(--info); padding: 12px 15px; margin: 8px 0 15px 0; border-radius: 0 4px 4px 0;">
           <p style="margin-bottom: 10px; color: var(--text-primary);">Add these bonuses to your Fame tracker:</p>
           <ul style="margin: 0 0 0 20px; color: var(--text-primary);">
             <li style="margin-bottom: 6px;"><strong>Shards:</strong> 1 Fame per Shard (max 20 Fame)</li>
             <li style="margin-bottom: 6px;"><strong>Coins:</strong> 1 Fame per 3 leftover Coins (max 20 Fame)</li>
             <li style="margin-bottom: 6px;"><strong>SA Cards:</strong> 2 Fame per Special Assignment card in hand (max 20 Fame)</li>
             <li style="margin-bottom: 0;"><strong>Level 3 Tricks:</strong> Check conditions on your Level 3 Tricks ‚Äî if met, score the bonus shown (max 20 Fame each)</li>
           </ul>
         </div>
         
         <details style="margin-bottom: 15px;">
           <summary style="cursor: pointer; color: var(--text-secondary); font-weight: 600;">Level 3 Trick End Game Bonuses Reference</summary>
           <div style="background: var(--bg-card); padding: 15px; border-radius: 6px; margin-top: 10px; font-size: 0.85rem;">
             <p style="color: var(--text-muted); margin-bottom: 10px;">Each Level 3 Trick has a condition. If met (and you have the required components), score the bonus:</p>
             <ul style="margin: 0 0 0 15px; color: var(--text-secondary);">
               <li><strong>Aztec Lady:</strong> 2 points per trick marker</li>
               <li><strong>Horror Saws:</strong> 1 point per shard</li>
               <li><strong>Automaton:</strong> 4 points per Level 2 trick</li>
               <li><strong>Hellhound:</strong> 2 points per trick</li>
               <li><strong>Balsamo's Skull:</strong> 3 points per Superior component</li>
               <li><strong>S√©ance:</strong> 3 points per Apprentice</li>
               <li><strong>Skeleton Dance:</strong> 1 point per Basic component</li>
               <li><strong>Metamorphosis:</strong> 1 point per 3 coins</li>
               <li><strong>Buried Alive:</strong> 7 points if you have Engineer</li>
               <li><strong>Assistant's Revenge:</strong> 7 points if you have Assistant</li>
               <li><strong>Iron Maiden:</strong> 7 points if you have Manager</li>
               <li><strong>Mutilation:</strong> 12 points if you have all 3 Specialists</li>
               <li><strong>Enchanted Mirror:</strong> 1 point per trick marker</li>
               <li><strong>Grand Finale:</strong> 1 point per Fame on tracker</li>
               <li><strong>Dancing Handkerchief:</strong> 3 points per Apprentice</li>
               <li><strong>Sphinx Riddle:</strong> 6 points per Level 3 trick</li>
             </ul>
           </div>
         </details>
         
         ${infoBox("<strong>Tiebreaker:</strong> If you and the Heir have the same Fame, the player ahead in Initiative Order wins.")}
         
         <p style="text-align: center; margin-top: 20px; color: var(--text-secondary);">Compare your final Fame to the Heir's <strong>${heirFinalFame} ‚òÖ</strong></p>`,
        [
          { text: 'Finish', action: () => location.reload() }
        ]
      );
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      // Expansion selection (base always on, others toggle on/off)
      $$('#expansion-options .option-card').forEach(card => {
        card.addEventListener('click', () => {
          const expansion = card.dataset.expansion;
          // Base is always selected, can't toggle
          if (expansion === 'base') return;
          // Disabled cards (Coming Soon) can't be clicked
          if (card.classList.contains('disabled')) return;
          
          // Toggle selection
          card.classList.toggle('selected');
          gameState.expansions[expansion] = card.classList.contains('selected');
          
          // Show/hide Dawn of Technology options
          const dawnOptions = $('#dawn-options');
          if (dawnOptions) {
            if (gameState.expansions.dawn) {
              dawnOptions.classList.remove('hidden');
            } else {
              dawnOptions.classList.add('hidden');
              // Reset challenge rule when DoT is deselected
              const checkbox = $('#dawn-challenge-rule');
              if (checkbox) checkbox.checked = false;
              gameState.expansions.dawnChallengeRule = false;
            }
          }
          
          // Show setup instructions after expansion is selected
          const setupSection = $('#board-setup-section');
          if (setupSection) setupSection.style.display = 'block';
        });
      });
      
      // Dawn of Technology challenge rule checkbox
      const dawnChallengeCheckbox = $('#dawn-challenge-rule');
      if (dawnChallengeCheckbox) {
        dawnChallengeCheckbox.addEventListener('change', (e) => {
          gameState.expansions.dawnChallengeRule = e.target.checked;
        });
      }
      
      // Show setup section on load if expansion is pre-selected (base game)
      const preselectedExpansion = $('#expansion-options .option-card.selected');
      if (preselectedExpansion) {
        const setupSection = $('#board-setup-section');
        if (setupSection) setupSection.style.display = 'block';
      }

      // Difficulty selection
      $$('#difficulty-options .option-card').forEach(card => {
        card.addEventListener('click', () => selectDifficulty(card.dataset.difficulty));
      });

      // Player school selection
      $$('#player-school-options .option-card').forEach(card => {
        card.addEventListener('click', () => selectPlayerSchool(card.dataset.school));
      });

      // Heir school selection (page 6)
      $$('#heir-school-options .option-card').forEach(card => {
        card.addEventListener('click', () => selectHeirSchool(card.dataset.school));
      });

      // Randomize buttons
      const heirRandomBtn = $('#randomize-heir-btn');
      if (heirRandomBtn) heirRandomBtn.addEventListener('click', randomizeHeirSchool);
      const trickRandomBtn = $('#randomize-trick-btn');
      if (trickRandomBtn) trickRandomBtn.addEventListener('click', randomizeStartingTrick);

      // Start game button
      $('#start-game-btn').addEventListener('click', initializeGame);
      
      // Quick Setup event listeners
      $$('#quick-player-school-options .option-card').forEach(card => {
        card.addEventListener('click', () => quickSelectPlayerSchool(card.dataset.school));
      });
      
      $$('#quick-heir-school-options .option-card').forEach(card => {
        card.addEventListener('click', () => quickSelectHeirSchool(card.dataset.school));
      });
      
      $$('#quick-difficulty-options .option-card').forEach(card => {
        card.addEventListener('click', () => quickSelectDifficulty(card.dataset.difficulty));
      });
      
      const quickHeirRandomBtn = $('#quick-randomize-heir-btn');
      if (quickHeirRandomBtn) quickHeirRandomBtn.addEventListener('click', quickRandomizeHeir);
      
      const quickTrickRandomBtn = $('#quick-randomize-trick-btn');
      if (quickTrickRandomBtn) quickTrickRandomBtn.addEventListener('click', quickRandomizeTrick);
      
      const quickStartBtn = $('#quick-start-game-btn');
      if (quickStartBtn) quickStartBtn.addEventListener('click', initializeGame);

      // Restart button
      $('#restart-btn').addEventListener('click', restartGame);
      
      // Manage player tricks button
      $('#manage-player-tricks-btn').addEventListener('click', showManagePlayerTricks);

      // Initial state
      populatePlayerMagicianOptions();
      populateStartingTrickOptions();
      updateRandomizeButtons();
    });

    function restartGame() {
      try {
        // Reset game state
        gameState.expansions = {
          academy: false,
          dawn: false,
          arcane: false,
          dawnChallengeRule: false
        };
        gameState.difficulty = null;
        gameState.playerSchool = null;
        gameState.playerMagician = null;
        gameState.heirSchool = null;
        gameState.heirMagician = null;
        gameState.startingSpecialists = [];
        gameState.currentTurn = 1;
        gameState.currentPhaseIndex = 0;
        gameState.heir = {
          fame: 5,
          coins: 0,
          shards: 0,
          stance: null,
          characters: [],
          tricks: [],
          shoppingList: [],
          specialAssignments: { theater: 0, downtown: 0, market: 0, workshop: 0 },
          pendingCharacters: [],
          magicianAtTheaterThisTurn: false,
          nonMagiciansAtTheaterThisTurn: 0
        };
        gameState.player = {
          tricks: []
        };
        gameState.downtownDice = {
          trick1: 'x',
          trick2: 'x',
          apprentice: 'x',
          specialist: 'x',
          bank1: 'x',
          bank2: 'x'
        };
        gameState.planDeck = [];
        gameState.currentPlanCard = null;

        // Reset Full Setup UI selections
        $$('#expansion-options .option-card').forEach(c => c.classList.remove('selected'));
        const baseExpansion = $('#expansion-options .option-card[data-expansion="base"]');
        if (baseExpansion) baseExpansion.classList.add('selected');
        
        // Reset Dawn of Technology options
        const dawnOptions = $('#dawn-options');
        if (dawnOptions) dawnOptions.classList.add('hidden');
        const dawnCheckbox = $('#dawn-challenge-rule');
        if (dawnCheckbox) dawnCheckbox.checked = false;
        
        $$('#difficulty-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#player-school-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#player-magician-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#heir-school-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#heir-magician-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#starting-trick-options .option-card').forEach(c => c.classList.remove('selected'));
        
        // Reset Quick Setup UI selections
        $$('#quick-player-school-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#quick-player-magician-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#quick-heir-school-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#quick-heir-magician-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#quick-difficulty-options .option-card').forEach(c => c.classList.remove('selected'));
        $$('#quick-starting-trick-options .option-card').forEach(c => c.classList.remove('selected'));
        
        // Hide dynamic sections (Full Setup)
        const heirMagSection = $('#heir-magician-section');
        if (heirMagSection) heirMagSection.style.display = 'none';
        const playerMagSection = $('#player-magician-section');
        if (playerMagSection) playerMagSection.style.display = 'none';
        
        // Hide dynamic sections (Quick Setup)
        const quickPlayerMagSection = $('#quick-player-magician-section');
        if (quickPlayerMagSection) quickPlayerMagSection.style.display = 'none';
        const quickHeirMagSection = $('#quick-heir-magician-section');
        if (quickHeirMagSection) quickHeirMagSection.style.display = 'none';
        const quickTrickSection = $('#quick-trick-section');
        if (quickTrickSection) quickTrickSection.style.display = 'none';
        const quickSummary = $('#quick-setup-summary');
        if (quickSummary) quickSummary.style.display = 'none';
        
        // Reset continue buttons
        const continueButtons = ['#page4-continue', '#page6-continue', '#page8-continue', '#page10-continue', '#quick-start-game-btn'];
        continueButtons.forEach(btn => {
          const el = $(btn);
          if (el) el.disabled = true;
        });
        
        // Reset quick randomize trick button
        const quickTrickBtn = $('#quick-randomize-trick-btn');
        if (quickTrickBtn) quickTrickBtn.disabled = true;

        // Reset setup UI
        populatePlayerMagicianOptions();
        populateStartingTrickOptions();
        updateRandomizeButtons();
        updateSetupButton();

        // Hide restart button, show setup screen at page 0 (mode selection)
        $('#restart-btn').classList.add('hidden');
        showScreen('setup-screen');
        showSetupPage(0);
      } catch (e) {
        console.error('Error in restartGame:', e);
        // Fallback: just reload the page
        location.reload();
      }
    }

    // ============================================
    // DEBUG FUNCTIONS (for testing)
    // Call from browser console: debug.endGame('p19')
    // ============================================
    
    window.debug = {
      // Jump to End Game with optional prophecy
      // Usage: debug.endGame('p19') or debug.endGame('p20') or debug.endGame()
      endGame: function(prophecyId) {
        // Set up minimal game state
        gameState.currentTurn = 7;
        gameState.difficulty = gameState.difficulty || 'normal';
        gameState.heirMagician = gameState.heirMagician || { id: 'mechaniker', name: 'The Mechaniker', school: 'mechanical' };
        gameState.heir = gameState.heir || {};
        gameState.heir.fame = gameState.heir.fame || 50;
        gameState.heir.coins = gameState.heir.coins || 5;
        gameState.heir.shards = gameState.heir.shards || 3;
        gameState.heir.characters = gameState.heir.characters || ['magician', 'engineer', 'apprentice', 'apprentice'];
        gameState.heir.tricks = gameState.heir.tricks || [
          { id: 'test1', name: 'Test Trick 1', level: 1, fame: 2, coins: 3, shards: 0 },
          { id: 'test2', name: 'Test Trick 2', level: 2, fame: 4, coins: 5, shards: 1 }
        ];
        gameState.heir.specialAssignments = gameState.heir.specialAssignments || { theater: 1, downtown: 2, market: 0, darkAlley: 1, workshop: 0 };
        
        // Set prophecy if provided
        if (prophecyId) {
          const allProphecies = [...PROPHECIES.heirIgnores, ...PROPHECIES.affectBoth];
          const prophecy = allProphecies.find(p => p.id === prophecyId);
          if (prophecy) {
            gameState.activeProphecy = prophecy;
            console.log(`‚úÖ Set active prophecy: ${prophecy.id} (${prophecy.name})`);
          } else {
            console.warn(`‚ö†Ô∏è Prophecy '${prophecyId}' not found`);
          }
        }
        
        // Show game screen and jump to End Game
        showScreen('game-screen');
        updateGameDisplay();
        showEndGameStep1_TricksOnCards();
        console.log('üéÆ Jumped to End Game scoring');
        console.log('Current state:', { fame: gameState.heir.fame, coins: gameState.heir.coins, shards: gameState.heir.shards, prophecy: gameState.activeProphecy?.id });
      },
      
      // Set prophecy mid-game
      // Usage: debug.setProphecy('p19')
      setProphecy: function(prophecyId) {
        const allProphecies = [...PROPHECIES.heirIgnores, ...PROPHECIES.affectBoth];
        const prophecy = allProphecies.find(p => p.id === prophecyId);
        if (prophecy) {
          gameState.activeProphecy = prophecy;
          updateGameDisplay();
          console.log(`‚úÖ Set prophecy: ${prophecy.id} (${prophecy.name})`);
        } else {
          console.warn(`‚ö†Ô∏è Prophecy '${prophecyId}' not found. Available: ${allProphecies.map(p => p.id).join(', ')}`);
        }
      },
      
      // Show current game state
      // Usage: debug.state()
      state: function() {
        console.log('üìä Current Game State:');
        console.log('  Turn:', gameState.currentTurn);
        console.log('  Difficulty:', gameState.difficulty);
        console.log('  Magician:', gameState.heirMagician?.name);
        console.log('  Prophecy:', gameState.activeProphecy?.id, gameState.activeProphecy?.name);
        console.log('  Heir:', { fame: gameState.heir?.fame, coins: gameState.heir?.coins, shards: gameState.heir?.shards });
        return gameState;
      },
      
      // Quick test for p19 at End Game
      testP19: function() {
        this.endGame('p19');
        console.log('\nüìù TEST INSTRUCTIONS:');
        console.log('1. Enter some shards in "Tricks on Performance Cards" (e.g., 2)');
        console.log('2. Click Continue');
        console.log('3. Verify: Shards breakdown shows "+1" for p19 Extra Shard');
      },
      
      // Quick test for p20 at End Game
      testP20: function() {
        this.endGame('p20');
        console.log('\nüìù TEST INSTRUCTIONS:');
        console.log('1. Enter some shards in "Tricks on Performance Cards" (e.g., 2)');
        console.log('2. Click Continue');
        console.log('3. Verify: Fame breakdown shows "+2" for p20 Shards Give Fame');
      },
      
      // Jump to End Turn (Removed Card Yields) screen
      // Usage: debug.endTurn('p16') or debug.endTurn('p19')
      endTurn: function(prophecyId) {
        // Set up minimal game state for Turn 3+
        gameState.currentTurn = 4;
        gameState.difficulty = gameState.difficulty || 'normal';
        gameState.heirMagician = gameState.heirMagician || { id: 'mechaniker', name: 'The Mechaniker', school: 'mechanical' };
        gameState.heir = gameState.heir || {};
        gameState.heir.fame = gameState.heir.fame || 30;
        gameState.heir.coins = gameState.heir.coins || 5;
        gameState.heir.shards = gameState.heir.shards || 2;
        gameState.heir.characters = gameState.heir.characters || ['magician', 'engineer', 'apprentice'];
        gameState.heir.tricks = gameState.heir.tricks || [];
        gameState.heir.specialAssignments = gameState.heir.specialAssignments || { theater: 0, downtown: 0, market: 0, darkAlley: 0, workshop: 0 };
        
        // Set prophecy if provided
        if (prophecyId) {
          const allProphecies = [...PROPHECIES.heirIgnores, ...PROPHECIES.affectBoth];
          const prophecy = allProphecies.find(p => p.id === prophecyId);
          if (prophecy) {
            gameState.activeProphecy = prophecy;
            console.log(`‚úÖ Set active prophecy: ${prophecy.id} (${prophecy.name})`);
          }
        }
        
        showScreen('game-screen');
        updateGameDisplay();
        showEndTurnPartOne();
        console.log('üéÆ Jumped to End Turn (Removed Card Yields)');
      },
      
      // Test that p16 does NOT appear at End Turn
      testP16EndTurn: function() {
        this.endTurn('p16');
        console.log('\nüìù TEST INSTRUCTIONS:');
        console.log('1. Verify: p16 (Coins As Fame) is NOT shown on this screen');
        console.log('2. It should only show during Performance phase, not End Turn');
      },
      
      // Test that p19 DOES appear at End Turn
      testP19EndTurn: function() {
        this.endTurn('p19');
        console.log('\nüìù TEST INSTRUCTIONS:');
        console.log('1. Verify: p19 (Extra Shard) IS shown on this screen');
        console.log('2. Enter some shards and verify the bonus applies');
      },
      
      // Jump to Heir Performance wizard
      // Usage: debug.heirPerformance()
      heirPerformance: function() {
        // Set up minimal game state
        gameState.currentTurn = 3;
        gameState.difficulty = gameState.difficulty || 'normal';
        gameState.heirMagician = gameState.heirMagician || { id: 'mechaniker', name: 'The Mechaniker', school: 'mechanical' };
        gameState.heir = gameState.heir || {};
        gameState.heir.fame = gameState.heir.fame || 30;
        gameState.heir.coins = gameState.heir.coins || 5;
        gameState.heir.shards = gameState.heir.shards || 2;
        gameState.heir.characters = gameState.heir.characters || ['magician', 'engineer', 'apprentice'];
        gameState.heir.tricks = gameState.heir.tricks || [];
        gameState.heir.specialAssignments = gameState.heir.specialAssignments || { theater: 0, downtown: 0, market: 0, darkAlley: 0, workshop: 0 };
        gameState.heir.nonMagiciansAtTheaterThisTurn = 1;
        
        // Set up performance results with card 1 winning
        const testResults = [
          { card: 1, links: 2 },
          { card: 2, links: 1 }
        ];
        
        showScreen('game-screen');
        updateGameDisplay();
        showHeirPerformanceStep1_TrickYields(1, testResults);
        console.log('üéÆ Jumped to Heir Performance wizard');
        console.log('üìù TEST: Go through all 3 steps and verify Step 3 shows player yield reminder');
      },
      
      // Jump to Player Performance screen with a prophecy
      // Usage: debug.playerPerformance('p16')
      playerPerformance: function(prophecyId) {
        // Set up minimal game state
        gameState.currentTurn = 3;
        gameState.difficulty = gameState.difficulty || 'normal';
        gameState.heirMagician = gameState.heirMagician || { id: 'mechaniker', name: 'The Mechaniker', school: 'mechanical' };
        gameState.heir = gameState.heir || {};
        gameState.heir.fame = gameState.heir.fame || 30;
        gameState.heir.coins = gameState.heir.coins || 5;
        gameState.heir.shards = gameState.heir.shards || 2;
        gameState.heir.characters = gameState.heir.characters || ['magician', 'engineer', 'apprentice'];
        gameState.heir.tricks = gameState.heir.tricks || [];
        gameState.heir.specialAssignments = gameState.heir.specialAssignments || { theater: 0, downtown: 0, market: 0, darkAlley: 0, workshop: 0 };
        gameState.performanceOrder = 'player-first';
        
        // Set prophecy if provided
        if (prophecyId) {
          const allProphecies = [...PROPHECIES.heirIgnores, ...PROPHECIES.affectBoth];
          const prophecy = allProphecies.find(p => p.id === prophecyId);
          if (prophecy) {
            gameState.activeProphecy = prophecy;
            console.log(`‚úÖ Set active prophecy: ${prophecy.id} (${prophecy.name})`);
          }
        }
        
        showScreen('game-screen');
        updateGameDisplay();
        showPlayerPerformanceScreen();
        console.log('üéÆ Jumped to Player Performance screen');
      },
      
      // Test p16 at Player Performance
      testP16PlayerPerf: function() {
        this.playerPerformance('p16');
        console.log('\nüìù TEST INSTRUCTIONS:');
        console.log('1. Verify: p16 reminder shown (Coins As Fame)');
        console.log('2. Enter some coins (e.g., 5) for Heir yields');
        console.log('3. Click Continue - verify coins converted to fame in sidebar');
      },
      
      // Jump to Theater Complete screen with a prophecy
      // Usage: debug.theaterComplete('p19')
      theaterComplete: function(prophecyId) {
        // Set up minimal game state
        gameState.currentTurn = 3;
        gameState.difficulty = gameState.difficulty || 'normal';
        gameState.heirMagician = gameState.heirMagician || { id: 'mechaniker', name: 'The Mechaniker', school: 'mechanical' };
        gameState.heir = gameState.heir || {};
        gameState.heir.fame = gameState.heir.fame || 30;
        gameState.heir.coins = gameState.heir.coins || 5;
        gameState.heir.shards = gameState.heir.shards || 2;
        gameState.heir.characters = gameState.heir.characters || ['magician', 'engineer', 'apprentice'];
        gameState.heir.tricks = gameState.heir.tricks || [];
        gameState.heir.specialAssignments = gameState.heir.specialAssignments || { theater: 0, downtown: 0, market: 0, darkAlley: 0, workshop: 0 };
        
        // Set prophecy if provided
        if (prophecyId) {
          const allProphecies = [...PROPHECIES.heirIgnores, ...PROPHECIES.affectBoth];
          const prophecy = allProphecies.find(p => p.id === prophecyId);
          if (prophecy) {
            gameState.activeProphecy = prophecy;
            console.log(`‚úÖ Set active prophecy: ${prophecy.id} (${prophecy.name})`);
          }
        }
        
        showScreen('game-screen');
        updateGameDisplay();
        showTheaterPlacementComplete(2, 2, 2); // 2 AP, 2 markers total, 2 placed
        console.log('üéÆ Jumped to Theater Complete screen');
      },
      
      // Test p19 at Theater Complete (matches the screenshot from feedback)
      testP19Theater: function() {
        this.theaterComplete('p19');
        console.log('\nüìù TEST: Verify p19 shows standard design (icon, badge, description)');
      },
      
      // Test p07 at Theater Complete (school prophecy)
      testP07Theater: function() {
        this.theaterComplete('p07');
        console.log('\nüìù TEST: Verify p07 shows standard design + school trick input');
      },
      
      // Jump to Downtown Final Instructions to test Take Coins board action
      // Usage: debug.downtownCoins()
      downtownCoins: function() {
        // Set up minimal game state
        gameState.currentTurn = 3;
        gameState.difficulty = gameState.difficulty || 'normal';
        gameState.heirMagician = gameState.heirMagician || { id: 'mechaniker', name: 'The Mechaniker', school: 'mechanical' };
        gameState.heir = gameState.heir || {};
        gameState.heir.fame = gameState.heir.fame || 30;
        gameState.heir.coins = gameState.heir.coins || 5;
        gameState.heir.shards = gameState.heir.shards || 2;
        gameState.heir.characters = gameState.heir.characters || ['magician', 'engineer', 'apprentice'];
        gameState.heir.tricks = gameState.heir.tricks || [];
        gameState.heir.specialAssignments = gameState.heir.specialAssignments || { theater: 0, downtown: 0, market: 0, darkAlley: 0, workshop: 0 };
        
        // Set up Downtown pending state with dice showing coins
        gameState.pendingDowntown = {
          actionPoints: 3,
          diceState: {
            trick1: 'mechanical',
            trick2: 'x',
            apprentice: 'x',
            specialist: 'x',
            bank1: '4',  // 4 coins
            bank2: '2'   // 2 coins
          }
        };
        
        showScreen('game-screen');
        updateGameDisplay();
        showDowntownFinalInstructions('skipped');
        console.log('üéÆ Jumped to Downtown Final Instructions');
        console.log('üìù TEST: Verify "Add X Coins to Heir\'s Coin Purse" shows as board action');
      },
      
      // Jump to Turn 7 End Turn to test streamlined final turn flow
      // Usage: debug.turn7EndTurn()
      turn7EndTurn: function() {
        // Set up game state for Turn 7
        gameState.currentTurn = 7;
        gameState.currentPhaseIndex = 5; // End Turn phase
        gameState.difficulty = gameState.difficulty || 'normal';
        gameState.heirMagician = gameState.heirMagician || { id: 'mechaniker', name: 'The Mechaniker', school: 'mechanical' };
        gameState.playerMagician = gameState.playerMagician || { id: 'dahlgaard', name: 'Dahlgaard', school: 'spiritual' };
        gameState.heir = gameState.heir || {};
        gameState.heir.fame = gameState.heir.fame || 45;
        gameState.heir.coins = 12; // Enough for coin conversion
        gameState.heir.shards = gameState.heir.shards || 3;
        gameState.heir.characters = gameState.heir.characters || ['magician', 'engineer', 'assistant', 'apprentice'];
        gameState.heir.tricks = gameState.heir.tricks || [{ id: 'test', name: 'Test Trick', school: 'mechanical' }];
        gameState.heir.specialAssignments = { theater: 1, downtown: 0, market: 1, darkAlley: 0, workshop: 0 };
        gameState.heir.pendingCharacters = [];
        gameState.heir.stance = 'busy';
        gameState.player = gameState.player || { tricks: [] };
        
        // Set active prophecy for testing
        gameState.activeProphecy = { id: 'p19', name: 'Shards As Links', description: '+1 extra shard', icon: 'p19.png' };
        
        showScreen('game-screen');
        updateGameDisplay();
        showEndTurnFinalTurn();
        console.log('üéÆ Jumped to Turn 7 End Turn');
        console.log('üìù TEST: Verify streamlined flow (no next-turn setup steps)');
      }
    };
    
    console.log('üé© Debug functions available: debug.endGame(), debug.testP19(), debug.testP20(), debug.setProphecy(), debug.state()');
    
    // Secret key combo to toggle debug panel: Ctrl+Shift+D
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        const debugPanel = document.getElementById('debug-panel');
        if (debugPanel) {
          const isHidden = debugPanel.style.display === 'none';
          debugPanel.style.display = isHidden ? 'block' : 'none';
          console.log(isHidden ? 'üß™ Debug panel shown' : 'üß™ Debug panel hidden');
        }
      }
    });
  </script>
</body>
</html>
